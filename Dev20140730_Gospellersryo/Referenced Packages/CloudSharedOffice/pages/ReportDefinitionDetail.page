<apex:page id="page" showHeader="true" sidebar="false" standardStylesheets="true" tabStyle="SOLXYZCSO001__ReportDefinition__c"
standardController="SOLXYZCSO001__ReportDefinition__c" extensions="SOLXYZCSO001.ReportDefinitionEditController" action="{!init}">
<html>
<!-- 認証フレーム -->
<iframe src="{!$Label.field_CSO_URL}/common/AuthenticationApi?id={!URLENCODE($User.UserName)}&tk={!ecmToken}&isEvidence=false" height="0" width="0" id="auth_frame" style="display:none;"/>

<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<title>Cloud Shared Office / WebReport</title>

<link type="text/css" rel="stylesheet" href="{!URLFOR($Resource.FormFormat,'css/redmond/jquery-ui-1.8.9.custom.css')}"/>
<link type="text/css" rel="stylesheet" href="{!URLFOR($Resource.FormFormat,'css/ui.jqgrid.css')}"/>
<!--
<link type="text/css" rel="stylesheet" href="{!URLFOR($Resource.FormFormat,'css/jquery.treeview.css')}"/>
 -->
<link type="text/css" rel="stylesheet" href="{!URLFOR($Resource.treeview,'jquery.treeview.css')}"/>
<!--
<link type="text/css" rel="stylesheet" href="{!URLFOR($Resource.FormFormat,'css/_kansas.css')}"/>
 -->
<style type="text/css">
/*
#MainDiv * {
    font: normal 11.5px "MS UIGothic","Osaka",Arial,sans-serif;
}
*/
#CsoScriptLoadingArea{
    font-size: 11.5px;
}
.pbBody *{
    font-size: 11.5px;
    font-family: 'MS UI Gothic','MS PGothic','Hiragino Kaku Gothic Pro','Osaka','Arial','Helvetica',sans-serif;
}
body {
    background-color: white;
    margin: 0px;
    padding: 0px;
    overflow-y:scroll;
}

fieldset {
    border-radius: 10px;
    -webkit-border-radius: 10px;
    -moz-border-radius: 10px;
    border: solid 1px silver;
    padding: 5px;
}
/*
.btn {
    background-image: url("{!URLFOR($Resource.FormFormat,'img/btn.png')}");
    font-weight: bold;
    font-size: 12px;
    color: #223344;
    height: 24px;
    padding: 0px 10px 0px 10px;
    border: solid 1px silver;
    border-radius: 3px;
    -webkit-border-radius: 3px;
    -moz-border-radius: 3px;
}

.top_btn {
     width: 30px;
     height: 35px;
     margin-bottom: -5px;
     margin-right: 5px;
}

.topbar_btn{
    width: 45px;
     height: 40px;
     margin:-6px -13px -6px -14px;
}

@media screen and (-webkit-min-device-pixel-ratio:0){
    .topbar_btn{
        width: 42px;
         height: 41px;
         margin:-4px -7px -6px -8px;
    }
}
*/
.required {
    background-color: #FFCCFF;
    border: solid 1px silver;
}

.error {
    border-color: red !important;
}

.veryShortWidth {
    width: 50px;
}

.shortWidth {
    width: 100px;
}

.middleWidth {
    width: 150px;
}

.longWidth {
    width: 240px;
}

.veryLongWidth {
    width: 350px;
}

.extraLongWidth {
    width: 500px;
}

.err {
    background-color: #FFFF00 !important;
}

.err li {
    font-weight: bold !important;
    color: #FF0000 !important;
}

.solid_div {
    border: solid 1px silver;
    padding: 10px;
    background-color: white;
}

.innerHtmlHeader{
    /*border-bottom: 1px solid silver;*/
    height: 40px;
    padding: 5px;
}

.delivInnerHtmlTbl{
    width: 100%;
}

.leftMenu {
    /*background-image: url("{!URLFOR($Resource.FormFormat,'img/left_menu.gif')}");*/
    background-repeat: repeat-x;
    background-position: left center;
    padding: 0px 10px 0px 15px;
    color: #FFFFFF;
    font-weight: bold;
    height: 30px;
    width: 100%;
}

.action img{
    border: none;
    width: 18px;
    height: 18px;
}

.action_nosize{
    width: 18px;
    height: 18px;
}

.separatorDiv{
    /*background-image: url("{!URLFOR($Resource.FormFormat,'img/left_menu.gif')}");*/
    background-color:#53A0EC;
    width: 100%;
    height:20px;
}

.separatorDiv div{
    color: white;
    padding: 3px 0px 3px 5px;
    font-weight: bold;
}

.separatorDiv span{
    color: white;
    padding: 0px 0px 0px 5px;
    font-weight: bold;
}

.off_btn{
    filter:progid:DXImageTransform.Microsoft.BasicImage(grayscale=1);
    Alpha(opacity=10);-moz-opacity:.1;opacity:0.1;
}
.copylight{
    text-align: center;
}
.copyright{
    text-align: center;
}
#MainDiv {
    /*height: 650px;*/
    /*height: 350px;*/
    /*height: 100%;*/
    height: 850px;
    border-left: none;
    border-right: none;
    width: 100%;
    border-bottom: 1px solid silver;
}
.capusTitle{
    font-size: 16px;
    font-weight: bold;
    color: #FF6600;
}

.LabelBGColor{
    background-color:#53A0EC;
}

.subLabelHeight{
    height:20px;
    vertical-align:middle;
}

.reportListTree{
    font-weight: bold;
    vertical-align:top;
    border-right:solid 1px #999;
    overflow:auto;
    overflow-x:auto;
    overflow-y:auto;
    }

.treeSidebarWidth{
    width:250px;
    max-width:250px;
    min-width:250px;
}

#categoryMenu{
    padding:0px 10px;
}

.ActionBtnArea img {
    height: 18px;
    margin-bottom: -5px;
    margin-left: -7px;
    margin-right: 3px;
    width: 18px;
}


.ActionBtnArea{
    float: right;
    margin: 12px 3px 5px 5px;
}
/*
.btn_monsedown {
    background-image: url("{!URLFOR($Resource.FormFormat,'img/btn.click.png')}");
}

.btn_monseout {
    background-image: url("{!URLFOR($Resource.FormFormat,'img/btn.png')}");
}

.btn_mouseup {
    background-image: url("{!URLFOR($Resource.FormFormat,'img/btn.png')}");
}
*/
.commentTextAreaSize {
    width:320px;
    height:100px;
}

</style>

<link type="text/css" rel="stylesheet" href="{!URLFOR($Resource.FormFormat,'css/fg.menu.css')}"/>
<link rel="stylesheet" type="text/css" href="{!URLFOR($Resource.FormFormat,'css/oneClickMenu.css')}"/>

<apex:include pageName="SOLXYZCSO001__WRCSOBridge" />

<!--1.5だとhdr2が動かない
<script type="text/javascript" src="{!URLFOR($Resource.FormFormat,'js/jquery-1.5.min.js')}"></script>
-->

<script type="text/javascript" src="{!URLFOR($Resource.FormFormat,'js/jquery.history.js')}"></script>
<script type="text/javascript" src="{!URLFOR($Resource.FormFormat,'js/jquery.cookie.js')}"></script>
<!-- <script type="text/javascript" src="../js/splitter-152.js"></script>  -->
<script type="text/javascript" src="{!URLFOR($Resource.FormFormat,'js/jquery-ui-1.8.9.custom.min.js')}"></script>
<script type="text/javascript" src="{!URLFOR($Resource.FormFormat,'js/grid.locale-ja.js')}"></script>
<script type="text/javascript" src="{!URLFOR($Resource.FormFormat,'js/jquery.jqGrid.min.js')}"></script>
<script type="text/javascript" src="{!URLFOR($Resource.FormFormat,'js/jquery.contextmenu.js')}"></script>
<!-- <script type="text/javascript" src="../js/jquery.contextmenu.js"></script>  -->
<!--
<script type="text/javascript" src="{!URLFOR($Resource.FormFormat,'js/kansas.js')}"></script>
 -->
<!--
<script type="text/javascript" src="{!URLFOR($Resource.FormFormat,'js/jquery.treeview.js')}"></script>
<script type="text/javascript" src="{!URLFOR($Resource.FormFormat,'js/jquery.treeview.async.js')}"></script>
 -->
<script type="text/javascript" src="{!URLFOR($Resource.treeview,'jquery.treeview.js')}"></script>
<!--
<script type="text/javascript" src="{!URLFOR($Resource.treeview,'jquery.treeview.async.js')}"></script>
 -->
<script type="text/javascript" src="{!URLFOR($Resource.FormFormat,'js/fg.menu.js')}"></script>
<script type="text/javascript" src="{!URLFOR($Resource.FormFormat,'js/inputCheck.js')}"></script>
<script type="text/javascript" src="{!URLFOR($Resource.FormFormat,'js/jquery.simple.tree.js')}"></script>

<apex:include pageName="SOLXYZCSO001__WRCSOScript" />
<apex:include pageName="SOLXYZCSO001__WRCSOSilverlight"/>

<script type="text/javascript" src="{!URLFOR($Resource.WRCSO,'js/xdr.js')}"></script>

<link type="text/css" rel="stylesheet" href="{!URLFOR($Resource.FormFormat,'css/jquery.simple.tree.css')}" />

<style type="text/css">

#LeftPane {
    overflow: auto;
}

.splitter-bar-vertical {
    width: 3px;
}

.leftMenu {
    /*background-image: url("/image/left_menu.gif");*/
    background-repeat: repeat-x;
    background-position: left center;
    padding: 0px 10px 0px 15px;
    color: #FFFFFF;
    font-weight: bold;
    height: 30px;
    width: 100%;
}

body{
    min-width:930px;
/*  overflow-y:hidden;*/
}

#RightPane {
    overflow:hidden;
    min-width:740px;

}

.filetree span.p_machine {  padding: 1px 0 1px 20px; display: block;background: url(/image/manager/printer-tree.png) 0 0 no-repeat; background-size:contain;}
.filetree span.ovl_file {  padding: 1px 0 1px 20px; display: block;background: url(/image/page/overlayIcon.JPG) 0 0 no-repeat; background-size:contain;}
.filetree span.box-master {  padding: 1px 0 1px 20px; display: block;background: url(/image/manager/box-master.png) 0 0 no-repeat ;background-size:contain; }

.filetree li.collapsable span.p_client {  padding: 1px 0 1px 20px; display: block;background: url(/image/manager/Print-client-push.png) 0 0 no-repeat; background-size:contain;}
.filetree li.expandable span.p_client { background: url(/image/manager/Print-client-pull.png) 0 0 no-repeat; background-size:contain;}
.filetree li.last span.p_client { background: url(/image/manager/Print-client-pull.png) 0 0 no-repeat; background-size:contain;}
</style>




</head>

<body class="notdrops">




<link type="text/css" rel="stylesheet" href="{!URLFOR($Resource.FormFormat,'css/droppy.css')}" />

<script type="text/javascript" src="{!URLFOR($Resource.FormFormat,'js/jquery.droppy.js')}"></script>
<!--
<script type="text/javascript" src="/jsp/rb_js.jsp"></script>
 -->

<style type="text/css">
#menu ul,#menu li {
    margin: 0;
    padding: 0;
}

#menu li {
    list-style: none;
    float: left;
}

#menu a {
    display: block;
    margin: 0 auto;
    color: #fff;
    text-decoration: none;
    background: url(/image/_right.png) right top no-repeat;
}

#menu a span {
    display: block;
    text-align: center;
    background: url(/image/_left.png) left top no-repeat;
    font: bold 12px/ 52px Arial, Helvetica, sans-serif;
    padding: 0 20px;
}

#menu a:hover {
    background-position: right bottom;
}

#menu a:hover span {
    background-position: left bottom;
}

.shadow {
    -webkit-box-shadow: inset 0px 0px 10px 0px #0066ff;
    -moz-box-shadow: inset 0px 0px 10px 0px #0066ff;
    box-shadow: inset 0px 0px 10px 0px #0066ff;
    color: #E6E6FA;
}

.headerMenu{
    width: 100%;
    height: 52px;
    color: white;
    border-collapse: collapse;
    border-spacing: 0px;
    margin: 0px;
    background: url('/image/background.png') repeat-x;
    min-width:993px;

}

#appname {
    font-size: 16px;
    font-weight: bold;
    padding-left: 10px;
    width: 200px;
    vertical-align: middle;
}

.headerMenu a{
    color: #FFFFFF;
}

.header-icon{
    width: 18px;
    height: 18px;
    vertical-align: middle;
    border: none;
}

.headerMenu a{
    color: #FFFFFF;
}

img {
    border: none;
    margin-right:5px;
    margin-left:5px;
}

img.icon {
    width : 18px;
    height : 18px;
    margin-left:3px;
    margin-right:3px;
}

td.logo {
    font-size: 16px;
    font-weight: bold;
    padding-left: 5px;
    width: 200px;
    color:#FFFFFF;
}


#headerMenuUsername{
    text-align:right;
    vertical-align:middle;
    white-space:nowrap;
    padding-left:2px;
    padding-bottom:2px;
}

#headUserName{
    color:#000000;
    font-weight:bold;
}

#headerUserPhoto{
    background-image : url("/dispLoginUserImage?date=' + 1364879786267");
    background-repeat : no-repeat;
    height:45px;
    width:45px;
}

#headerUserPhoto {
    background-image:
        url("/dispLoginUserImage?date=' + 1364879786267")
        ;
    background-repeat: no-repeat;
    height: 45px;
    width: 45px;
}


.headerMenu td{
    vertical-align:middle;
}

#searchform {
    width: 175px;
    //background: url("/image/input4.png") left top no-repeat;
    display: block;
    height: 23px;
    padding-bottom:3px;
    position: relative;
}

#searchBtn    {
    position: absolute;
    top: 2px;
    left: 134px;
    height:14px;
    border: solid 1px silver;
    background-color:#FFFFFF;
    border-radius:0px 3px 3px 0px;
    padding:2px 10px 2px 10px;;
}

#reportName {
    width: 130px;
    position: absolute;
    top: 2px;
    height: 16px;


    border: solid 1px silver;
    font-size: 11.5px;
    border-radius:3px 0px 0px 3px;
    padding-left:3px;
}

body {



            min-width:993px;


}

</style>









<table id="MainDiv" cellspacing="0" cellpadding="0" style="min-width:993px;overflow:scroll;">
    <tbody>
        <tr>
            <td  class="treeSidebarWidth reportListTree"  Valign="top">
                <img alt="" src="{!URLFOR($Resource.FormFormat,'img/loading.gif')}" style="position: absolute; top: 40%;left: 100px; display: none;" id="loadingGif"/>


<script type="text/javascript">


var simpleTreeCollection;
var curList = "ovl";
$(document).ready(function(){
    $.ajaxSetup({ cache: false });

    $('div[id$="ecmImage"]').hide();


});

var menuKey =0;
var oldMenu=-1;












// 帳票書式のプレビュー
function side_formformatpreview_reload() {
    menuKey = 11;
    if (oldMenu!=menuKey) oldMenu=menuKey;
    curList = "formp";


    $("#formFormatPreview").show();

    $("#sidePreviewBody").children().remove();
}



var leavePageFlag = false;
var goVal;
var submitFormFun=function(){
    return true;
};


</script>
<style type="text/css">
.settingSideMenu{
    margin: 10px 20px;
}

.hidden{
    display: none;
}

#contentsTree *{
    color:#000000;
     white-space: nowrap;
}

#contentsTree img{
     margin-bottom : -4px;
}

.treeSelect {
    color:red;
}

</style>
                <div id="formFormatPreview" class="formFormatPreview" style="overflow: auto; display: block; height: 97%;">
                    <table id="sidePreview" class="previewTable" align="center">
                        <tbody id="sidePreviewBody">

                        </tbody>
                    </table>
                </div>

            </td>

            <td valign="top">
                <div id="RightPane" style="">
                    <div style="/*overflow:auto;*/ width:100%;" id="mainContentsDiv" >


<link type="text/css" rel="stylesheet" href="{!URLFOR($Resource.FormFormat,'css/jquery.treeTable.css')}"/>
<link type="text/css" rel="stylesheet" href="{!URLFOR($Resource.FormFormat,'css/colorbox.css')}"/>
<script type="text/javascript" src="{!URLFOR($Resource.FormFormat,'js/jquery.colorbox-min.js')}"></script>
<script type="text/javascript" src="{!URLFOR($Resource.FormFormat,'js/jquery.treeTable.js')}"></script>
<script type="text/javascript" src="{!URLFOR($Resource.FormFormat,'js/jquery.tablednd.0.7.min.js')}"></script>

<script type="text/javascript">
Visualforce.remoting.timeout = 120000; // Set timeout at page level


var uploaderlist = [];
var imgList = [];
var CTRL_WIDTH = '20px';

var result = true;
var finished = [false, false];
var cnt = 0;
//シート情報
//var sheetDto;
var sheetDto = new Object();

sheetDto.sheet_list = new Array();
//書式
var format = new Array();
//シート一覧
var sheetsBase = new Array();
//選択可能シート
var allSheets = new Array();
//通常シート
var normalSheets = new Array();

var conditionMap = new Array();

var changeing = false;


$(function() {

    // TABの設定
    $('#tabs').tabs();
    $("#tabs").bind("tabsshow", function(event, ui) {

    });


//    var title = JSMsg["field.31068"];
    var title = '';



    conditionMap['PBB'] = '{!$Label.label_wf_29001}';//前（ページ毎）
    conditionMap['PBA'] = '{!$Label.label_wf_29002}';//改ページの後
    conditionMap['FBA'] = '{!$Label.label_wf_29003}';//条件付き改ページの後


    $('#tabs').css('display','');




    initFFR();




});

/**
* 初期処理
*/
function initFFR() {
    //選択済みテーブル
    $("#selectedTable").treeTable({
        //treeColumn:2,
        trrColumn:0,
        expandable: true
    });
    $('#rows tr').each(function(){
        if(!$(this).is('.expanded')) {
            $(this).expand();
        }
    });

    $('.previewImg').colorbox({
        rel:'previewImg',
        opacity:0.8
    });

}

/**
* キャンセルボタンの戻り先指定
*/
function back() {
    top.location.href = '/{!$ObjectType.ReportDefinition__c}/o';
}

function rowMove(sourceId, destId) {

    var parent;
    var idx;
    var source = getRowData(sourceId, format);
    if (destId == undefined || destId == null) {
        source.parent.splice(source.idx, 1);
        format.splice(0, 0, source.target);
    } else if (destId.match(/-end$/) != null){
        var dest = getRowData(destId.replace(/-end$/, ""), format);
        source.parent.splice(source.idx, 1);
        dest.parent.splice(Number(dest.idx) + 1, 0, source.target);
    }else {
        if (source != undefined && source != null) {
            if (source.target.type != undefined && source.target.type != 'sheet') {
                if (null != getRowData(destId, source.target.children)) {
                    return;
                }
            }
            source.parent.splice(source.idx, 1);
        } else {
            return ;
        }
        var dest = getRowData(destId, format);
        if (dest == null) {
            source.parent = childClone;
            return;
        }
        if (dest.target.type != null && dest.target.type != "sheet") {
            dest.target.children.splice(0,0,source.target);
        }else {
            dest.parent.splice(Number(dest.idx) + 1, 0, source.target);
        }
    }
}


function getRowData(id, fmt) {

    var target = null;
    if (fmt == undefined || fmt == null) {
        fmt = format;
    }
    var selSep = id.split('-');
    //for (var i in fmt) {
    for(var i=0;i<fmt.length;i++){
        if (fmt[i].type != "sheet") {
            //if (compareArray(fmt[i].id.split('-'), selSep)) {
            if (compareArray(fmt[i].sheet_id.split('-'), selSep)) {
                var obj = {target : fmt[i], parent:fmt, idx : i };
                return obj;
            } else {
                target = getRowData(id, fmt[i].children);
                if (target != null) {
                    return target;
                }
            }
        } else {
            if (fmt[i].sheet_id == selSep[selSep.length - 1]) {
                var obj = {target : fmt[i], parent:fmt, idx : i };
                return obj;
            }
        }
    }
    return null;
}









var USERNAME = '{!JSENCODE($User.username)}';
var CREDENTIAL = '{!JSENCODE(credential)}';







/**
* 初期化
*/
function resetSheetSelect() {
    allSheets = new Array();
    normalSheets = new Array();
    format = new Array();
    sheetsBase = new Array();
}



/**
* 差し込みシート一覧作成
*/
function makeInsSheetList(insObj) {

    //var select = $('<select>').attr('id', 'sheet-' + insObj.id);
    var select = $('<select>').attr('id', 'sheet-' + insObj.insert_sheet_id).attr('disabled', 'disabled');

    //for (var i in sheetsBase) {
    for(var i =0;i<sheetsBase.length;i++){

        //select.append($('<option>').attr('value', sheetsBase[i].id).text(sheetsBase[i].name));
        select.append($('<option>').attr('value', sheetsBase[i].sheet_id).text(sheetsBase[i].sheet_name));
    }

    select.change(function(){

        changeInsSheet($(this).attr('id'), $(this).children("option:selected").val(), $(this).children("option:selected").text());
    });
    select.val(insObj.nid).change();
    return select;
}


/**
*  条件オブジェクト生成
*/
function makeCondition(insObj) {

    //var select = $('<select>').attr('id', 'condition-' + insObj.id);
    var select = $('<select>').attr('id', 'condition-' + insObj.insert_sheet_id).attr('disabled', 'disabled');;

    for (var val in conditionMap) {
    if(val != 'remove'){

        select.append($('<option>').attr('value', val).text(conditionMap[val]));

        }
    }


    select.change(function(){
        changeCondition($(this).attr('id'), $(this).val());
    });


    //select.val(insObj.condition).change();
    select.val(insObj.insert_condition).change();


    return select;
}


/**
* 差し込み生成
*/
function makeInsertInfo(id, sheet, condition) {
    var insert = {};
    var name = null;
    //for (var i in sheetsBase) {
    for(var i=0;i<sheetsBase.length;i++){
        //if (sheetsBase[i].id == sheet) {
        if (sheetsBase[i].sheet_id == sheet) {
            //name = sheetsBase[i].name;
            name = sheetsBase[i].sheet_name;
            break;
        }
    }
    insert['nid']    = sheet;

    //insert['name']  = name;
    insert['insert_sheet_name'] = name;
    insert['type']  = 'insert';
    insert['sheet']  = sheet;
    //insert['condition']  = condition;
    insert['insert_condition'] = condition;
    return insert;
}

/**
* シート生成
*/
function makeSheetInfo(id, name, changeable, type) {
    var sheet = {};
    //sheet['id']    = id;
    sheet['sheet_id'] = id.toString();
    //sheet['name']  = name;
    sheet['sheet_name'] = name;
    sheet['type']  = type;
    sheet['changeable'] = changeable;
    //sheet['insert']  = new Array();
    sheet['insertions']  = new Array();

    //本体側にない処理でSF側では必要
    sheetNamesheetIdMap[name] = id;

    return sheet;
}

/**
 * ノード追加
 */
 function appendRow(node, step, selectId) {

    var margin = {
            "margin-right" : "5px",
            "margin-left" : "5px"
    };
    //var delButton = $('<input type="image" src="{!URLFOR($Resource.FormFormat,'img/delete.png')}" height="18px">').attr('alt', '{!$Label.field_common_remove}').attr('title', '{!$Label.field_common_remove}').css(margin);
    //var repButton = $('<input type="image" src="{!URLFOR($Resource.FormFormat,'img/Repeat.png')}" height="18px">').attr('alt', '{!$Label.label_wf_29004}').attr('title', '{!$Label.label_wf_29004}').css(margin);
    //var insButton = $('<input type="image" src="{!URLFOR($Resource.FormFormat,'img/add.png')}" height="18px">').attr('alt', '{!$Label.label_wf_29005}'').attr('title', '{!$Label.label_wf_29005}'').css(margin);
    //var trcButton = $('<input type="image" src="{!URLFOR($Resource.FormFormat,'img/fd-copy.png')}" height="18px">').attr('alt', '{!$Label.label_wf_29006}').attr('title', '{!$Label.label_wf_29006}').css(margin);
    var delButton = $('<img src="{!URLFOR($Resource.FormFormat,'img/delete.png')}" height="18px">').attr('alt', '{!$Label.field_common_remove}').attr('title', '{!$Label.field_common_remove}').css(margin);
    var repButton = $('<img src="{!URLFOR($Resource.FormFormat,'img/Repeat.png')}" height="18px">').attr('alt', '{!$Label.label_wf_29004}').attr('title', '{!$Label.label_wf_29004}').css(margin);
    var insButton = $('<img src="{!URLFOR($Resource.FormFormat,'img/add.png')}" height="18px">').attr('alt', '{!$Label.label_wf_29005}').attr('title', '{!$Label.label_wf_29005}').css(margin);
    var trcButton = $('<img src="{!URLFOR($Resource.FormFormat,'img/fd-copy.png')}" height="18px">').attr('alt', '{!$Label.label_wf_29006}').attr('title', '{!$Label.label_wf_29006}').css(margin);


    if (node.type != 'sheet' && node.type != undefined) {
        //var row = $('<tr>').attr('id', node.id).addClass('draggable');
        var row = $('<tr>').attr('id', node.sheet_id).addClass('draggable');
        //var endTr = $('<tr>').attr('id', node.id + '-end').addClass('nodrag');
        var endTr = $('<tr>').attr('id', node.sheet_id + '-end').addClass('nodrag');

        if (step != null) {
            row.addClass("child-of-" + step);
            endTr.addClass("child-of-" + step);
        }

        //delButton.attr('onClick', 'deleteNode(format, "' + node.id + '");change();');
        delButton.attr('onClick', 'deleteNode(format, "' + node.sheet_id + '");change();');
//        row.append($('<td>').addClass("rowhandler").addClass('sortCell').append($("<div>").addClass("drag").addClass("row")));
//        row.append($('<td>').append(delButton).addClass('controlCell').css("white-space","nowrap"));
        var selectedTd = $('<td>').addClass("sheetname");
        var endTd = $('<td>').addClass("sheetname");
        if (node.type == 'repeat') {
            selectedTd.append('<span>{!$Label.label_wf_29004}</span>');
            row.addClass('repeat');
            endTd.append('<span>{!$Label.label_wf_29007}</span>');
        } else {
            selectedTd.append('<span>{!$Label.label_wf_29006}</span>');
            row.addClass('trace');
            endTd.append('<span>{!$Label.label_wf_29008}</span>');
        }
        row.append(selectedTd).append($('<td>'));


        $('#rows').append(row);
        //for (var i in node.children) {
        for(var i=0;i<node.children.length;i++){
                //appendRow(node.children[i], node.id, selectId);
                appendRow(node.children[i], node.sheet_id, selectId);
        }
        //endTr.append($('<td>')).append($('<td>')).append(endTd).append($('<td>'));
        endTr.append(endTd).append($('<td>'));

        $('#rows').append(endTr);

    } else {
        // 単ページ
        var changeable = null;
        //var id = 'row-'+node.id;
        var id = 'row-'+node.sheet_id;
        //var row = $('<tr>').attr('id', id).addClass("sheet").addClass('draggable');;
        var row = $('<tr>').attr('id', id).addClass("sheet").addClass('draggable');

        if (step != null) {
            row.addClass("child-of-" + step);
        }

        delButton.attr('onClick', 'deleteNode(format, "' + id + '");change();');
        repButton.attr('onClick', 'repeatNode(format,"' + id + '");change();');
        trcButton.attr('onClick', 'traceNode(format, "' + id + '");change();');
//        row.append($('<td>').addClass("rowhandler").addClass('sortCell').append($("<div>").addClass("drag").addClass("row")));
//        row.append($('<td>').append(delButton).append(repButton).append(trcButton).css("white-space","nowrap"));
        var selectedTd = $('<td>').addClass("sheetname");
        if (node.changeable) {
            selectedTd.append($("<img src=\'{!URLFOR($Resource.FormFormat,'img/Variable_form.png')}\' width='20px'>").css("margin", "0"));
        } else {
            selectedTd.append($("<img src=\'{!URLFOR($Resource.FormFormat,'img/fixed_document.png')}\' width='20px'>").css("margin", "0"));
        }
        //row.append(selectedTd.append("<span>"+ node.name + "</span>"));
        row.append(selectedTd.append("<span>"+ node.sheet_name + "</span>"));


        //if(node.insert != undefined && node.insert != null && node.insert.length>0){
        if(node.insertions != undefined && node.insertions != null && node.insertions.length>0){
        // 差し込み
        var list = $('<ul>');
        list.addClass('insertionSheet');
        //for (var i in node.insert) {
        for(var i=0;i<node.insertions.length;i++){
            //var li = $('<li>').append(makeCondition(node.insert[i]), '  ', makeInsSheetList(node.insert[i]), '  ');
            var li = $('<li>').append(makeCondition(node.insertions[i]), '  ', makeInsSheetList(node.insertions[i]), '  ');

            //var upBt = '<input type="image" src="{!URLFOR($Resource.FormFormat,'img/arrow_up_white.png')}" height="18px" onClick="InsUp(\'' + node.id + '\',\'' + node.insert[i].id + '\');">';
//            var upBt = '<input type="image" src="{!URLFOR($Resource.FormFormat,'img/arrow_up_white.png')}" height="18px" onClick="InsUp(\'' + node.sheet_id + '\',\'' + node.insertions[i].insert_sheet_id + '\');">';


            //var delBt = '<input type="image" src="{!URLFOR($Resource.FormFormat,'img/delete.png')}" height="18px" onClick="InsDel(\'' + node.id + '\',\'' + node.insert[i].id + '\')">';
//            var delBt = '<input type="image" src="{!URLFOR($Resource.FormFormat,'img/delete.png')}" height="18px" onClick="InsDel(\'' + node.sheet_id + '\',\'' + node.insertions[i].insert_sheet_id + '\')">';

            //var downBt = '<input type="image" src="{!URLFOR($Resource.FormFormat,'img/arrow_down_white.png')}" height="18px" onClick="InsDown(\'' + node.id + '\',\'' + node.insert[i].id + '\')">';
//            var downBt = '<input type="image" src="{!URLFOR($Resource.FormFormat,'img/arrow_down_white.png')}" height="18px" onClick="InsDown(\'' + node.sheet_id + '\',\'' + node.insertions[i].insert_sheet_id + '\')">';

//            li.append(upBt);
//            li.append(delBt);
//            li.append(downBt);
            list.append(li);
        }



        }
        //insButton.attr('onClick', 'appendInsert(format, makeInsertInfo(randamStr(5), sheetsBase[0].id, "PBB"), ' + node.id + ');change();');
        insButton.attr('onClick', 'appendInsert(format, makeInsertInfo(randamStr(5), sheetsBase[0].sheet_id, "PBB"), ' + node.sheet_id + ');change();');

        //row.append($('<td>').append(insButton).append(list));
        row.append($('<td>').append(list));

        $('#rows').append(row);


        if (selectId != undefined && selectId != null) {
            if (row.attr('id') == selectId) {
                row.addClass("ui-selected");
                row.addClass("selected");
            }
        }


    }
}

/**
* 選択済みシート表示変更
*/
function change(selectId) {

    // 選択可能シート
    $('#SelectableSheet').children().remove();
    //for (var i in allSheets) {
    for(var i=0;i<allSheets.length;i++){
        var changeable = "";
        //var option = $('<option>').attr('value', allSheets[i].id);
        var option = $('<option>').attr('value', allSheets[i].sheet_id);


        if (allSheets[i].changeable) {
            changeable = "*";
        }
        //$('#SelectableSheet').append(option.text(changeable + allSheets[i].name));
        if(option != ""){
            //$('#SelectableSheet').append(option.text(changeable + allSheets[i].name));
            $('#SelectableSheet').append(option.text(changeable + allSheets[i].sheet_name));
        }
    }
    // 選択済みシート
    $('#rows').children().remove();
    //for (var i in format) {
    for(var i=0;i<format.length;i++){
/*      appendRow(format[i], 0, selectId); */
        appendRow(format[i], null, selectId);
    }

    ReloadPreview();

    initFFR();

}

/**
* 書式に要素を追加する
*/
function appendNode(fmt, node, selected) {
    if (selected === undefined) {
        fmt.push(node);
    } else {
        //for (var i in fmt) {
        for(var i=0;i<fmt.length;i++){
            //if (selected == fmt[i].id) {
            if (selected == fmt[i].sheet_id) {
                fmt.splice(i+1, 0, node);
            }
            if (fmt[i].type != 'sheet') {
                //var id = fmt[i].id.split('-').pop();
                var id= fmt[i].sheet_id.split('-').pop();
                if (id == selected) {
                    fmt[i].children.push(node);
                } else {
                    appendNode(fmt[i].children, node, selected);
                }
            }
        }
    }
}



/**
* 書式に条件を追加する
*/
function appendInsert(fmt, insert, selected) {

    //for (var i in fmt) {
    for(var i=0;i<fmt.length;i++){
        if (fmt[i].type != 'sheet') {
            appendInsert(fmt[i].children, insert, selected);
        } else {
            //if (selected == fmt[i].id) {
            if (selected == fmt[i].sheet_id) {
                //var len = fmt[i].insert.length;
                var len = fmt[i].insertions.length;
                //insert.id = "sheet-" + fmt[i].id + "-" + len;
                insert.insert_sheet_id = "sheet-" + fmt[i].sheet_id + "-" + len;
                //fmt[i].insert.push(insert);
                fmt[i].insertions.push(insert);
            }
        }
    }
}

/**
* 書式から要素を削除する
*/
function deleteNode(fmt, selected) {

    if (selected == undefined) {
        return null;
    } else if(fmt.length == 0) {
        return null;
    } else {
        var selSep = selected.split('-');
        //for (var i in fmt) {
        for(var i=0;i<fmt.length;i++){
            if (fmt[i].type != "sheet") {
                //if (compareArray(fmt[i].id.split('-'), selSep)) {
                if(compareArray(fmt[i].sheet_id.split('-'), selSep)){
                    var target = fmt[i];
                    // 繰り返しが選択された場合
                    deleteChildren(fmt[i].children);
                    deleteSheet(fmt, i);
                    return target;
                } else {
                    var target = deleteNode(fmt[i].children, selected);
                    if (target != null) {
                        // 繰り返しの要素を選択された場合
                        return target;
                    }
                }
            //} else if (selSep[selSep.length - 1] == fmt[i].id) {
            } else if (selSep[selSep.length - 1] == fmt[i].sheet_id) {
                var target = fmt[i];
                allSheets.push(fmt[i]);
                deleteSheet(fmt, i);
                return target;
            }
        }
    }
    return null;
}

function deleteChildren(fmt) {

    if (fmt == undefined || fmt == null) {
        return;
    }
    for (var i = fmt.length-1; i >= 0; i--) {
        if (fmt[i].type != undefined && fmt[i].type != 'sheet') {
            deleteChildren(fmt[i].children);
        } else {
            var target = fmt[i];
            allSheets.push(fmt[i]);
            deleteSheet(fmt, i);
        }
    }
}

/**
* InsDelボタン処理
*/
function InsDel(nid, iid, fmt) {

    if (fmt == undefined || fmt == null) {
        fmt = format;
    }
    //for (var i in fmt) {
    for(var i=0;i<fmt.length;i++){
        if (fmt[i].type != "sheet") {
            if (InsDel(nid, iid, fmt[i].children)) {
                return true;
            }
        } else if (fmt[i].id == nid) {
            //for (var j in fmt[i].insert) {
            for(var j=0;j<fmt[i].insertions.length;j++) {
                //if (fmt[i].insert[j].id == iid) {
                if (fmt[i].insertions[j].sheet_id == iid) {
                    //deleteSheet(fmt[i].insert, j);
                    deleteSheet(fmt[i].insertions, j);
                    change();
                    return true;
                }
            }
        }
    }
    return false;
}
/**
* 指定されたインデックスの削除
*/
function deleteSheet(fmt, idx) {

    //fmt[idx].insert = new Array();
    fmt[idx].insertions = new Array();
    fmt.splice(idx, 1);
}


//繰り返し処理
function repeatNode(fmt, selected) {
    if (selected === undefined) {
        return false;
    } else if(fmt.length == 0) {
        return false;
    } else {
        var selSep = selected.split('-');
        //for (var i in fmt) {
        for(var i=0;i<fmt.length;i++){
            if (fmt[i].type != "sheet") {
                if (repeatNode(fmt[i].children, selected)) {
                    // 繰り返しの要素を選択された場合
                    return true;
                }
            //} else if (selSep[selSep.length - 1] == fmt[i].id) {
            } else if (selSep[selSep.length - 1] == fmt[i].sheet_id) {
                repeatSheet(fmt, i);
                return true;
            }
        }
    }
    return false;
}

function repeatSheet(fmt, idx) {

    var repSheet = fmt[idx];
    var repeat = makeRepeatInfo(randamStr(5));
    repeat['children'][0] = repSheet;
    fmt.splice(idx, 1, repeat);
}


/**
* 繰り返し生成
*/
function makeRepeatInfo(id) {
    var repeat = {};
    //repeat['id']    = 'repeat-' + id;
    repeat['sheet_id'] = 'repeat-' + id;
    //repeat['name']  = '{!$Label.label_wf_29004}';
    repeat['sheet_name']  = '{!$Label.label_wf_29004}';
    repeat['type']  = 'repeat';
    repeat['children'] = new Array();
    return repeat;
}

/**
 * トレース処理
 */
function traceNode(fmt, selected) {
    if (selected === undefined) {
        return false;
    } else if(fmt.length == 0) {
        return false;
    } else {
        var selSep = selected.split('-');
        //for (var i in fmt) {
        for(var i=0;i<fmt.length;i++){
            if (fmt[i].type != "sheet") {
                if (traceNode(fmt[i].children, selected)) {
                    // トレースの要素を選択された場合
                    return true;
                }
            //} else if (selSep[selSep.length - 1] == fmt[i].id) {
            } else if (selSep[selSep.length - 1] == fmt[i].sheet_id) {
                traceSheet(fmt, i);
                return true;
            }
        }
    }
    return false;
}

function traceSheet(fmt, idx) {

    var repSheet = fmt[idx];
    var repeat = makeTraceInfo(randamStr(5));
    repeat['children'][0] = repSheet;
    fmt.splice(idx, 1, repeat);
}

function makeTraceInfo(id) {
    var repeat = {};
    //repeat['id']    = 'trace-' + id;
    repeat['sheet_id']    = 'trace-' + id;
    //repeat['name']  = '{!$Label.label_wf_29006}';
    repeat['sheet_name']  = '{!$Label.label_wf_29006}';
    repeat['type']  = 'trace';
    repeat['children'] = new Array();
    return repeat;
}


/**
* Upボタン処理
*/
function nodeUp(fmt, selected) {

    if (selected === undefined) {
        return false;
    } else if(fmt.length == 0) {
        return false;
    } else {
        var selSep = selected.split('-');
        //for (var i in fmt) {
        for(var i=0;i<fmt.length;i++){
            if (fmt[i].type != "sheet") {
                //if (compareArray(fmt[i].id.split('-'), selSep)) {
                if (compareArray(fmt[i].sheet_id.split('-'), selSep)) {
                    upSheet(fmt, i);
                    return true;
                } else if (nodeUp(fmt[i].children, selected)) {
                    // 繰り返しの要素を選択された場合
                    return true;
                }
            //} else if (selSep[selSep.length - 1] == fmt[i].id) {
            } else if (selSep[selSep.length - 1] == fmt[i].sheet_id) {
                upSheet(fmt, i);
                return true;
            }
        }
    }
    return false;
}

/**
* InsUpボタン
*/
function InsUp(nid,iid, fmt) {

    if (fmt == undefined || fmt == null) {
        fmt = format;
    }
    //for (var i in fmt) {
    for(var i=0;i<fmt.length;i++){
        if (fmt[i].type != "sheet") {
            if (InsUp(nid, iid, fmt[i].children)) {
                return true;
            }
        //} else if (fmt[i].id == nid) {
        } else if (fmt[i].sheet_id == nid) {
            //for (var j in fmt[i].insert) {
            for(var j=0;j<fmt[i].insertions.length;j++){
                //if (fmt[i].insert[j].id == iid) {
                if (fmt[i].insertions[j].insert_sheet_id == iid) {
                    //upSheet(fmt[i].insert, j);
                    upSheet(fmt[i].insertions, j);
                    change();
                    return true;
                }
            }
        }
    }
    return false;
}



/**
* 配列要素のUp処理
*/
function upSheet(fmt, idx) {
    if (idx == 0) {
        return;
    }
    var selFmt = fmt[idx];
    fmt.splice(idx, 1);
    fmt.splice(idx-1, 0, selFmt);
}


/**
* Downボタン処理
*/
function nodeDown(fmt, selected) {
    if (selected === undefined) {
        return false;
    } else if(fmt.length == 0) {
        return false;
    } else {
        var selSep = selected.split('-');
        //for (var i in fmt) {
        for(var i=0;i<fmt.length;i++){
            if (fmt[i].type != "sheet") {
                //if (compareArray(fmt[i].id.split('-'), selSep)) {
                if (compareArray(fmt[i].sheet_id.split('-'), selSep)) {
                    downSheet(fmt, i);
                    return true;
                } else if (nodeDown(fmt[i].children, selected)) {
                    // 繰り返しの要素を選択された場合
                    return true;
                }
            //} else if (selSep[selSep.length - 1] == fmt[i].id) {
            } else if (selSep[selSep.length - 1] == fmt[i].sheet_id) {
                downSheet(fmt, i);
                return true;
            }
        }
    }
    return false;
}


/**
* InsDownボタン
*/
function InsDown(nid, iid, fmt) {

    if (fmt == undefined || fmt == null) {
        fmt = format;
    }
    //for (var i in fmt) {
    for(var i=0;i<fmt.length;i++){
        if (fmt[i].type != "sheet") {
            if (InsDown(nid, iid, fmt[i].children)) {
                return true;
            }
        //} else if (fmt[i].id == nid) {
        } else if (fmt[i].sheet_id == nid) {
            //for (var j in fmt[i].insert) {
            for(var j=0;j<fmt[i].insertions.length;j++){
                //if (fmt[i].insert[j].id == iid) {
                if (fmt[i].insertions[j].insert_sheet_id == iid) {
                    //downSheet(fmt[i].insert, j);
                    downSheet(fmt[i].insertions, j);
                    change();
                    return true;
                }
            }
        }
    }
    return false;
}


/**
* 配列要素のDown処理
*/
function downSheet(fmt, idx) {

    if (idx == fmt.length - 1) {
        return;
    }
    var selFmt = fmt[idx];
    fmt.splice(idx, 1);
    fmt.splice(idx-0+1, 0, selFmt);
}

/**
* 差し込みシート変更処理
*/
function changeInsSheet(id, value, text, fmt) {

    if (fmt == undefined || fmt == null) {
        fmt = format;
    }

    //for (var i in fmt) {
    for(var i=0;i<fmt.length;i++){
        if (fmt[i].type != "sheet") {
            if (changeInsSheet(id, value, text, fmt[i].children)) {
                return true;
            }
        //} else if (fmt[i].insert != undefined && fmt[i].insert != null && fmt[i].insert.length != 0) {
        } else if (fmt[i].insertions != undefined && fmt[i].insertions != null && fmt[i].insertions.length != 0) {
            //for (var j in fmt[i].insert) {
            //for(var j=0;j<fmt[i].insert.length;j++){
            for(var j=0;j<fmt[i].insertions.length;j++){
                //if (("sheet-" + fmt[i].insert[j].id) == id) {
                if (("sheet-" + fmt[i].insertions[j].insert_sheet_id) == id) {

                    //fmt[i].insert[j].nid = value
                    fmt[i].insertions[j].nid = value;
                    //fmt[i].insert[j].name = text;
                    fmt[i].insertions[j].insert_sheet_name = text;
                    ReloadPreview();
                    return true;
                }
            }
        }
    }
    return false;

}


/**
* 条件変更処理
*/
function changeCondition(id, value, fmt) {

    if (fmt == undefined || fmt == null) {
        fmt = format;
    }

    //for (var i in fmt) {
    for(var i=0;i<fmt.length;i++){
        if (fmt[i].type != "sheet") {
            if (changeCondition(id, value, fmt[i].children)) {
                return true;
            }
        //} else if (fmt[i].insert != undefined && fmt[i].insert != null && fmt[i].insert.length != 0) {
        } else if (fmt[i].insertions != undefined && fmt[i].insertions != null && fmt[i].insertions.length != 0) {
            //for (var j in fmt[i].insert) {
            for(var j=0;j<fmt[i].insertions.length;j++){
                //if (("condition-" + fmt[i].insert[j].id) == id) {
                if (("condition-" + fmt[i].insertions[j].insert_sheet_id) == id) {

                    //fmt[i].insert[j].condition = value;
                    fmt[i].insertions[j].insert_condition = value;
                    ReloadPreview();
                    return true;
                }
            }
        }
    }
    return false;
}

/**
* ID比較
*/
function compareArray(array1, array2) {
    if (array1.length != array2.length) {
        return false;
    }

    //for (var acnt in array1) {
    for(var acnt=0;acnt<array1.length;acnt++){
        if (array1[acnt] != array2[acnt]) {
            return false;
        }
    }
    return true;
}

/**
*
*/
function randamStr(n) {
    var sample = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'.split('');
    var str = '';
    for (var i = 0; i < n; i++) {
        str += sample[Math.floor(Math.random() * sample.length)];
    }
    return str;
}



/**
* プレビュー再描画
*/
function ReloadPreview(fmt, elem, ctrlImg) {

    if (fmt == undefined || fmt == null) {
        fmt = format;
    }
    if (elem == undefined || elem == null) {
        elem = $("#sidePreviewBody");
        //削除
        elem.children().remove();
    }

    var first = true;
    var insLen = 0;
    var th = null;
    //for (var i in fmt) {
    for(var i=0;i<fmt.length;i++){
        var tr = $('<tr>');

        if (fmt[i].type != "sheet") {
        //繰り返し
            if (fmt[i].children == undefined ||
                    fmt[i].children == null ||
                    fmt[i].children.length == 0) {
                continue;
            }
            if (!first) {
            } else {
                if (ctrlImg != undefined || ctrlImg != null) {
                    th = $('<td>');
                    var ctrl = $("<img width='"+ CTRL_WIDTH + "'>");
                    ctrl.attr('src', ctrlImg);
                    th.append(ctrl);
                    tr.append(th);
                }
                first = false;
            }
            var thr = $('<th>');
            var subTbl = $('<table>');
            var tb = $('<tbody>');
            var img;
            if (fmt[i].type == 'repeat') {
                img = '{!URLFOR($Resource.FormFormat,"img/arrow-curve-down.png")}';
            } else {
                img = '{!URLFOR($Resource.FormFormat,"img/bracket.png")}';
            }
            ReloadPreview(fmt[i].children, tb, img);
            subTbl.addClass('previewTable').append(tb);
            thr.append(subTbl);
            tr.append(thr);
            elem.append(tr);
        } else {
            if (!first) {
            } else {
                if (ctrlImg != undefined || ctrlImg != null) {
                    th = $('<td>');
                    var ctrl = $("<img width='"+ CTRL_WIDTH + "'>");
                    ctrl.attr('src', ctrlImg);
                    th.append(ctrl);
                    tr.append(th);
                }
                first = false;
            }
            var td = $('<td>');
            tr.append(td);
            elem.append(tr);
//            addPreview(td, fmt[i].id,fmt[i].name, sheetDto.sheet_list[fmt[i].id].thumnail, fmt[i].changeable);
            addPreview(td, fmt[i].sheet_id,fmt[i].sheet_name, sheetDto.sheet_list[fmt[i].sheet_id].sheet_thum, fmt[i].changeable);

            //差し込み
            //if (fmt[i].insert != undefined && fmt[i].insert != null && fmt[i].insert.length != 0){
            if (fmt[i].insertions != undefined && fmt[i].insertions != null && fmt[i].insertions.length != 0){
                //for (var j in fmt[i].insert) {
                for(var j=0;j<fmt[i].insertions.length;j++){
                    var insTr = $('<tr>');
                    var insTh = $('<th>');
                    var insSubTbl = $('<table>');
                    var insTb = $('<tbody>');
                    insSubTbl.append(insTb);
                    insTh.append(insSubTbl);
                    insTr.append(insTh);
                    elem.append(insTr);
                    //PreviewInsertion(insTb, fmt[i].insert[j]);
                    PreviewInsertion(insTb, fmt[i].insertions[j]);
                }
            }
            //insLen = insLen + fmt[i].insert.length;
            insLen = insLen + fmt[i].insertions.length;
            if (th != null) {
                th.attr('rowspan', fmt.length + insLen).attr('width', CTRL_WIDTH);
            }


        }
    }
    $('#formFormatPreview a').colorbox();

}


/**
* 差し込みプレビュー
*/
function PreviewInsertion(elem, insertion) {

    var condTr = $('<tr>');
    var condTh = $('<th>');
    var condTdh = $('<td valign="top">');

    var idx = insertion.nid;
//  var imgPath = "/StoreOverlayImage?path=" + sheetDto.sheet_list[idx].thumnail;
    var imgPath = sheetDto.sheet_list[idx].sheet_thum;

    //condTh.attr("colspan", "2").attr('align', 'left').text(conditionMap[insertion.condition]);
    condTh.attr("colspan", "2").attr('align', 'left').text(conditionMap[insertion.insert_condition]);

    condTdh.width(CTRL_WIDTH);
    condTdh.append($("<img width='"+ CTRL_WIDTH + "'>").attr('src', "{!URLFOR($Resource.FormFormat,'img/arrow-key-down.png')}"));
    var data = $("<td>");

    elem.append(condTr.append(condTh));
    elem.append($('<tr>').append(condTdh, data));
    //addPreview(data, insertion.id.split('-').join('_'), insertion.name, sheetDto.sheet_list[idx].thumnail, insertion.changeable);
    addPreview(data, insertion.insert_sheet_id.split('-').join('_'), insertion.insert_sheet_name, sheetDto.sheet_list[idx].sheet_thum, insertion.changeable);

}

/**
* プレビュー画像表示
*/
function addPreview(td, id, name, thum, changeable) {
    //var imgPath = "/StoreOverlayImage?path=" + thum;
    var imgPath = thum;
    var pid = "prev_" + id;
    var tid="thum_" + id;


    td.addClass('sidePreview').append(div);
    var div =$('<div>');
    var imgBox = $('<a>').attr('href', imgPath).addClass("previewImg");
    imgBox.attr('id', pid);
    imgBox.click(function (){

        document.body.style.overflow="auto";
    });
    td.append(div.append(imgBox));
    loadImg2(pid, imgPath, tid);

    td.append("<br>" + name);
    if (changeable) {
        td.addClass('changeableSheet');
        div.css({"position":"relative"});
        var icon = $('<div>');
        icon.css({"position": "absolute"});
        icon.append("<img src=\'{!URLFOR($Resource.FormFormat,'img/Variable_form.png')}\' width='32px'>");
        div.append(icon);
    } else {
        td.addClass('fixedSheet');
        div.css({"position":"relative"});
        var icon = $('<div>');
        icon.css({"position": "absolute"});
        icon.append("<img src=\'{!URLFOR($Resource.FormFormat,'img/fixed_document.png')}\' width='32px'>");
        div.append(icon);
    }

}


/**
* プレビュー画像表示
*/
function loadImg2(id, imgPath, thum){
    var img = null;
    img = new Image();
    $(img).load();
    jQuery(img).load(function() {
        //読み込み完了時の処理
//      $("#" + id).html("");
        $("#" + thum).remove();


        if(document.getElementById(id) != null){
            document.getElementById(id).appendChild(img);
        }
        if($("#"+thum).width() <= $("#"+thum).height()){

            // 画像の表示maxサイズ
            var heightSize = 190;
            var widthSize = 180;

            // リサイズをしてもどちらか１辺でも基準より大きくなった際には基準サイズを小さくして再度リサイズ。条件を満たすまで続ける
            while(true){
                // 190はheightのmaxサイズなので、実画像のheightで割り拡大率を取得。
                // その拡大率を実画像のwidthで掛け、Math.roundで小数を丸め込み画像の表示サイズのwidthを取得し設定
                $("#"+thum).width(Math.round((190 / $("#"+thum).height()) * $("#"+thum).width()));
                // width設定後にheightを表示させるmaxサイズにて設定
                $("#"+thum).height(heightSize);
                if($("#"+thum).width() > 180){
                    // heightの方が長く、heightを基準にリサイズしたがwidthが指定以上になってしまった際には
                    // heightのmaxサイズを1ピクセル少なくし再設定
                    heightSize = heightSize - 1;
                }else{
                    // 表示サイズの条件を満たした際にbreakしwhileを抜ける
                    break;
                }
            }
        }else{
            // 画像の表示maxサイズ
            var heightSize = 190;
            var widthSize = 180;

            // リサイズをしてもどちらか１辺でも基準より大きくなった際には基準サイズを小さくして再度リサイズ。条件を満たすまで続ける
            while(true){
                // 180はwidthのmaxサイズなので、実画像のwidthで割り拡大率を取得。
                // その拡大率を実画像のheightで掛け、Math.roundで小数を丸め込み画像の表示サイズのheightを取得し設定
                $("#"+thum).height(Math.round((180 / $("#"+thum).width()) * $("#"+thum).height()));
                $("#"+thum).width(widthSize);
                if($("#"+thum).height() > 190){
                    // widthの方が長く、widthを基準にリサイズしたがheightが指定以上になってしまった際には
                    // widthのmaxサイズを1ピクセル少なくし再設定
                    widthSize = widthSize - 1;
                }else{
                    // 表示サイズの条件を満たした際にbreakしwhileを抜ける
                    break;
                }
            }
        }
    // .css(" -ms-interpolation-mode","bicubic")はIEで大きな画像を縮小表示を行うと画像が荒くなることがあるのでそれを防ぐ為に設定
    }).attr('src', imgPath).attr("id",thum).css(" -ms-interpolation-mode","bicubic").addClass('PrevImage');
}


/**
 * 帳票定義を削除する
 */
function asyncDeleteReportDefinition(){

    var callback = function (data) {

                    //CsoScript_loadingStop();

                    //WR本体の帳票定義IDを設定する
                    //formFormatDTO.objReportDefinition['{!$ObjectType.ReportDefinition__c.fields.WR_FormDefinitionId__c.Name}'] = data.formDefinitionid;


                    asyncDeleteSf(formFormatDTO);
                    asyncSaveWREvidence(formFormatDTO);
                };

    var callerror = function (data) {


                    if(data.status != 500){
                        var dataObj = JSON.parse(data.responseText);

                        if(dataObj.code == 'K14-0OES-WR-1000'){
                            asyncDeleteSf(formFormatDTO);
                            asyncSaveWREvidence(formFormatDTO);
                        }else{
                            CsoScript_loadingStop();
                            var message = dataObj.message;
                            message += '<br/>';
                            message += 'code:';
                            message += dataObj.code;
                            var messageArray = [];
                            messageArray.push(message);
                            var messageHtml = createMessageHtml(messageArray);

                            $('#jsPageMessagesCell').html(messageHtml);
                            $('#jsPageMessages').show();
                        }
                    }else{

                        var errMessageArray = [];
                        errMessageArray.push('{!$Label.msg_00136}');

                        var messageHtml = createMessageHtml(errMessageArray);

                        $('#jsPageMessagesCell').html(messageHtml);
                        $('#jsPageMessages').show();
                    }
                };


    var idsParam = [];
    var idMap = {};

    idMap['type'] = 'form';
    idMap['id'] = formFormatDTO.objReportDefinition['{!$ObjectType.ReportDefinition__c.fields.WR_FormDefinitionID__c.Name}'];

    idsParam.push(idMap);

    var d = JSON.stringify({
            'userid': USERNAME,
            'credential': CREDENTIAL,
            'ids': JSON.stringify(idsParam)
        });


    //CsoScript_loadingStart();


    //securePostAsyncSf('/rest/FormDefinitionDelete/p', d, callback, callerror);
    securePostAsyncSf('/rest/FormDefinitionDelete', d, callback,callerror);

}

/**
 * WR証跡を登録
 */
function asyncSaveWREvidence(dto){
　　　　Visualforce.remoting.Manager.invokeAction(
        '{!$RemoteAction.ReportDefinitionEditController.saveDelEvidence}'
        ,dto
        ,function(result, event){
            if(!result){
                //証跡登録に失敗
                var errMessageArray = [];
                errMessageArray.push('{!$Label.label_wr_evidence_00001}');
                var messageHtml = createMessageHtml(errMessageArray);
                $('#jsPageMessagesCell').html(messageHtml);
                $('#jsPageMessages').show();
            }
        }
        ,{escape: true}
    );
}

/**
 * 帳票定義を削除する
 */
function asyncDeleteSf(dto){

    Visualforce.remoting.Manager.invokeAction(
        '{!$RemoteAction.ReportDefinitionEditController.deleteReportDefinition}'
        ,dto
        ,function(result, event){

            if (event.status) {

                //グローバル変数に戻り値を格納する
                formFormatDTO = result;

                if(!formFormatDTO.errFlg){
                    top.location.href = '/{!$ObjectType.ReportDefinition__c}/o';
                    CsoScript_loadingStop();
                }else{
                    CsoScript_loadingStop();
                    formFormatDTO.errFlg = false;

                    var messageHtml = createMessageHtml(formFormatDTO.errMessageList);

                    $('#jsPageMessagesCell').html(messageHtml);
                    $('#jsPageMessages').show();
                }
            } else if (event.type === 'exception') {

                CsoScript_loadingStop();

                var message = event.message;

                var errMessageArray = [];
                errMessageArray.push(message);

                var messageHtml = createMessageHtml(errMessageArray);

                $('#jsPageMessagesCell').html(messageHtml);
                $('#jsPageMessages').show();

            } else {

                CsoScript_loadingStop();

                var message = event.message;

                var errMessageArray = [];
                errMessageArray.push(message);

                var messageHtml = createMessageHtml(errMessageArray);

                $('#jsPageMessagesCell').html(messageHtml);
                $('#jsPageMessages').show();

            }
        }
        ,{escape: true}
    );


}

function validateDelete(){

    asyncValidateDeleteSf(formFormatDTO);

}

/**
 * 帳票定義を削除する前にチェックする
 */
function asyncValidateDeleteSf(dto){

    CsoScript_loadingStart();

    Visualforce.remoting.Manager.invokeAction(
        '{!$RemoteAction.ReportDefinitionEditController.validateDeleteReportDef}'
        ,dto
        ,function(result, event){

            if (event.status) {

                //グローバル変数に戻り値を格納する
                formFormatDTO = result;

                if(!formFormatDTO.errFlg){
                    asyncDeleteReportDefinition();
                }else{
                    CsoScript_loadingStop();
                    formFormatDTO.errFlg = false;

                    var messageHtml = createMessageHtml(formFormatDTO.errMessageList);

                    $('#jsPageMessagesCell').html(messageHtml);
                    $('#jsPageMessages').show();
                }
            } else if (event.type === 'exception') {

                CsoScript_loadingStop();

                var message = event.message;

                var errMessageArray = [];
                errMessageArray.push(message);

                var messageHtml = createMessageHtml(errMessageArray);

                $('#jsPageMessagesCell').html(messageHtml);
                $('#jsPageMessages').show();

            } else {

                CsoScript_loadingStop();

                var message = event.message;

                var errMessageArray = [];
                errMessageArray.push(message);

                var messageHtml = createMessageHtml(errMessageArray);

                $('#jsPageMessagesCell').html(messageHtml);
                $('#jsPageMessages').show();

            }
        }
        ,{escape: true}
    );


}

var SFUSERID = '{!JSENCODE($User.Id)}';//18桁

/**
 * 現在の日付と時刻の文字列を取得する
 * yyyyMMddhh24missff
 */
function getStringDatetime(){

    var nowdate = new Date();

    var year = nowdate.getFullYear(); // 年
    var mon  = nowdate.getMonth() + 1; // 月
    var date = nowdate.getDate(); // 日
    var week = nowdate.getDay(); // 曜日
    var hour = nowdate.getHours(); // 時
    var min  = nowdate.getMinutes(); // 分
    var sec  = nowdate.getSeconds(); // 秒
    var msec = nowdate.getMilliseconds(); // ミリ秒

    var strDatetime = '';

    strDatetime += year;
    strDatetime += mon;
    strDatetime += date;
    strDatetime += week;
    strDatetime += hour;
    strDatetime += min;
    strDatetime += sec;
    strDatetime += msec;

    return strDatetime;
}

/**
 * 帳票定義をコピーする
 */
function confirmCopy(){
    var isCopy = confirm('{!$Label.msg_wr_copy_repdef_00001}');

    if(isCopy){
        copyFormFormat(formFormatDTO);
    }
}

/**
 * 帳票定義を新たに保存（WebReport本体側）
 */
function copyFormFormat(){

    var callback = function (data) {
        //WR本体の帳票定義IDを設定する
        formFormatDTO.objReportDefinition['{!$ObjectType.ReportDefinition__c.fields.WR_FormDefinitionId__c.Name}'] = data.formDefinitionid;
        //既存の帳票定義名にコピーを付ける
        var formDefName = '{!$Label.label_10228}' + '_';
        formDefName += formFormatDTO.objReportDefinition['{!$ObjectType.ReportDefinition__c.fields.Name.Name}'];
        formFormatDTO.objReportDefinition['{!$ObjectType.ReportDefinition__c.fields.Name.Name}'] = formDefName;
        asyncCopySf(formFormatDTO);
    };

    var callerror = function (data) {
        CsoScript_loadingStop();

        if(data.status != 500){
            var dataObj = JSON.parse(data.responseText);
            var message = '';
            if(dataObj.code == 'K39-FFIC-WR-0001'){
                message = '{!$Label.label_wf_29026}';
            }else{
                message = dataObj.message;
                message += '<br/>';
                message += 'code:';
                message += dataObj.code;
            }

            var messageArray = [];
            messageArray.push(message);

            var messageHtml = createMessageHtml(messageArray);

            $('#jsPageMessagesCell').html(messageHtml);
            $('#jsPageMessages').show();
        }else{
            var errMessageArray = [];
            errMessageArray.push('{!$Label.msg_00136}');

            var messageHtml = createMessageHtml(errMessageArray);

            $('#jsPageMessagesCell').html(messageHtml);
            $('#jsPageMessages').show();
        }
    };

    var sheetOrder = JSON.stringify(format);

    //WR本体側に登録する帳票定義名は、ユニークチェックがあるため、SFユーザIDと日付・時刻でユニークにする
    var formDefName = '{!$Label.label_10228}' + '_';
    formDefName += formFormatDTO.objReportDefinition['{!$ObjectType.ReportDefinition__c.fields.Name.Name}'];
    formDefName += SFUSERID;
    formDefName += getStringDatetime();

    var d = JSON.stringify({
            'formDifiId': '',
            'userid': USERNAME,
            'credential': CREDENTIAL,
            'dirid': 'root',
            'name': formDefName,
            'explanation': formFormatDTO.objReportDefinition['{!$ObjectType.ReportDefinition__c.fields.Explanation__c.Name}'],
            'ovl_id': formFormatDTO.objReportDefinition['{!$ObjectType.ReportDefinition__c.fields.OverlayIDID__c.Name}'],
            'ovl_ver': formFormatDTO.objReportDefinition['{!$ObjectType.ReportDefinition__c.fields.OverlayVersion__c.Name}'],
            'sheet_order': sheetOrder
        });

    CsoScript_loadingStart();
    securePostAsyncSf('/rest/FormDefinitionRegist', d, callback, callerror);
}

/**
 * 帳票定義のコピーを実施（SF側）
 */
function asyncCopySf(dto){

    Visualforce.remoting.Manager.invokeAction(
        '{!$RemoteAction.ReportDefinitionEditController.copyReportDefinition}'
        ,dto
        ,function(result, event){

            if (event.status) {

                //グローバル変数に戻り値を格納する
                formFormatDTO = result;

                if(!formFormatDTO.errFlg){
                    //遷移先を設定
                    copyId = formFormatDTO.objReportDefinition['{!$ObjectType.ReportDefinition__c.fields.Id.Name}'];
                    top.location.href = '{!$Page.ReportDefinitionEdit}?id='+copyId+'&retURL={!$Page.ReportDefinitionDetail}?id='+copyId;
                    CsoScript_loadingStop();
                }else{
                    CsoScript_loadingStop();
                    formFormatDTO.errFlg = false;

                    var messageHtml = createMessageHtml(formFormatDTO.errMessageList);
                    $('#jsPageMessagesCell').html(messageHtml);
                    $('#jsPageMessages').show();
                }
            } else {
                CsoScript_loadingStop();

                var message = event.message;
                var errMessageArray = [];
                errMessageArray.push(message);

                var messageHtml = createMessageHtml(errMessageArray);
                $('#jsPageMessagesCell').html(messageHtml);
                $('#jsPageMessages').show();
            }
        }
        ,{escape: true}
    );
}

</script>

<style type="text/css">

.uploadifyQueueItem {
    display: none;
}

.FormFormatCreateErrorMsg {
    background-color: #FFFF00;
    color: #FF0000;
    font-weight: bold;
    display: none;
}

.innerTable {
    margin-top: 5px;
    padding: 5px;
}

.innerTable th {
    text-align: right;
    font-weight: bold;
}

.innerTable td {
    border: none;
    padding: 5px;
}

.innerTable_middle {
    padding: 5px;
}

.innerTable_middle th {
    text-align: left;
    font-weight: bold;
}

.innerTable_middle td {
    border: none;
    padding: 5px;
}

.innerTable_down {
    margin: 0px 0px 10px 100px;
}

.innerTable_down th {
    text-align: right;
    font-weight: bold;
}

.innerTable_down td {
    border: none;
    padding: 5px;
}

.innerTable_Insertion {
    padding: 5px;
    border:1px;
}

.innerTable_Insertion th {
    text-align: left;
    font-weight: bold;
}

.innerTable_Insertion td {
    padding: 5px;
}

.separatorDiv{
    width: 100%;
    /*background-color:#7FFFD4;*/
}

.separatorDiv div{
    color: white;
    padding: 3px 0px 3px 5px;
    font-weight: bold;
}
.searchTbl th{
    text-align: right;
    width: 80px;
    font-weight: bold;
}

 table.selectedTable{
    border:1px solid #887f7a;
    border-collapse:collapse;
    border-spacing:0;
    empty-cells:show;
    background-color:white;
}
.selectedTable th{
    border:1px solid #887f7a;
    color:#330000;
    background-color:#84a2d4;
    background-position:left top;
    padding:2px 2px;
    text-align:center;
}
.selectedTable td{
    border:1px solid #887f7a;
    padding:2px 2px;
    white-space:nowrap;
}

.selected {
    cursor: url("{!URLFOR($Resource.FormFormat,'img/cursor_drag_hand.cur')}"),default;
    background-color : #a2d7dd;
}

.insertionSheet {
    margin-left: 0;
    padding-left: 0;
}
.insertionSheet li{
    margin-left: 0;
    padding-left: 0;
    list-style-position:outside;
    list-style-type: none;
 }
 .insertionSheet input {
    margin-right: 5px;
    margin-left: 5px;
 }

.PrevImage {
    border: 1px gray solid;
}

.previewTable {
    border-spacing: 5px 10px;
}

#sidePreviewBody td {
    text-align: center;
    border: 1px black solid;
    padding-top: 10px;
}

.ui-tabs {
    background : none;
    border:none;
}

.ui-tabs .ui-tabs-nav {
    background: none;
    border:none;
}

.ui-tabs .ui-tabs-panel {
    background : none;
    border:2px solid #11579c;
    hight:100%
}

.ui-widget-header .ui-state-default {
    background : none;
    border: 2px solid #DFEFFC;

}

.ui-tabs .ui-tabs-nav li.ui-tabs-selected {
    background: #11579c;
    border: 1px solid #11579c;

}

.ui-tabs .ui-tabs-nav li.ui-tabs-selected a{
    color: #FFFFFF;
    font-weight: bold;
}

.ui-corner-all {
    border-radius: 5px 5px 5px 5px;

}

.row {
    border-style: none !important;
}

td.showDragHandle {
    background-image: url("{!URLFOR($Resource.FormFormat,'img/data_sort.png')}");
    background-repeat: no-repeat;
    background-position: center center;
}

td.sheetname {
    padding-left: 19px;
}

td.rowhandler {
    cursor: url("{!URLFOR($Resource.FormFormat,'img/cursor_hand.cur')}"),default;
}

td.dragActive {
    cursor: url("{!URLFOR($Resource.FormFormat,'img/cursor_drag_hand.cur')}"),default;
}

.controlCell {
    width:90px;
    min-width: 90px;
}

.sortCell {
    width:50px;
    min-width: 50px;
    }
.buttonFont {
}
</style>

                        <div class="innerHtmlHeader">
                            <div style="float: left;">
                            <!--
                                <img height="38px" width="38px" style="margin-right: 10px;" src="{!URLFOR($Resource.FormFormat,'img/manager/formFormat.png')}" alt="person"/>
                             -->
                                <!-- SFのアイコンを表示する -->
                                <img height="38px" width="38px" style="margin-right: 10px;" src="/img/icon/lightning32.png" alt="person"/>
                            </div>
                            <div style="float: left;">
                                <div style="position: absolute;">{!$Label.label_wf_50012}</div>
                                <div style="font-size: 16px; margin-top: 20px; font-weight: bold;">{!rd.Name}</div>

                            </div>

                            <div style="float: right; margin-top: 10px;">

                            </div>
                        </div>
<!-- apex:form START -->
                        <apex:form id="form">

                            <div>
                                <apex:pageMessages id="sfPageMessages"/>
                            </div>
                            <div id="jsPageMessages" style="display:none;">
                                <span id="j_id0:j_id20">
                                    <span id="j_id0:j_id20:j_id21:j_id22:0:j_id23">
                                        <div class="message errorM3">
                                            <table border="0" cellpadding="0" cellspacing="0" class="messageTable" style="padding:0px;margin:0px;">
                                                <tr valign="top">
                                                    <td>
                                                        <img alt="ERROR" class="msgIcon" src="/s.gif" title="ERROR" />
                                                    </td>
                                                    <td id="jsPageMessagesCell" class="messageCell"><div id="j_id0:j_id20:j_id21:j_id22:0:j_id23:j_id24:j_id26" class="messageText"><span id="j_id0:j_id20:j_id21:j_id22:0:j_id23:j_id24:j_id27" style="color:#cc0000">
                                                        <h4>&#12456;&#12521;&#12540;:</h4></span>&#36984;&#25246;&#12373;&#12428;&#12390;&#12356;&#12427;&#12458;&#12502;&#12472;&#12455;&#12463;&#12488;&#21448;&#12399;&#38917;&#30446;&#12395;&#12450;&#12463;&#12475;&#12473;&#27177;&#12364;&#12394;&#12356;&#12383;&#12417;&#12289;&#20351;&#29992;&#12391;&#12365;&#12414;&#12379;&#12435;&#12290;<br /></div>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td></td>
                                                    <td></td>
                                                </tr>
                                            </table>
                                        </div>
                                    </span>
                                </span>
                            </div>

                            <apex:pageBlock id="block" title="" mode="detail" tabStyle="ReportDefinition__c">

                                <apex:pageBlockButtons id="buttons" location="top">

                                    <input type="button" onclick="window.open('{!$Page.ReportDefinitionEdit}?id={!rd.Id}&retURL={!$Page.ReportDefinitionDetail}?id={!rd.Id}', '_self');" style="margin-left: 5px;" class="btn" value="{!$Label.label_wf_00121}" name="editBtn" id="editBtn"/>
                                    <input type="button" id="delReportDefinitionBtn" style="margin-left: 5px;" class="btn" value="{!$Label.label_wf_00031}" name="delBtn" onclick="/*asyncDeleteReportDefinition();*/validateDelete();"/>
                                    <input type="button" id="shareBtn" name="shareBtn" style="margin-left: 5px;" class="btn" value="{!$Label.label_wf_00122}" onclick="window.open('/p/share/CustomObjectSharingDetail?parentId={!rd.id}&retURL={!$Page.ReportDefinitionDetail}?id={!rd.Id}','_self');"/>
                                    <input type="button" id="copyBtn" name="copyBtn" style="margin-left: 5px;" class="btn" value="{!$Label.label_10228}" onclick="confirmCopy();" />
                                    <input type="button" id="calcelBtn" name="calcelBtn" style="margin-left: 5px;" class="btn" value="{!$Label.label_wf_00021}" onclick="back(); return false;"/>

                                </apex:pageBlockButtons>

                                <div style="min-height: 800px;/*background-color:#f2f2f3;*/" id="tabs" class="ui-tabs ui-widget ui-widget-content ui-corner-all">
                                    <ul id="tabLink" class="ui-tabs-nav ui-helper-reset ui-helper-clearfix ui-widget-header ui-corner-all">
                                        <li id="tabLinkMain" class="ui-state-default ui-corner-top ui-tabs-selected ui-state-active"><a href="#" onclick="hideShowTabMain();">{!$Label.solxyzcso001__label_wf_00130}</a></li>
                                        <li id="tabLinkSheet" class="ui-state-default ui-corner-top"><a href="#" onclick="hideShowTabSheet();">{!$Label.label_wf_29009}</a></li>
                                        <li id="tabLinkMapping" class="ui-state-default ui-corner-top"><a href="#" onclick="hideShowTabMapping();">{!$Label.label_wf_29010}</a></li>
                                        <li id="tabLinkSecurity" class="ui-state-default ui-corner-top"><a href="#" onclick="hideShowTabSecurity();">{!$Label.label_wf_30072}</a></li>
                                        <li id="tabLinkHistory" class="ui-state-default ui-corner-top"><a href="#" onclick="hideShowTabHistory();">{!$Label.solxyzcso001__label_10039}</a></li>
                                    </ul>
<!-- 基本タブ START -->
                                    <div id="FFRegistMain" style="overflow: auto; height: 730px;" class="ui-tabs-panel ui-widget-content ui-corner-bottom">

                                        <apex:pageBlockSection showHeader="false" title="{!$Label.solxyzcso001__label_wf_00130}" columns="1" id="sectionbase" collapsible="false" >
                                            <apex:pageBlockSectionItem >

                                                <apex:outputLabel value="{!$Label.solxyzcso001__label_wf_00006}" />

                                                <apex:outputPanel >
                                                <!--
                                                <div class="requiredInput">
                                                <div class="requiredBlock"></div>
                                                 -->
                                                <apex:outputField id="formatName" value="{!rd.Name}" style="width:300px;" />
                                                <!--
                                                </div>
                                                 -->
                                                </apex:outputPanel>

                                            </apex:pageBlockSectionItem>
                                            <apex:pageblocksectionItem >
                                                <apex:outputlabel value="{!$Label.solxyzcso001__label_wf_00007}"/>
                                                <apex:outputpanel >
                                                <!--
                                                    <div id="explanationRemainder" style="height: 1em; padding-bottom: 0.1em;padding-top: 0.5em;text-align:right; width:300px;">残り512文字</div>
                                                 -->
                                                    <apex:inputTextarea id="explanation" readonly="true" style="width: 300px; height: 100px; max-height:100px; max-width:300px; min-height:100px; min-width:300px;" value="{!rd.SOLXYZCSO001__Explanation__c}" rendered="{!$ObjectType.SOLXYZCSO001__ReportDefinition__c.fields.SOLXYZCSO001__Explanation__c.Accessible}"/>
                                                </apex:outputpanel>
                                            </apex:pageblocksectionItem>

                                            <apex:pageBlockSectionItem id="section_item1">

                                                <apex:outputLabel value="{!$Label.solxyzcso001__label_wf_00002}" />

                                                <apex:outputPanel >

                                                    <div id="overlayfile_container" class="requiredInput">
                                                    <!--
                                                        <div class="requiredBlock"></div>
                                                     -->
                                                    <!--
                                                        <apex:inputText value="{!rd.SOLXYZCSO001__OverlayID__c}" style="width:300px;" id="overlayText" required="true" maxlength="0" disabled="true" rendered="{!$ObjectType.ReportDefinition__c.fields.OverlayID__c.Accessible}"/>
                                                     -->
                                                    <!--
                                                        <input type="text" id="overlayText" value="{!rd.SOLXYZCSO001__OverlayID__c}" readonly="readonly" style="width:300px;"/>
                                                     -->
                                                        <apex:outputField value="{!rd.SOLXYZCSO001__OverlayID__c}" />
                                                        <apex:outputLabel value="({!$Label.solxyzcso001__label_wf_00008} {!rd.SOLXYZCSO001__OverlayVersion__c})" />
                                                    <!--
                                                        <apex:actionFunction action="{!mappingcls.inputChange}"  name="overlayMapFirst" status="StatusreadOnly" immediate="false" rerender="form" />
                                                     -->
                                                        <input id="fixedKomoku" type="hidden" value="" />

                                                        <input id="detailKomoku" type="hidden" value="" />

                                                        <input id="thum" type="hidden" value="" />
                                                        <apex:inputHidden id="rOverlayId" value="{!rd.SOLXYZCSO001__OverlayIDID__c}" rendered="{!$ObjectType.SOLXYZCSO001__ReportDefinition__c.fields.SOLXYZCSO001__OverlayIDID__c.Accessible}"/>
                                                        <apex:inputhidden id="rOverlayVersion" value="{!rd.SOLXYZCSO001__OverlayVersion__c}" rendered="{!$ObjectType.SOLXYZCSO001__ReportDefinition__c.fields.SOLXYZCSO001__OverlayVersion__c.Accessible}"/>
                                                    <!-- 2013.01.11 地図情報追加 -->

                                                        <input id="fixedMap" type="hidden" value="" />

                                                        <input id="detailMap" type="hidden" value="" />

                                                    </div>

                                                </apex:outputPanel>


                                            </apex:pageBlockSectionItem>

                                            <apex:pageBlockSectionItem >

                                                <apex:outputLabel value="{!$Label.solxyzcso001__label_wf_00050}"  />

                                                <apex:outputPanel >
                                                    <div id="overlayfile_container" class="requiredInput">
                                                    <!--
                                                        <div class="requiredBlock"></div>
                                                     -->
                                                    <!--
                                                        <input type="text" id="reportOutText" readonly="readonly" value="{!rd.SOLXYZCSO001__ObjectLabel__c}" onchange="inputObjectChange();" style="width:300px;"/>
                                                     -->
                                                        <apex:outputField id="reportOutText" value="{!rd.SOLXYZCSO001__ObjectLabel__c}" />
                                                    <!--
                                                        <apex:actionFunction action="{!mappingcls.inputChange}"  name="inputObjectChange" status="StatusreadOnly" immediate="false" rerender="form" />
                                                     -->

                                                        <apex:inputHidden id="reportOutText_lkid" value="{!rd.SOLXYZCSO001__ObjectID__c}" rendered="{!$ObjectType.SOLXYZCSO001__ReportDefinition__c.fields.SOLXYZCSO001__ObjectID__c.Accessible}"/>

                                                        <!--
                                                        <input value="{!$Label.label_wf_00029}"  class="btn" title="{!$Label.label_wf_00132}" name="reportOutput" onclick="searchObject();" type="button" />
                                                         -->
                                                    </div>


                                                </apex:outputPanel>

                                            </apex:pageBlockSectionItem>
                                        </apex:pageBlockSection>

                                    <apex:pageBlockSection title="{!$Label.solxyzcso001__label_wf_00442}" columns="1" id="sectionK" collapsible="false">
                                        <apex:pageblocksectionItem >
                                            <apex:outputtext value="" />
                                            <apex:outputPanel >
                                                <table>
                                                    <apex:repeat value="{!activeOptions}" var="actList">
                                                        <tr>
                                                            <td>
                                                                <apex:outputText value="{!actList.label}"/>
                                                            </td>
                                                        </tr>
                                                    </apex:repeat>
                                                </table>
                                            </apex:outputPanel>
                                        </apex:pageblocksectionItem>
                                    </apex:pageBlockSection>

                                        <apex:pageBlockSection title="{!$Label.solxyzcso001__label_wf_29049}" columns="1" collapsible="false" id="ecmImage">

                                            <apex:pageBlocksectionItem rendered="{!rd.SOLXYZCSO001__ECMImageFlg__c}">
                                                <img src="/img/checkbox_checked.gif"/>
                                                <apex:outputLabel value="{!$Label.solxyzcso001__label_wf_29012}"/>
                                            </apex:pageBlocksectionItem>

                                            <apex:pageBlocksectionItem rendered="{!NOT(rd.SOLXYZCSO001__ECMImageFlg__c)}">
                                                <img src="/img/checkbox_unchecked.gif"/>
                                                <apex:outputLabel value="{!$Label.solxyzcso001__label_wf_29012}"/>
                                            </apex:pageBlocksectionItem>
                                        </apex:pageBlockSection>

                                        <apex:pageBlockSection title="{!$Label.solxyzcso001__label_wf_30076}" columns="1" collapsible="false" rendered="{!categoryList.size > 0}">

                                                <apex:repeat value="{!categoryList}" var="category">


                                                    <apex:pageBlockSectionItem rendered="{!category.isMulti}">

                                                            <apex:outputLabel value="{!category.fieldLabel}" />
                                                            <apex:outputText >
                                                                <apex:repeat var="catV" value="{!category.categoryOptions}">
                                                                    <apex:variable var="flg" value="false"/>
                                                                    <apex:repeat var="catS" value="{!category.selectedValueList}">

                                                                        <apex:outputText rendered="{!catS==catV.value}">
                                                                            <img src="/img/checkbox_checked.gif"/>
                                                                            <apex:outputText value="{!catV.label}" />
                                                                            <apex:variable var="flg" value="true" />
                                                                        </apex:outputText>

                                                                    </apex:repeat>

                                                                    <apex:outputText rendered="{!flg=='false'}">
                                                                        <img src="/img/checkbox_unchecked.gif"/>
                                                                        <apex:outputText value="{!catV.label}" />
                                                                    </apex:outputText>
                                                                    <apex:variable var="flg" value="false"/>
                                                                </apex:repeat>
                                                            </apex:outputText>

                                                    </apex:pageBlockSectionItem>
                                                    <apex:pageBlockSectionItem rendered="{!NOT(category.isMulti)}">

                                                            <apex:outputLabel value="{!category.fieldLabel}" />
                                                            <apex:outputText value="{!category.selectedValueLabel}"/>

                                                    </apex:pageBlockSectionItem>

                                                </apex:repeat>
                                        </apex:pageBlockSection>

                                    </div>
<!-- 基本タブ END -->
<!-- 出力シート順タブ START -->
                                    <div id="tabFormatSetting" class="ui-tabs-panel ui-widget-content ui-corner-bottom" style="overflow: auto; height: 730px;">
                                        <table class="innerTable" cellpadding="7">
                                            <tbody>
                                                <tr>
                                                    <td colspan="4">
                                                        <table class="innerTable_middle">
                                                            <tbody>
                                                                <tr>
                                                                    <th>{!$Label.label_wf_29013}</th>
                                                                    <th></th>
                                                                    <th>{!$Label.label_wf_29014}</th>
                                                                    <th style="text-align: right;">
                                                                    <!--
                                                                        <button type="button" id="allClear">
                                                                            <span class="buttonFont">クリア</span>
                                                                        </button>
                                                                     -->
                                                                    </th>
                                                                </tr>
                                                                <tr>
                                                                    <td valign="top">
                                                                        <select id="SelectableSheet" style="width:100px" size="10" disabled="disabled">

                                                                        </select>
                                                                    </td>
                                                                    <td valign="top" align="center">
                                                                        <table height="150px">
                                                                            <tbody>
                                                                                <tr>
                                                                                    <td valign="middle" align="center">
                                                                                    <!--
                                                                                        <button type="button" id="addSingleButton">

                                                                                             <span class="buttonFont">>></span>

                                                                                        </button>
                                                                                         -->

                                                                                    </td>
                                                                                </tr>
                                                                            </tbody>
                                                                        </table>
                                                                    </td>
                                                                    <td valign="top" colspan="2">
                                                                        <div id="drag">
                                                                            <table id="selectedTable" class="selectedTable treeTable">
                                                                                <thead>
                                                                                    <tr class="mark">
                                                                                    <!--
                                                                                        <th class="mark sortCell" nowrap="">並替</th>
                                                                                        <th class="mark controlCell"></th>
                                                                                     -->
                                                                                        <th class="mark" width="200">{!$Label.label_wf_29016}</th>
                                                                                        <th class="mark" width="300">{!$Label.label_wf_29017}</th>
                                                                                    </tr>
                                                                                </thead>
                                                                                <tbody id="rows" class="selectable">

                                                                                </tbody>
                                                                                <tfoot>
                                                                                    <tr class="mark">
                                                                                    <!--
                                                                                        <th class="mark sortCell" nowrap="">並替</th>
                                                                                        <th class="mark controlCell"></th>
                                                                                     -->
                                                                                        <th class="mark" width="200">{!$Label.label_wf_29016}</th>
                                                                                        <th class="mark" width="300">{!$Label.label_wf_29017}</th>
                                                                                    </tr>
                                                                                </tfoot>
                                                                            </table>
                                                                        </div>
                                                                    </td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
<!-- 出力シート順タブ END -->
<!-- マッピングタブ START -->
<style type="text/css">
.drags {
    background-color: #ddd;
    background-image: url(/img/ple/compbg.gif);
    background-position: left center;
    background-repeat: repeat-x;
    color: #333;
    font-weight: bold;
    border: 1px solid #9daab2;
    cursor: pointer;
    text-indent: 4px;
    /*width   : 100px   ;*/
    /*height  : 10px   ;*/
    /*padding : 10px    ;*/

    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    -webkit-text-overflow: ellipsis;
    -o-text-overflow: ellipsis;
}

.dropInput {

    width   : 86px;
    padding : 5px;
    display:inline-block;

    background: none repeat scroll 0 0 #EEF2F7;
    border: 2px dashed #CCCCCC;
    border-radius: 6px 6px 6px 6px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);

    /*margin: 2px;*/
    vertical-align: middle;
}


.dropInputed {
    width   : 100px   ;

    /*padding : 5px    ;*/
    display:inline-block;

    /*background-color: #ddd;
    background-image: url(/img/ple/compbg.gif);
    background-position: left center;
    background-repeat: repeat-x;
    color: #333;*/
    /*font-weight: bold;*/
    /*margin:1px;*/
    /*border: 1px solid #9daab2;
    cursor: pointer;*/
    /*text-indent: 4px;*/

    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    -webkit-text-overflow: ellipsis;
    -o-text-overflow: ellipsis;
    vertical-align: middle;
}

.dropArea{
    /*width   : 100px   ; */
    /*height  : 70px   ;*/
    /*padding : 10px    ; */

}

.drops{
    /*height:50px;*/
    /*width:150px;*/
    /*display:inline-block;*/
    /*margin-top:10px;*/
    /*padding-top:15px;*/
}

.breadcrumbs{
/*width:100px;*/
display:inline-block;
/*white-space: nowrap;*/
/*overflow: hidden;*/
/*text-overflow: ellipsis;*/
/*-webkit-text-overflow: ellipsis;*/
/*-o-text-overflow: ellipsis;*/
    /*margin-top:10px;*/
    /*padding-top:15px;*/
padding-top:20px;
}
/*
body,div,pre,p,blockquote,
form,
dl,dt,dd,ul,ol,li,h1,h2,h3,h4,h5,h6,
embed,object {
    margin: 0;
    padding: 0;
    vertical-align: baseline;
    font-size: 100.01%;
}


body {
    background: #eee;
    color: #333333;
    font: 16px/1.7 Arial, Helvetica, sans-serif;
}
*/
h1 {
    font-size: 200%;
    text-align: center;
    padding: 20px;
}
h1 a {
    color: #444;
    text-decoration: none;
}
h1 a:hover {
    color: #888;
    text-decoration: underline;
}
h2 {
    font-size: 200%;
    margin-bottom: 0.5em;
}
p {
    margin-bottom: 1em;
}
.clearfix:before,
.clearfix:after {
    content:"";
    display:table;
}
.clearfix:after {
    clear:both;
}
.clearfix {
    zoom:1;
}

#article {
    /*background: #fff;*/
    padding: 60px;
    /*height: 2000px;*/
    margin: 0 auto 60px;
    /*width: 680px;*/
}

.nav {
    padding: 0 20px;
    margin: 0 auto 60px;
    /*width: 760px;*/
    font-size: 85%;
    border-radius: 5px;
    -webkit-border-radius: 5px;
    -moz-border-radius: 5px;
    /*background: #333;*/
    /*background: blue;*/
    background: #53A0EC;
    background: -moz-linear-gradient(top, #666, #53A0EC);
    background: -webkit-gradient(linear, left top, left bottom, from(#666), to(#53A0EC));
    background: -o-linear-gradient(top, #666, #53A0EC);
    -webkit-box-shadow: 0px 3px 5px 0px rgba(0,0,0,0.3);
    -moz-box-shadow: 0px 3px 5px 0px rgba(0,0,0,0.3);
    box-shadow: 0px 3px 5px 0px rgba(0,0,0,0.3);
}
.nav li {
    list-style: none;
    float: left;
}
.nav li a {
    text-decoration: none;
    color: #fff;
    padding: 8px 12px;
    display: block;
    width: 100px;
}
.nav li a:hover {
    /*background: #666;*/
    background: #53A0EC;
}
/* サブナビゲーション */
.nav li ul {
    display: none;
    position: absolute;
    font-size: 85%;
    -webkit-border-bottom-right-radius: 5px;
    -webkit-border-bottom-left-radius: 5px;
    -moz-border-radius-bottomright: 5px;
    -moz-border-radius-bottomleft: 5px;
    border-bottom-right-radius: 5px;
    border-bottom-left-radius: 5px;
    -webkit-box-shadow: 0px 3px 5px 0px rgba(0,0,0,0.3);
    -moz-box-shadow: 0px 3px 5px 0px rgba(0,0,0,0.3);
    box-shadow: 0px 3px 5px 0px rgba(0,0,0,0.3);
}
.nav li ul li {
    float: none;
}
.nav li ul li a {
    /*background: #444;*/
    background: #53A0EC;
}
.nav li ul li:last-child a {
    -webkit-border-bottom-right-radius: 5px;
    -webkit-border-bottom-left-radius: 5px;
    -moz-border-radius-bottomright: 5px;
    -moz-border-radius-bottomleft: 5px;
    border-bottom-right-radius: 5px;
    border-bottom-left-radius: 5px;
}

.fixed {
    position: fixed;
    /*top: 0;*/
    top: 0px;
    /*left: 100;*/
    left: 300px;
    /*width: 100%;*/
    /*min-width : 720px;*/
    border-radius: 0;
    -webkit-border-radius: 0;
    -moz-border-radius: 0;
    -o-border-radius: 0;
}
li {
margin: 5px;
}

ul.jquery-menu {
}
ul.jquery-menu li {
    list-style-type: square;
}
ul.jquery-menu-sub {
    display: none;
}
ul.jquery-menu-sub li {
    list-style-type: square;
}


.nav2 {
    padding: 0 20px;
    margin: 0 auto 60px;
    /*width: 760px;*/
    font-size: 85%;
    border-radius: 5px;
    -webkit-border-radius: 5px;
    -moz-border-radius: 5px;
    /*background: #333;*/
    /*background: blue;*/
    background: #53A0EC;
    background: -moz-linear-gradient(top, #666, blue);
    background: -webkit-gradient(linear, left top, left bottom, from(#666), to(#53A0EC));
    background: -o-linear-gradient(top, #666, #53A0EC);
    -webkit-box-shadow: 0px 3px 5px 0px rgba(0,0,0,0.3);
    -moz-box-shadow: 0px 3px 5px 0px rgba(0,0,0,0.3);
    box-shadow: 0px 3px 5px 0px rgba(0,0,0,0.3);
}

.scrollOn{
    overflow-x:scroll;
    overflow-y:hidden;
}


span.tooltip{
/*color:#fff;*/
color:black;
width:200px;
/*background:#FF9900;*/
background:#87CEEB;
border:2px solid white;
padding:1em;
font-size:small;
zIndex:1000;
word-break: break-all;
}

#mappingTable {
    width:100%;
}

#mappingTable tbody tr td{
    vertical-align:middle;
    height:30px;
    word-break: break-all;
}


#mapsMappingTable {
    width:100%;
}

#mapsMappingTable tbody tr td{
    vertical-align:middle;
    height:30px;
    word-break: break-all;
}
</style>
<script type="text/javascript">


/**
 * jQueryのセレクターを生成する
 */
function esc(myid) {
    return '#' + myid.replace(/(:|\.)/g,'\\\\$1');
}

/**
 * draggableを設定する
 */
function createDraggable(){

    $('.drags').draggable(
        {
            cursor: 'pointer'
            /*, cursorAt: {top: 20,left: 90}*/
            ,absolutePosition:{top:20,left:90}
            ,cancel: false
            ,revert: 'invalid'
            ,helper:'clone'
            ,opacity:0.5
            /*,scroll:false*/
            ,zIndex:999
            ,drag:function(e,ui){}
            ,stop:function(e,ui){}
        }
    );

    $("span.tooltip").css({
        opacity:"0.8",
        position:"absolute",
        display:"none"
    });
    $(".drags").mouseover(function(){
        //$(this).next("span.tooltip").fadeIn();


        //$(this).next("span.tooltip").fadeIn();
        var h = '';
        h = $(this).next('span.tooltip').html();

        if(h != '' && h != undefined && h != null){
            $('#hiddentooltip').html(h);
            //$('#hiddentooltip').delay(3000).fadeIn('slow');
            $('#hiddentooltip').fadeIn('slow');
        }

    }).mouseout(function(){
        //$(this).next("span.tooltip").fadeOut()
        //$(this).next("span.tooltip").hide();
        //$(this).next('span.tooltip').fadeOut();
        //$('#hiddentooltip').html($(this).next('span.tooltip').html());
        //$('#hiddentooltip').fadeOut();
        $('#hiddentooltip').hide();
        //$('#hiddentooltip').dequeue();
        //$('#hiddentooltip').dequeue();

        }).mousemove(function(e){
        //$(this).next("span.tooltip").css({
         $('#hiddentooltip').css({
        //"top":e.pageY/30+15+"px",
        "top":e.pageY-200+"px",
        //"top":50+"px",
        "left":e.pageX-290+"px"
        //"top":50+"px",
        //"left":15+"px"
        })


    });

    $('#divDrags').mouseout(function(){
         $('#hiddentooltip').clearQueue();
         $("#hiddentooltip").css({
            opacity:"0.8",
            position:"absolute",
            display:"none"
        });
    });
}

/**
 * droppableを設定する
 */
function createDroppable(){

    //動的に作成したdroppableにドロップできなくなるため、初期化する
    $('.drops').droppable('destroy');
    $('.notdrops').droppable('destroy');

    $('.drops').droppable({
        accept : ".drags",
        //containment : ".dropArea",
        //containment : "parent",
        //containment : "document",
        //scroll : false,
        drop : function(ev,ui){



                    //ドラッグ要素のIDを保持する
                    var dragId = ui.draggable.attr('id');
                    var dragE = $(esc(dragId));

                    //ドロップ要素
                    var dropE = $(this);

                    dropMapping(dragId,dragE,dropE);

                },
         stop : function(ev,ui){


                }
    });


    $('.notdrops').droppable({
        accept : ".drags",
        drop : function(ev,ui){
                    //何もしない

                }
    });

    $("span.tooltip").css({
        opacity:"0.8",
        position:"absolute",
        display:"none"
    });
    $(".drops").mouseover(function(){
        if($(this).children('span').text() != 'drop!!'){
            //$(this).next("span.tooltip").delay(600).show();
            $('#hiddentooltip2').html($(this).next('span.tooltip').html());
            $('#hiddentooltip2').delay(3000).fadeIn('slow');
        }
    }).mouseout(function(){
        //$(this).next("span.tooltip").hide();
        $('#hiddentooltip2').hide();

    }).mousemove(function(e){
        //$(this).next("span.tooltip").css({
        $("#hiddentooltip2").css({
            "top":e.pageY-215+"px",
            "left":e.pageX-215+"px"
            //"top":300+"px",
            //"left":515+"px"
        })
    });

    $('#mappingTable').mouseout(function(){
        $('#hiddentooltip2').clearQueue();
    });

    $(".breadcrumbs").mouseover(function(){

        if($(this).text() != ''){
            //$(this).next("span.tooltip").delay(600).show();
            $('#hiddentooltip2').html($(this).html());
            $('#hiddentooltip2').delay(3000).fadeIn('slow');
        }

    }).mouseout(function(){

        //$(this).next("span.tooltip").hide();
        $('#hiddentooltip2').hide();

    }).mousemove(function(e){
        //$(this).next("span.tooltip").css({
        $("#hiddentooltip2").css({
            "top":e.pageY-215+"px",
            "left":e.pageX-215+"px"
            //"top":300+"px",
            //"left":515+"px"
        })
    });
}

function dropMapping(dragId,dragE,dropE){

    var objReportMapping = {};

    //ドラッグ要素のIDを保持する
    //var dragId = ui.draggable.attr('id');
    //var dragE = $(esc(dragId));

    //ドロップ要素
    //var dropE = $(this);

    dropE.children('span').text(dragE.text());
    dropE.children('span').removeClass('dropInput').addClass('dropInputed');

    var t = '{!$Label.label_wf_29018}';
    t += dragE.text();
    //t += dragObjectMap[dragId].label;
    t += '<br />';
    t += '{!$Label.label_wf_29019}';
    //t += dragE.attr('data-name');
    t += dragObjectMap[dragId].name;

    dropE.next('span').html(t);

    if(dragE.attr('data-name') == 'datetimeToday'){

        dropE.parent('td').prev('td').text('');
        dropE.parent('td').next('td').children().remove();

        //初期値を設定する
        objReportMapping['{!$ObjectType.ReportMapping__c.fields.USERINPUTFLG__C.Name}'] = true;

    }else if(dragE.attr('data-name') == 'userInput'){

        dropE.parent('td').prev('td').text('');
        dropE.parent('td').next('td').children().remove();

        //ユーザ入力項目の場合は、インプットフィールドとチェックボックスを表示する
        dropE.parent('td').next('td').append('<input id=\"userInputField\" type=\"input\" value=\"\"/><input id=\"userInputRequiredFlg\" type=\"checkbox\" ><label>{!$Label.label_wf_00142}</label>');

        //初期値を設定する
        objReportMapping['{!$ObjectType.ReportMapping__c.fields.USERINPUTFLG__C.Name}'] = true;
        objReportMapping['{!$ObjectType.ReportMapping__c.fields.USERINPUTREQUIREDFLG__C.Name}'] = false;

        //選択リストにonchangeイベントを付与する
        onchangeUserInputField();
        //チェックボックスにonchangeイベントを付与する
        onchangeUserInputFlg();

    }else if(dragE.attr('data-name') == 'estimateNumber'){

        dropE.parent('td').prev('td').text('');
        dropE.parent('td').next('td').children().remove();

        //自動採番項目の場合は、選択リストを表示する
        var appendHtml = '<select id=\"estimateNumber\" value=\"\" >';
        appendHtml += EstimateNumberingOptionsAppendHtml;
        appendHtml += '</select>';
        dropE.parent('td').next('td').append(appendHtml);

        //選択リストにonchangeイベントを付与する
        onchangeEstimateNumber();

    }else{

        dropE.parent('td').prev('td').text('');
        dropE.parent('td').next('td').children().remove();

        //SFオブジェクト項目の場合は、パンくずリストを表示する
        var relLabel = '';

        relLabel += dragTrackMap[dragE.attr('data-parentId')].relBreadcrumbsLabel;
        relLabel += '>';

        relLabel += dragE.text();

        //オブジェクト欄に表示するパンくずリストを設定する
        dropE.parent('td').prev('td').text(relLabel);
    }

    //明細ソート項目の選択リストを活性化する
    dropE.parent('td').prev('td').prev('td').prev('td').prev('td').children('select').attr('disabled',false);
    dropE.parent('td').prev('td').prev('td').prev('td').children('select').attr('disabled',false);


    //オーバレイ項目ID
    var strOverlayColumnID = dropE.parent('td').prev('td').prev('td').text();

    var indexOverlayColumnID = strOverlayColumnID.toLowerCase();

    if(indexOverlayColumnID.lastIndexOf('*')>0){
        indexOverlayColumnID = indexOverlayColumnID.replace('*','');
    }


    //親のマッピングレコードを取得する
    overlayColumnIDMap[indexOverlayColumnID].reportMappingList
        = $.extend(true,[],dragTrackMap[dragE.attr('data-parentId')].reportMappingList);



    //var objReportMapping = {};

    objReportMapping['{!$ObjectType.ReportMapping__c.fields.attributetype__c.Name}'] = dragObjectMap[dragId].type;
    objReportMapping['{!$ObjectType.ReportMapping__c.fields.ObjectID__c.Name}'] = dragObjectMap[dragId].objName;
    objReportMapping['{!$ObjectType.ReportMapping__c.fields.Objectculomn__c.Name}'] = dragObjectMap[dragId].name;
    objReportMapping['{!$ObjectType.ReportMapping__c.fields.OBJECTIDREF__C.Name}'] = dragObjectMap[dragId].relationshipName;


    overlayColumnIDMap[indexOverlayColumnID].reportMappingList.push(objReportMapping);

    for(var i=0; i<overlayColumnIDMap[indexOverlayColumnID].reportMappingList.length;i++){
        //マッピングレコードにオーバレイ項目IDを設定する
        overlayColumnIDMap[indexOverlayColumnID].reportMappingList[i]['{!$ObjectType.ReportMapping__c.fields.OverlayCulomnID__c.Name}']
            = strOverlayColumnID;
    }

    //オーバレイフィールドの履歴を作成する
    //var objReportDefinitionHistory = {};
    var strTrackMessage = '';

    if(overlayColumnIDMap[indexOverlayColumnID].trackReportMappingList.length>0){
        strTrackMessage = strOverlayColumnID;
        strTrackMessage += '{!$Label.msg_wf_00260}';
    }else{
        strTrackMessage = strOverlayColumnID;
        strTrackMessage += '{!$Label.msg_wf_00255}';
    }

    overlayColumnIDMap[indexOverlayColumnID].strTrackMessage = strTrackMessage;
}

/**
 * ドロップしたドラッグ要素を削除する
 */
function deleteDrags(){

    $('.del').click(
        function(){
            var delE = $(this);
            delE.prev('span').text('drop!!').removeClass('dropInputed').addClass('dropInput');
            delE.parent('div').parent('td').prev('td').text('');
            delE.parent('div').parent('td').next('td').children().remove();

            delE.parent('div').next('span').html('{!$Label.label_wf_29018}<br/>{!$Label.label_wf_29019}');

            //明細ソート順番号をクリアして非活性化
            delE.parent('div').parent('td').prev('td').prev('td').prev('td').prev('td').children('select').val('').attr('disabled',true);
            //明細ソートタイプをクリアして非活性化
            delE.parent('div').parent('td').prev('td').prev('td').prev('td').children('select').val('').attr('disabled',true);

        }
   );
}

/**
 * 明細ソート順番号をマッピングレコードに格納する
 */
function onchangeDetailSortOrderNum(){
    $('#sortOrderNum select').change(
        function(){

            //selectタグ
            var sortOrderNumE = $(this);


            var sortOrderNumValue = sortOrderNumE.val();


            var strOverlayColumnID = sortOrderNumE.parent('td').next('td').next('td').text();
            var indexOverlayColumnID = strOverlayColumnID.toLowerCase();

            if(indexOverlayColumnID.lastIndexOf('*')>0){
                indexOverlayColumnID = indexOverlayColumnID.replace('*','');
            }

            overlayColumnIDMap[indexOverlayColumnID].reportMappingList[0]['{!$ObjectType.ReportMapping__c.fields.SortOrderNum__c.Name}']
                = sortOrderNumValue;

        }
   );
}


/**
 * 明細ソートタイプをマッピングレコードに格納する
 */
function onchangeDetailSortType(){
    $('#sortType select').change(
        function(){

            //selectタグ
            var sortTypeE = $(this);


            var sortTypeValue = sortTypeE.val();


            var strOverlayColumnID = sortTypeE.parent('td').next('td').text();
            var indexOverlayColumnID = strOverlayColumnID.toLowerCase();

            if(indexOverlayColumnID.lastIndexOf('*')>0){
                indexOverlayColumnID = indexOverlayColumnID.replace('*','');
            }

            overlayColumnIDMap[indexOverlayColumnID].reportMappingList[0]['{!$ObjectType.ReportMapping__c.fields.SortType__c.Name}']
                = sortTypeValue;

        }
   );
}

/**
 * ユーザ入力内容をマッピングレコードに格納する
 */
function onchangeUserInputField(){
    $('#userInputField').change(
        function(){

            //inputタグ
            var inputE = $(this);


            var inputValue = inputE.val();


            var strOverlayColumnID = inputE.parent('td').prev('td').prev('td').prev('td').text();
            var indexOverlayColumnID = strOverlayColumnID.toLowerCase();

            if(indexOverlayColumnID.lastIndexOf('*')>0){
                indexOverlayColumnID = indexOverlayColumnID.replace('*','');
            }

            overlayColumnIDMap[indexOverlayColumnID].reportMappingList[0]['{!$ObjectType.ReportMapping__c.fields.UserInput__c.Name}']
                = inputValue;

        }
   );
}

/**
 * ユーザ入力必須フラグをマッピングレコードに格納する
 */
function onchangeUserInputFlg(){
    $('#userInputRequiredFlg').change(
        function(){

            //チェックボックス
            var inputE = $(this);


            var inputValue = inputE.is(':checked');


            var strOverlayColumnID = inputE.parent('td').prev('td').prev('td').prev('td').text();
            var indexOverlayColumnID = strOverlayColumnID.toLowerCase();

            if(indexOverlayColumnID.lastIndexOf('*')>0){
                indexOverlayColumnID = indexOverlayColumnID.replace('*','');
            }

            overlayColumnIDMap[indexOverlayColumnID].reportMappingList[0]['{!$ObjectType.ReportMapping__c.fields.USERINPUTREQUIREDFLG__C.Name}']
                = inputValue;

        }
   );
}


/**
 * 自動採番ををマッピングレコードに格納する
 */
function onchangeEstimateNumber(){
    $('#estimateNumber').change(
        function(){

            //selectタブ
            var selectE = $(this);


            var selectValue = selectE.val();


            var strOverlayColumnID = selectE.parent('td').prev('td').prev('td').prev('td').text();
            var indexOverlayColumnID = strOverlayColumnID.toLowerCase();

            if(indexOverlayColumnID.lastIndexOf('*')>0){
                indexOverlayColumnID = indexOverlayColumnID.replace('*','');
            }

            overlayColumnIDMap[indexOverlayColumnID].reportMappingList[0]['{!$ObjectType.ReportMapping__c.fields.OBJECTCULOMN__C.Name}']
                = selectValue;

        }
   );
}

//$j=jQuery.noConflict(); //他のライブラリとの衝突を回避します

//$j(function($) {
$(function($) {

    createDraggable();
    createDroppable();



    //var nav = $('.nav,#navTab');
    var nav = $('#navTab');

    var navTop = nav.offset().top+200;

    $(window).scroll(function () {

        var winTop = $(this).scrollTop();

        if (winTop > navTop) {

            nav.width(nav.width());
            nav.addClass('fixed');

        } else if (winTop <= navTop) {

            //nav.width(720);
            nav.css('width','');
            nav.removeClass('fixed');

        }

    });




    deleteDrags();

    $('.drags').hover(
        function(){

            //$(this).addClass('ui-draggable');
            createDraggable();
        }
    );


    hideShowTabMain();

    if({!isPdfAvailable}){
        $('#tabLinkSecurity').show();
    }else{
        $('#tabLinkSecurity').hide();
    }

});

//連想配列
var beforeUserAuthAddedMap = {};

//文字列
var strBeforeUserAuthAddedLabel = '';

//連想配列
var beforeCategoryMap = {};



/**
 * 初期化処理
 */
$(document).ready(function() {


    $('#tv').treeview({});

    //$(esc('page:form:added')+' option').each(function() {
    //$('select[id$="added"]').children('option').each(function(){
    $('select[id$="added"] option').each(function(){

        beforeUserAuthAddedMap[$(this).val()] = $(this).text();

        if(strBeforeUserAuthAddedLabel != ''){
              strBeforeUserAuthAddedLabel += ',';
              strBeforeUserAuthAddedLabel += $(this).text();
        }else{
              strBeforeUserAuthAddedLabel = $(this).text();
        }

    });


    //修正前のカテゴリを保持する

    $(".categoryField").each(function(){
        var objCategoryE = $(this);
        var objCategory = {};

        getObjCategory(objCategoryE,objCategory);

        beforeCategoryMap[objCategory['field']] = objCategory;
    });


});

/**
 * 画面のカテゴリ情報を取得する
 */
function getObjCategory(objCategoryE,objCategory){

    objCategory['field'] = objCategoryE.attr('data-name');
    objCategory['value'] = '';
    objCategory['isMulti'] = objCategoryE.attr('data-multi');
    objCategory['label'] = objCategoryE.prev('td').text();
    objCategory['valueLabel'] = '';

    if(objCategoryE.attr('data-multi') == 'true'){

        var checkedValue = '';
        var checkedValueLabel = '';

        objCategoryE.children('table').children('tbody').children('tr').children('td').each(function(){

            var checkboxE = $(this).children('input');

            if(checkboxE.is(':checked')){
                //if(checkboxE.attr('checked')){
                if(checkedValue == ''){
                    //checkedValue = checkboxE.next('label').text();
                    checkedValue = checkboxE.val();
                    checkedValueLabel = checkboxE.next('label').text();
                }else{
                    checkedValue += ';';
                    checkedValueLabel += ',';
                    //checkedValue += checkboxE.next('label').text();
                    checkedValue += checkboxE.val();
                    checkedValueLabel += checkboxE.next('label').text();
                }
            }

            objCategory['value'] = checkedValue;

            if(checkedValue != ''){
                objCategory['valueLabel'] = checkedValueLabel;
            }else{
                objCategory['valueLabel'] = '{!$Label.label_wf_00141}';
            }
        });
    }else{

        //objCategory['field'] = objCategoryE.attr('data-name');
        objCategory['value'] = objCategoryE.children('select').val();

        objCategory['valueLabel'] = objCategoryE.children('select:first-child').children('option:selected').text();

        if(objCategory['valueLabel'] == '' || objCategory['valueLabel'] == ' '){
            objCategory['valueLabel'] = '{!$Label.label_wf_00141}';
        }
    }

}


</script>
<script type="text/javascript">

/**
 * 基本タブを表示する
 */
function hideShowTabMain(){

    //$('#tabs').css('height','800px');
    //$('#tabs').css('overflow','');
    $('#tabs').height(800);

    $('#FFRegistMain').show();
    $('#tabLinkMain').removeClass('ui-state-disabled').addClass('ui-tabs-selected ui-state-active');
    $('#tabFormatSetting,#tabMapping,#tabSecurity,#tabHistory').hide();
    $('#tabLinkSheet,#tabLinkMapping,#tabLinkSecurity,#tabLinkHistory').removeClass('ui-state-disabled ui-tabs-selected ui-state-active');

}

/**
 * 出力シート順タブを表示する
 */
function hideShowTabSheet(){

    $('#tabs').height(800);

    $('#FFRegistMain,#tabMapping,#tabSecurity,#tabHistory').hide();
    $('#tabLinkMain,#tabLinkMapping,#tabLinkSecurity,#tabLinkHistory').removeClass('ui-state-disabled ui-tabs-selected ui-state-active');
    $('#tabFormatSetting').show();
    $('#tabLinkSheet').removeClass('ui-state-disabled').addClass('ui-tabs-selected ui-state-active');

}

/**
 * マッピングタブを表示する
 */
function hideShowTabMapping(){

    //$('#tabs').css('overflow','auto');
    $('#tabs').height($('#tabMapping').height()+270+70);
    $('#tabMapping').height($('#tabMapping').height()+270);

    $('#tabMapping').show();

    $('#tabLinkMapping').removeClass('ui-state-disabled').addClass('ui-tabs-selected ui-state-active');
    $('#tabFormatSetting,#FFRegistMain,#tabSecurity,#tabHistory').hide();
    $('#tabLinkSheet,#tabLinkMain,#tabLinkSecurity,#tabLinkHistory').removeClass('ui-state-disabled ui-tabs-selected ui-state-active');
}

/**
 * セキュリティタブを表示する
 */
function hideShowTabSecurity(){

    $('#tabs').height(800);

    $('#tabSecurity').show();
    $('#tabLinkSecurity').removeClass('ui-state-disabled').addClass('ui-tabs-selected ui-state-active');
    $('#tabFormatSetting,#FFRegistMain,#tabMapping,#tabHistory').hide();
    $('#tabLinkSheet,#tabLinkMain,#tabLinkMapping,#tabLinkHistory').removeClass('ui-state-disabled ui-tabs-selected ui-state-active')
}

/**
 * 履歴タブを表示する
 */
function hideShowTabHistory(){

    $('#tabs').height(800);



    $('#tabHistory').show();
    $('#tabLinkHistory').removeClass('ui-state-disabled').addClass('ui-tabs-selected ui-state-active');
    $('#tabFormatSetting,#FFRegistMain,#tabMapping,#tabSecurity').hide();
    $('#tabLinkSheet,#tabLinkMain,#tabLinkMapping,#tabLinkSecurity').removeClass('ui-state-disabled ui-tabs-selected ui-state-active')
}

//TreeViewRecDTOのインスタンスを保持する
var treeViewRecDTO;

/**
 * ツリーの初期処理
 */
function asyncInitTrreView(){


    Visualforce.remoting.Manager.invokeAction(
        '{!$RemoteAction.ReportDefinitionEditController.getInstanceTreeViewRecDTO}'

        ,function(result, event){

            if (event.status) {
                //DTOの空のインスタンスを取得
                treeViewRecDTO = result;

            } else if (event.type === 'exception') {

                CsoScript_loadingStop();

                var message = event.message;

                var errMessageArray = [];
                errMessageArray.push(message);

                var messageHtml = createMessageHtml(errMessageArray);

                $('#jsPageMessagesCell').html(messageHtml);
                $('#jsPageMessages').show();

            } else {

                CsoScript_loadingStop();

                var message = event.message;

                var errMessageArray = [];
                errMessageArray.push(message);

                var messageHtml = createMessageHtml(errMessageArray);

                $('#jsPageMessagesCell').html(messageHtml);
                $('#jsPageMessages').show();

            }
        }
        ,{escape: true}
    );
}

asyncInitTrreView();

//自動採番の情報を保持する
var EstimateNumberingList;
var EstimateNumberingOptionsAppendHtml = '';

function asyncGetEstimateNumberingList(){


    Visualforce.remoting.Manager.invokeAction(
        '{!$RemoteAction.ReportDefinitionEditController.getEstimateNumberingList}'

        ,function(result, event){



            if (event.status) {

                EstimateNumberingList = result;


                for(var i=0; i<result.length; i++){
                    EstimateNumberingOptionsAppendHtml += '<option value=\"\" ></option>';
                    EstimateNumberingOptionsAppendHtml += '<option value=\"';
                    EstimateNumberingOptionsAppendHtml += result[i]['{!$ObjectType.EstimateNumbering__c.fields.Id.Name}'];
                    EstimateNumberingOptionsAppendHtml += '\" >';
                    EstimateNumberingOptionsAppendHtml += result[i]['{!$ObjectType.EstimateNumbering__c.fields.Name.Name}'];
                    EstimateNumberingOptionsAppendHtml += ' ';
                    EstimateNumberingOptionsAppendHtml += result[i]['{!$ObjectType.EstimateNumbering__c.fields.NumberingFormat__c.Name}'];
                    EstimateNumberingOptionsAppendHtml += '\</option>';
                }

            } else if (event.type === 'exception') {

                CsoScript_loadingStop();

                var message = event.message;

                var errMessageArray = [];
                errMessageArray.push(message);

                var messageHtml = createMessageHtml(errMessageArray);

                $('#jsPageMessagesCell').html(messageHtml);
                $('#jsPageMessages').show();

            } else {

                CsoScript_loadingStop();

                var message = event.message;

                var errMessageArray = [];
                errMessageArray.push(message);

                var messageHtml = createMessageHtml(errMessageArray);

                $('#jsPageMessagesCell').html(messageHtml);
                $('#jsPageMessages').show();

            }
        }
        ,{escape: true}
    );
}

asyncGetEstimateNumberingList();



//空のインスタンスを保持する
var TreeViewRecDtoInstance;

function asyncGetInstanceTreeViewRecDto(){



    Visualforce.remoting.Manager.invokeAction(
        '{!$RemoteAction.ReportDefinitionEditController.getInstanceTreeViewRecDTO}'

        ,function(result, event){

            if (event.status) {
                //DTOの空のインスタンスを取得
                TreeViewRecDtoInstance = result;

            } else if (event.type === 'exception') {

                CsoScript_loadingStop();

                var message = event.message;

                var errMessageArray = [];
                errMessageArray.push(message);

                var messageHtml = createMessageHtml(errMessageArray);

                $('#jsPageMessagesCell').html(messageHtml);
                $('#jsPageMessages').show();

            } else {

                CsoScript_loadingStop();

                var message = event.message;

                var errMessageArray = [];
                errMessageArray.push(message);

                var messageHtml = createMessageHtml(errMessageArray);

                $('#jsPageMessagesCell').html(messageHtml);
                $('#jsPageMessages').show();

            }
        }
        ,{escape: true}
    );


}

asyncGetInstanceTreeViewRecDto();

//連想配列
var dragTrackMap = {};

//連想配列
var dragObjectMap = {};



function getTreeViewCustom(item){

    var treeViewRecDto = $.extend(true,{},TreeViewRecDtoInstance);

    //ツリーでクリックした項目のオブジェクト
    var itemE = $(esc(item.id));

    var dragAppendHtml = '';

    dragAppendHtml += '<div class=\"drags\" style=\"z-index: 999; float: left; \" id=\"';
    dragAppendHtml += itemE.attr('data-name');
    dragAppendHtml += '-';
    dragAppendHtml += itemE.attr('data-name');
    dragAppendHtml += '\" data-name=\"';
    dragAppendHtml += itemE.attr('data-name');
    dragAppendHtml += '\" data-type=\"';
    dragAppendHtml += itemE.attr('data-type');
    dragAppendHtml += '\" data-parentId=\"';
    dragAppendHtml += item.id;
    dragAppendHtml += '\" >';
    //if(){
        dragAppendHtml += itemE.text();
    //}
    dragAppendHtml += '</div>';

    dragAppendHtml += '<span class=\"tooltip\">';
    dragAppendHtml += '{!$Label.label_wf_29018}';
    dragAppendHtml += itemE.text();
    dragAppendHtml += '<br />';

    dragAppendHtml += '</span>';

    treeViewRecDto.objName = itemE.attr('data-objName');

    dragTrackMap[item.id] = treeViewRecDto;
    dragObjectMap[itemE.attr('data-name')+'-'+itemE.attr('data-name')] = treeViewRecDto;

    $('#ulDrags').hide('fast');
    $('#ulDrags').html(dragAppendHtml);
    $('#ulDrags').slideDown('slow');

    createDraggable();

    $('.drags').hover(
        function(){
            createDraggable();
        }
    );

}

/**
 * ツリーに表示する情報を取得する
 */
function getTreeView(item){

    //ツリーでクリックした項目のオブジェクト
    var itemE = $(esc(item.id));


    //ツリーに表示するオブジェクトのDescribe情報を取得する
    Visualforce.remoting.Manager.invokeAction(
        '{!$RemoteAction.ReportDefinitionEditController.getTreeViewDTO}'
        ,itemE.attr('data-type')//sObject or field
        ,itemE.attr('data-objName')//オブジェクトのapi参照名
        ,itemE.attr('data-name')//項目のapi参照名
        ,function(result, event){

            if (event.status) {

                //ツリーに追加するhtmlタグを保持する
                var treeAppendHtml = '<ul >';

                //ドラッグ要素のhtmlタグを保持する
                var dragAppendHtml = '';

                var cntDragE = 0;

                //Describeの情報からhtmlとMapを作成する
                for(var j=0;j<result.treeViewRecDtoList.length;j++){

                    var parentRelBreadcrumbsLabel = dragTrackMap[item.id].relBreadcrumbsLabel;

                    //if(parentRelBreadcrumbsLabel != '>'){
                        result.treeViewRecDtoList[j].relBreadcrumbsLabel += dragTrackMap[item.id].relBreadcrumbsLabel;
                        result.treeViewRecDtoList[j].relBreadcrumbsLabel += '>';
                    //}

                    if(result.treeViewRecDtoList[j].type == 'REFERENCE'){
                        result.treeViewRecDtoList[j].type = 'parents';
                    }else if(result.treeViewRecDtoList[j].type == 'children'){
                        //何もしない
                    }else{
                       //項目の型は利用しないので、空白にする
                       result.treeViewRecDtoList[j].type = '';
                    }


                    if(result.treeViewRecDtoList[j].type == 'parents'){

                        treeAppendHtml += '<li ><span onclick=\"getTreeView(this);\" id=\"';
                        treeAppendHtml += item.id;
                        treeAppendHtml += ':';
                        treeAppendHtml += result.treeViewRecDtoList[j].objName;
                        treeAppendHtml += '-';
                        treeAppendHtml += result.treeViewRecDtoList[j].name;
                        treeAppendHtml += '\" data-name=\"';
                        treeAppendHtml += result.treeViewRecDtoList[j].name;
                        treeAppendHtml += '\" data-objName=\"';
                        treeAppendHtml += result.treeViewRecDtoList[j].objName;
                        treeAppendHtml += '\"';
                        treeAppendHtml += ' data-type=\"field\">';
                        treeAppendHtml += '(P)';
                        treeAppendHtml += result.treeViewRecDtoList[j].label;
                        treeAppendHtml += '(';
                        treeAppendHtml += result.treeViewRecDtoList[j].name;
                        treeAppendHtml += ')';
                        treeAppendHtml += '</span></li>';

                        var key = '';
                        key += item.id;
                        key += ':';
                        key += result.treeViewRecDtoList[j].objName;
                        key += '-';
                        key += result.treeViewRecDtoList[j].name;
                        result.treeViewRecDtoList[j].domId = key;

                        result.treeViewRecDtoList[j].relBreadcrumbsLabel += '(P)';
                        result.treeViewRecDtoList[j].relBreadcrumbsLabel += result.treeViewRecDtoList[j].label;
                        result.treeViewRecDtoList[j].relBreadcrumbsLabel += '(';
                        result.treeViewRecDtoList[j].relBreadcrumbsLabel += result.treeViewRecDtoList[j].name;
                        result.treeViewRecDtoList[j].relBreadcrumbsLabel += ')';

                        //親のマッピングレコードを取得する
                        result.treeViewRecDtoList[j].reportMappingList =  $.extend(true,[],dragTrackMap[item.id].reportMappingList);

                        var objMapping = {};
                        var parentObjectID = '';

                        if(result.treeViewRecDtoList[j].reportMappingList.length == 0){
                            parentObjectID = result.treeViewRecDtoList[j].objName;
                        }else{
                            parentObjectID = result.treeViewRecDtoList[j].relationshipName;
                            parentObjectID += '-';
                            parentObjectID += result.treeViewRecDtoList[j].objName;
                        }

                        objMapping['{!$ObjectType.ReportMapping__c.fields.attributetype__c.Name}'] = result.treeViewRecDtoList[j].type;
                        objMapping['{!$ObjectType.ReportMapping__c.fields.ObjectID__c.Name}'] = parentObjectID;
                        objMapping['{!$ObjectType.ReportMapping__c.fields.Objectculomn__c.Name}'] = result.treeViewRecDtoList[j].name;




                        result.treeViewRecDtoList[j].reportMappingList.push(objMapping);

                        dragTrackMap[key] = result.treeViewRecDtoList[j];

                    }else if(result.treeViewRecDtoList[j].type == 'children'){

                        treeAppendHtml += '<li ><span onclick=\"getTreeView(this);\" id=\"';
                        treeAppendHtml += item.id;
                        treeAppendHtml += ':';
                        //ツリー上でユニークにするため、子リレーション名を利用する
                        //treeAppendHtml += result.treeViewRecDtoList[j].objName;
                        treeAppendHtml += result.treeViewRecDtoList[j].relationshipName
                        treeAppendHtml += '-';
                        treeAppendHtml += result.treeViewRecDtoList[j].name;
                        treeAppendHtml += '\" data-name=\"';
                        treeAppendHtml += result.treeViewRecDtoList[j].name;
                        treeAppendHtml += '\" data-objName=\"';
                        treeAppendHtml += result.treeViewRecDtoList[j].objName;
                        treeAppendHtml += '\"';
                        treeAppendHtml += ' data-type=\"sObject\">';
                        treeAppendHtml += '(c)';
                        treeAppendHtml += result.treeViewRecDtoList[j].label;
                        treeAppendHtml += '(';
                        treeAppendHtml += result.treeViewRecDtoList[j].relationshipName;
                        treeAppendHtml += ')';
                        treeAppendHtml += '</span></li>';

                        var key = '';
                        key += item.id;
                        key += ':';
                        //マッピングレコードを引けるように子リレーション名でユニークにする
                        //key += result.treeViewRecDtoList[j].objName;
                        key += result.treeViewRecDtoList[j].relationshipName;
                        key += '-';
                        key += result.treeViewRecDtoList[j].name;
                        result.treeViewRecDtoList[j].domId = key;


                        result.treeViewRecDtoList[j].relBreadcrumbsLabel += '(c)';
                        result.treeViewRecDtoList[j].relBreadcrumbsLabel += result.treeViewRecDtoList[j].label;
                        result.treeViewRecDtoList[j].relBreadcrumbsLabel += '(';
                        result.treeViewRecDtoList[j].relBreadcrumbsLabel += result.treeViewRecDtoList[j].relationshipName;
                        result.treeViewRecDtoList[j].relBreadcrumbsLabel += ')';

                        //親のマッピングレコードを取得する
                        result.treeViewRecDtoList[j].reportMappingList =  $.extend(true,[],dragTrackMap[item.id].reportMappingList);

                        var objMapping = {};
                        var parentObjectID = '';



                        var cntReportMappingList = result.treeViewRecDtoList[j].reportMappingList.length;

                        if(cntReportMappingList>0){
                            parentObjectID = result.treeViewRecDtoList[j].reportMappingList[cntReportMappingList-1]['{!$ObjectType.ReportMapping__c.fields.ObjectID__c.Name}'];
                        }else{
                            parentObjectID = itemE.attr('data-objName');
                        }

                        objMapping['{!$ObjectType.ReportMapping__c.fields.attributetype__c.Name}'] = result.treeViewRecDtoList[j].type;
                        objMapping['{!$ObjectType.ReportMapping__c.fields.ObjectID__c.Name}'] = parentObjectID;
                        objMapping['{!$ObjectType.ReportMapping__c.fields.Objectculomn__c.Name}'] = result.treeViewRecDtoList[j].name;
                        objMapping['{!$ObjectType.ReportMapping__c.fields.SUBREFID__C.Name}'] = result.treeViewRecDtoList[j].relationshipName;

                        result.treeViewRecDtoList[j].reportMappingList.push(objMapping);



                        dragTrackMap[key] = result.treeViewRecDtoList[j];
                    }


                    if(result.treeViewRecDtoList[j].type != 'children'){

                        cntDragE++;

                        dragAppendHtml += '<div class=\"drags\" style=\"z-index: 999; float: left; \" id=\"';
                        dragAppendHtml += result.treeViewRecDtoList[j].objName;
                        dragAppendHtml += '-';
                        dragAppendHtml += result.treeViewRecDtoList[j].name.toLowerCase();
                        dragAppendHtml += '\" data-name=\"';
                        dragAppendHtml += result.treeViewRecDtoList[j].name.toLowerCase();
                        dragAppendHtml += '\" data-parentId=\"';
                        dragAppendHtml += item.id;
                        dragAppendHtml += '\" data-search=\"';
                        dragAppendHtml += result.treeViewRecDtoList[j].label.toLowerCase();
                        dragAppendHtml += '-';
                        dragAppendHtml += result.treeViewRecDtoList[j].name.toLowerCase();

                        dragAppendHtml += '\" >';
                        dragAppendHtml += result.treeViewRecDtoList[j].label;
                        dragAppendHtml += '</div>';

                        dragAppendHtml += '<span class=\"tooltip\" style=\"display:none;\">';

                        dragAppendHtml += '{!$Label.label_wf_29018}';
                        dragAppendHtml += result.treeViewRecDtoList[j].label;
                        dragAppendHtml += '<br />';
                        dragAppendHtml += '{!$Label.label_wf_29019}';
                        dragAppendHtml += result.treeViewRecDtoList[j].name;
                        dragAppendHtml += '</span>';

                        var key = '';
                        key += result.treeViewRecDtoList[j].objName;
                        key += '-';
                        key += result.treeViewRecDtoList[j].name.toLowerCase();


                        dragObjectMap[key] = result.treeViewRecDtoList[j];

                    }

                }



                treeAppendHtml += '</ul>';

                //ツリーにトグルを表示する。
                if(itemE.prev('div').length == 0){

                    if(itemE.parent('.last').length == 0){
                        itemE.parent('li').prepend('<div class=\"hitarea collapsable-hitarea\"></div>');
                    }else{
                        itemE.parent('li').prepend('<div class=\"hitarea lastCollapsable-hitarea collapsable-hitarea\"></div>');
                    }
                }


                //ツリーが作成済みでない場合
                if(!itemE.hasClass('created')){
                    itemE.addClass('created');
                    itemE.parent('li').append(treeAppendHtml);


                    $("#tv").treeview();

                    clickHideTree();
                    clickShowTree();


                    itemE.prev('div').trigger("click");
                }

                resizeDragsAreaWidth(cntDragE);

                $('#ulDrags').hide('fast');

                $('#ulDrags').html(dragAppendHtml);
                //$('#ulDrags').remove();
                //$('#ulDrags').append(dragAppendHtml);

                $('#ulDrags').slideDown('slow');



                createDraggable();

                $('.drags').hover(
                    function(){
                       createDraggable();
                    }
                );



            } else if (event.type === 'exception') {

                CsoScript_loadingStop();

                var message = event.message;

                var errMessageArray = [];
                errMessageArray.push(message);

                var messageHtml = createMessageHtml(errMessageArray);

                $('#jsPageMessagesCell').html(messageHtml);
                $('#jsPageMessages').show();

            } else {

                CsoScript_loadingStop();

                var message = event.message;

                var errMessageArray = [];
                errMessageArray.push(message);

                var messageHtml = createMessageHtml(errMessageArray);

                $('#jsPageMessagesCell').html(messageHtml);
                $('#jsPageMessages').show();

            }
        }
        ,{escape: true}
    );
}

function resizeDragsAreaWidth(cnt){

    $('#navTab').width($('#tabMapping').width()-50);

    if(cnt<20){
        //$('#ulDrags').css('width','500px');
        $('#ulDrags').width($('#tabMapping').width()-200);
        if(500<$('#tabMapping').width()-200){
            $('#divDrags').width($('#tabMapping').width()-250);
        }else{
            $('#divDrags').width(500);
        }

        //$('#navTab').width($('#tabMapping').width()-50);

    }else{
        var w = ((cnt/4)+1)*100;
        //var w = ((cnt/4)+1)*80;

        //$('#ulDrags').css('width',w+'px');
        $('#ulDrags').width(w);

        if(500<$('#tabMapping').width()-200){
            $('#divDrags').width($('#tabMapping').width()-250);
        }else{
            $('#divDrags').width(500);
        }


    }
}

function bindResize(){

    var cntDragE = 0;

    $(".drags").each(function(){

        if($(this).is(':visible')){
            cntDragE++;
        }

    });

    resizeDragsAreaWidth(cntDragE);
}

$(document).ready(function() {

        $(window).bind("resize", bindResize);

        $('div[id$="sectionMap"]').hide();
      });

/**
 * ツリーを表示しない
 */
function clickHideTree(){

    $('.collapsable-hitarea').not('.lastCollapsable-hitarea').click(
        function(){

            $(this).removeClass('collapsable-hitarea').addClass('expandable-hitarea');
            $(this).parent('li').removeClass('collapsable').addClass('expandable');
            //$(this).parent('li').removeClass('collapsable');
            $(this).nextAll('ul').css('display','none');

            clickShowTree();
        }


    );

    $('.lastCollapsable-hitarea').click(
        function(){

            $(this).removeClass('lastCollapsable-hitarea').removeClass('collapsable-hitarea').addClass('lastExpandable-hitarea').addClass('expandable-hitarea');
            $(this).parent('li').removeClass('collapsable').addClass('expandable');
            //$(this).parent('li').removeClass('collapsable');
            $(this).nextAll('ul').css('display','none');

            clickShowTree();
        }


    );

}

/**
 * ツリーを表示する
 */
function clickShowTree(){

    $('.expandable-hitarea').not('.lastExpandable-hitarea').click(
        function(){

            $(this).removeClass('expandable-hitarea').addClass('collapsable-hitarea');
            $(this).parent('li').removeClass('expandable').addClass('collapsable');
            //$(this).parent('li').removeClass('expandable').addClass('collapsable');
            $(this).nextAll('ul').css('display','block');

            clickHideTree();
        }


    );

    $('.lastExpandable-hitarea').click(
        function(){

            $(this).removeClass('lastExpandable-hitarea').removeClass('expandable-hitarea').addClass('lastCollapsable-hitarea').addClass('collapsable-hitarea');
            $(this).parent('li').removeClass('expandable').addClass('collapsable');
            //$(this).parent('li').removeClass('expandable').addClass('collapsable');
            $(this).nextAll('ul').css('display','block');

            clickHideTree();
        }


    );


}

var OverlayColumnDTO;

/**
 * 新規作成時の初期化処理
 */
function asyncGetInstanceOverlayColumnDTO(){

    Visualforce.remoting.Manager.invokeAction(
        '{!$RemoteAction.ReportDefinitionEditController.getInstanceOverlayColumnDTO}'

        ,function(result, event){

            if (event.status) {
                //グローバル変数に戻り値を格納する
                OverlayColumnDTO = result;

            } else if (event.type === 'exception') {

                CsoScript_loadingStop();

                var message = event.message;

                var errMessageArray = [];
                errMessageArray.push(message);

                var messageHtml = createMessageHtml(errMessageArray);

                $('#jsPageMessagesCell').html(messageHtml);
                $('#jsPageMessages').show();

            } else {

                CsoScript_loadingStop();

                var message = event.message;

                var errMessageArray = [];
                errMessageArray.push(message);

                var messageHtml = createMessageHtml(errMessageArray);

                $('#jsPageMessagesCell').html(messageHtml);
                $('#jsPageMessages').show();

            }
        }
        ,{escape: true}
    );
}

asyncGetInstanceOverlayColumnDTO();

//RemoteActionで利用するDTOクラス
var formFormatDTO;

/**
 * 新規作成時の初期化処理
 */
function asyncInitFormFormatMapping(){

    Visualforce.remoting.Manager.invokeAction(
        '{!$RemoteAction.ReportDefinitionEditController.getInstanceFormFormatDTO}'

        ,function(result, event){

            if (event.status) {
                //グローバル変数に戻り値を格納する
                formFormatDTO = result;

            } else if (event.type === 'exception') {

                CsoScript_loadingStop();

                var message = event.message;

                var errMessageArray = [];
                errMessageArray.push(message);

                var messageHtml = createMessageHtml(errMessageArray);

                $('#jsPageMessagesCell').html(messageHtml);
                $('#jsPageMessages').show();

            } else {

                CsoScript_loadingStop();

                var message = event.message;

                var errMessageArray = [];
                errMessageArray.push(message);

                var messageHtml = createMessageHtml(errMessageArray);

                $('#jsPageMessagesCell').html(messageHtml);
                $('#jsPageMessages').show();

            }
        }
        ,{escape: true}
    );
}


var cntContentsId = 0;
var contentsIdList = [];
var contentsPropertyMap = {};
var currentNumber = 0;
var lastNumber = 0;


/**
 * 編集時の初期化処理
 */
function asyncInitFormFormatDTOById(){

    var rdId = '{!JSENCODE(ReportDefinition__c.Id)}';

    Visualforce.remoting.Manager.invokeAction(
        '{!$RemoteAction.ReportDefinitionEditController.initFormFormatDTOById}'
        ,rdId
        //,'{!$ObjectType.ReportDefinition__c.Name}'
        ,function(result, event){

            if (event.status) {
                //グローバル変数に戻り値を格納する
                formFormatDTO = result;

                if(formFormatDTO.errMessageList != null && formFormatDTO.errMessageList.length > 0){
                    var messageHtml = createMessageHtml(formFormatDTO.errMessageList);
                    $('#jsPageMessagesCell').html(messageHtml);
                    $('#jsPageMessages').show();
                }
                if(formFormatDTO.errFlg){
                    return;
                }

                formFormatDTO.ecmActiveFlg = {!ecmActiveFlg};

                //$('input[id$="overlayText"]').val([Name]);
                //$('input[id$="fixedKomoku"]').val([fixedKomoku]);
                //$('input[id$="detailKomoku"]').val([detailKomoku]);
                //$('input[id$="thum"]').val([thum]);
                //$('input[id$="rOverlayId"]').val([Id]);
                //$('input[id$="rOverlayVersion"]').val([LatestVersion]);
                //$('input[id$="fixedMap"]').val([returnfixedMap]);
                //$('input[id$="detailMap"]').val([returndetailMap]);

                formFormatDTO.overlayText = $('input[id$="overlayText"]').val();
                formFormatDTO.rOverlayId = $('input[id$="rOverlayId"]').val();
                formFormatDTO.rOverlayVersion = $('input[id$="rOverlayVersion"]').val();

                if(formFormatDTO.contentsIdList.length == 0
                    || !formFormatDTO.ecmActiveFlg){

                    createHtmlMappingTable(formFormatDTO);


                    if(formFormatDTO.mapOverlayColumnDtoList.length>0){
                        $('div[id$="sectionMap"]').show();
                        createHtmlMapsMappingTable(formFormatDTO);
                    }else{
                        $('div[id$="sectionMap"]').hide();
                    }

                    //WR本体の帳票定義情報を取得する
                    if(formFormatDTO.objReportDefinition['{!$ObjectType.ReportDefinition__c.fields.WR_FormDefinitionId__c.Name}']
                        != '' && formFormatDTO.objReportDefinition['{!$ObjectType.ReportDefinition__c.fields.WR_FormDefinitionId__c.Name}']
                            != null){
                        asyncGetFormDefinitionInfo(formFormatDTO,false);
                    }
                }else{


                    lastNumber = 0;
                    currentNumber = 0;

                    if(formFormatDTO.contentsIdList.length>1){
                        lastNumber = formFormatDTO.contentsIdList.length - 1;
                    }

                    contentPropertyGetAsync(formFormatDTO,currentNumber,lastNumber);


                }

            } else if (event.type === 'exception') {

                CsoScript_loadingStop();

                var message = event.message;

                var errMessageArray = [];
                errMessageArray.push(message);

                var messageHtml = createMessageHtml(errMessageArray);

                $('#jsPageMessagesCell').html(messageHtml);
                $('#jsPageMessages').show();

            } else {

                CsoScript_loadingStop();

                var message = event.message;

                var errMessageArray = [];
                errMessageArray.push(message);

                var messageHtml = createMessageHtml(errMessageArray);

                $('#jsPageMessagesCell').html(messageHtml);
                $('#jsPageMessages').show();

            }
        }
        ,{escape: true}
    );
}

if('{!JSENCODE(ReportDefinition__c.Id)}' == '' || '{!JSENCODE(ReportDefinition__c.Id)}' == 'null'){
    asyncInitFormFormatMapping();
}else{
    asyncInitFormFormatDTOById();
}


/**
 * サムネイルURLを取得する
 */
function contentPropertyGetAsync(dto,current,last){


    var callerror = function(data){
        //CsoScript_loadingStop();

        if(data.status != 500){
            var dataObj = JSON.parse(data.responseText);

            if(dataObj.code == 'CA2-CPGS-XE-0002'){
                //ECM画像へのアクセス権がない場合はなにもしない。
            }else{
                var message = dataObj.message;
                message += '<br/>';
                message += 'code:';
                message += dataObj.code;
                var messageArray = [];

                messageArray.push(message);

                var messageHtml = createMessageHtml(messageArray);

                $('#jsPageMessagesCell').html(messageHtml);
                $('#jsPageMessages').show();
                return;
            }

        }else{

            var errMessageArray = [];
            errMessageArray.push('{!$Label.msg_00136}');

            var messageHtml = createMessageHtml(errMessageArray);

            $('#jsPageMessagesCell').html(messageHtml);
            $('#jsPageMessages').show();
            return;
        }


        if(currentNumber==lastNumber){
            CsoScript_loadingStop();

            createHtmlMappingTable(formFormatDTO);
            deleteDrags();

                    if(formFormatDTO.mapOverlayColumnDtoList.length>0){
                        $('div[id$="sectionMap"]').show();
                        createHtmlMapsMappingTable(formFormatDTO);
                    }else{
                        $('div[id$="sectionMap"]').hide();
                    }
                //WR本体の帳票定義情報を取得する
                if(formFormatDTO.objReportDefinition['{!$ObjectType.ReportDefinition__c.fields.WR_FormDefinitionId__c.Name}']
                    != '' && formFormatDTO.objReportDefinition['{!$ObjectType.ReportDefinition__c.fields.WR_FormDefinitionId__c.Name}']
                        != null){
                    asyncGetFormDefinitionInfo(formFormatDTO,true);
                }
        }else{
            currentNumber++;
            contentPropertyGetAsync(formFormatDTO,currentNumber,lastNumber);
        }
    };

    var callback = function(data){


        contentsPropertyMap[data.fileId] = data;

        if(currentNumber==lastNumber){
            CsoScript_loadingStop();

            createHtmlMappingTable(formFormatDTO);
            deleteDrags();

                    if(formFormatDTO.mapOverlayColumnDtoList.length>0){
                        $('div[id$="sectionMap"]').show();
                        createHtmlMapsMappingTable(formFormatDTO);
                    }else{
                        $('div[id$="sectionMap"]').hide();
                    }
                //WR本体の帳票定義情報を取得する
                if(formFormatDTO.objReportDefinition['{!$ObjectType.ReportDefinition__c.fields.WR_FormDefinitionId__c.Name}']
                    != '' && formFormatDTO.objReportDefinition['{!$ObjectType.ReportDefinition__c.fields.WR_FormDefinitionId__c.Name}']
                        != null){
                    asyncGetFormDefinitionInfo(formFormatDTO,true);
                }
        }else{
            currentNumber++;
            contentPropertyGetAsync(formFormatDTO,currentNumber,lastNumber);
        }

    };


    CsoScript_loadingStart();
    //secureGetAsync('/contentsmanagement/ContentsPropertyGet.json?fileId=' + dto.contentsIdList[current],'' ,callback, callerror);
    secureGetAsyncECM('/contentsmanagement/ContentsPropertyGet.json?fileId=' + dto.contentsIdList[current],'',true,false ,callback, callerror);


}

/**
 * ページ冒頭でiframeで認証を通し置く必要あり。
 */

function secureGetAsyncECM(__url, __data, __sync, __cache, __callback, __callerror){

    // エラーハンドラーが無い場合には標準ハンドラーを使用
    if(__callerror === undefined){
        __callerror = exceptionHandler;
    }

    var errorWrap = function(data, status, throwz){
        if(status == 'timeout'){
            CsoScript_loadingStop();
            data = '{!$Label.msg_01074}';
        }
        __callerror(data, status, throwz);
    };

    $.ajax({
            url     : '{!$Label.field_CSO_URL}' + __url,
            // GET固定
            type    : 'GET',
            data    : __data,
            dataType: 'jsonp',
            sync    : __sync,
            cache   : __cache,
            timeout : 60000,
            success : function(data, status){
                          // 処理結果が失敗で処理継続等の付属情報も存在しない場合エラーと判断する
                          if(data.result == false && data.resultInfo == undefined){
                              //alert(data.message);
                              //return;
                              __callerror(data, status);
                          } else {
                              // 正常にコールバックを実行する
                              __callback(data, status);
                          }
                      },
            error   : errorWrap
    });
}

var sheet_Order;
var sheetNamesheetIdMap = {};
/**
 * WR本体の帳票定義情報を取得する
 */
function asyncGetFormDefinitionInfo(dto, hiddenMsg) {
    if(hiddenMsg){
        $('#jsPageMessages').hide();
    }

    // #10296 IE11で帳票定義参照・編集画面が開かない
    //if(getBrowserType() == "IE11"){
    //  XMLHttpRequest = Sarissa.originalXMLHttpRequest;
    //}

    //1回目のコールバック
    var callback = function (data) {

        sheetDto.sheet_list = data;

        //2回目のコールバック
        var callback2 = function(data) {

            var callback3 = function(data) {

                CsoScript_loadingStop();

                sheetDto.sheet_list = data.sheetInfoList;

                for (var i=0; i < sheetDto.sheet_list.length;i++) {
                    sheetsBase.push(makeSheetInfo(i, sheetDto.sheet_list[i].sheet_name, sheetDto.sheet_list[i].changeable, 'sheet'));
                    allSheets.push(makeSheetInfo(i, sheetDto.sheet_list[i].sheet_name, sheetDto.sheet_list[i].changeable, 'sheet'));
                }

                format = makeFormat(sheet_Order);
                change();
                createHtmlMappingTable(formFormatDTO);
            };

            var callerror3 = function(data, status, xhr) {

                CsoScript_loadingStop();

                if (data.status != 500) {
                    var dataObj = JSON.parse(data.responseText);

                    var message = dataObj.message;
                    message += '<br/>';
                    message += 'code:';
                    message += dataObj.code;

                    var messageArray = [];
                    messageArray.push(message);

                    var messageHtml = createMessageHtml(messageArray);
                    $('#jsPageMessagesCell').html(messageHtml);
                    $('#jsPageMessages').show();
                } else {
                    var errMessageArray = [];
                    errMessageArray.push('{!$Label.msg_00136}');

                    var messageHtml = createMessageHtml(errMessageArray);
                    $('#jsPageMessagesCell').html(messageHtml);
                    $('#jsPageMessages').show();
                }
            };

            var apiGetSheetInfoUrl = '/rest/GetSheetInfo';
            apiGetSheetInfoUrl += '/';
            apiGetSheetInfoUrl += USERNAME;
            apiGetSheetInfoUrl += '/';
            apiGetSheetInfoUrl += CREDENTIAL;
            apiGetSheetInfoUrl += '/';
            apiGetSheetInfoUrl += formFormatDTO.objReportDefinition['{!$ObjectType.ReportDefinition__c.fields.OverlayIDID__c.Name}'];

            if (formFormatDTO.objReportDefinition['{!$ObjectType.ReportDefinition__c.fields.OverlayVersion__c.Name}'] != ''
                && formFormatDTO.objReportDefinition['{!$ObjectType.ReportDefinition__c.fields.OverlayVersion__c.Name}'] != undefined) {
                    apiGetSheetInfoUrl += '/';
                    apiGetSheetInfoUrl += formFormatDTO.objReportDefinition['{!$ObjectType.ReportDefinition__c.fields.OverlayVersion__c.Name}'];
            }

            secureGetAsyncSfJsonAccess(apiGetSheetInfoUrl, '', callback3, callerror3);
        };

        var callerror2 = function(data, status, xhr) {

            CsoScript_loadingStop();

            if (data.status != 500) {
                var dataObj = JSON.parse(data.responseText);

                var message = dataObj.message;
                message += '<br/>';
                message += 'code:';
                message += dataObj.code;

                var messageArray = [];
                messageArray.push(message);

                var messageHtml = createMessageHtml(messageArray);
                $('#jsPageMessagesCell').html(messageHtml);
                $('#jsPageMessages').show();
            } else {
                var errMessageArray = [];
                errMessageArray.push('{!$Label.msg_00136}');

                var messageHtml = createMessageHtml(errMessageArray);
                $('#jsPageMessagesCell').html(messageHtml);
                $('#jsPageMessages').show();
            }
        };

        sheet_Order = data.sheet_order;

        var paramData = JSON.stringify({
            'userid'        : USERNAME,
            'credential'    : CREDENTIAL,
            'ovl_id'        : data.ovl_id,
            'ovl_ver'       : data.ovl_ver,
            'sheet_order'   : JSON.stringify(data.sheet_order)
        });

        //WR本体の帳票定義プレビュー情報を取得する
        if (data.ovl_id != '') {
            securePostAsyncSf('/rest/FormDefinitionPreview', paramData, callback2, callerror2);
        } else {
            CsoScript_loadingStop();
        }
    };

    //1回目のコールバックエラー
    var callerror = function(data, status, xhr) {

        CsoScript_loadingStop();

        if (data.status != 500) {
            var dataObj = JSON.parse(data.responseText);

            var message = dataObj.message;
            message += '<br/>';
            message += 'code:';
            message += dataObj.code;

            var messageArray = [];
            messageArray.push(message);

            var messageHtml = createMessageHtml(messageArray);
            $('#jsPageMessagesCell').html(messageHtml);
            $('#jsPageMessages').show();
        } else {
            var errMessageArray = [];
            errMessageArray.push('{!$Label.msg_00136}');

            var messageHtml = createMessageHtml(errMessageArray);
            $('#jsPageMessagesCell').html(messageHtml);
            $('#jsPageMessages').show();
        }
    };

    CsoScript_loadingStart();

    var urlFormDefinitionInfo = '/rest/FormDefinitionInfo';
    urlFormDefinitionInfo += '/';
    urlFormDefinitionInfo += USERNAME;
    urlFormDefinitionInfo += '/';
    urlFormDefinitionInfo += CREDENTIAL;
    urlFormDefinitionInfo += '/';
    urlFormDefinitionInfo += dto.objReportDefinition['{!$ObjectType.ReportDefinition__c.fields.WR_FormDefinitionId__c.Name}'];

    secureGetAsyncSfJsonAccess(urlFormDefinitionInfo, '', callback, callerror);
}

function makeFormat(sheetOrder) {

    var order = new Array();

    // サブシートシートを取得
    var orderSubReport = new Array();
    for(var j = 0; j<allSheets.length; j++){
        if(allSheets[j].sheet_name.indexOf("#") == 0){
            orderSubReport.push(allSheets[j]);
            allSheets.splice(j, 1);
        }
    }
    for(var i=0; i<sheetOrder.length;i++){
        var type = sheetOrder[i].type;
        if (type == 'sheet') {
            for(var j=0; j<allSheets.length; j++){
                if(sheetOrder[i].sheet_id == allSheets[j].sheet_id){
                    appendNode(order, allSheets[j]);
                    // 差込シートから削除
                    allSheets.splice(j, 1);
                }
            }

            for(var k=0; k<sheetOrder[i].insertions.length; k++){
                appendInsert(order, makeInsertInfo(randamStr(5), sheetNamesheetIdMap[sheetOrder[i].insertions[k].insert_sheet_name], sheetOrder[i].insertions[k].insert_condition), sheetOrder[i].sheet_id);
            }

        } else if (type == 'repeat') {
            var childlen = makeFormat(sheetOrder[i].children);
            var repeat = makeRepeatInfo(randamStr(5));
            repeat['children'] = childlen;
            order.push(repeat);
        } else if (type == 'trace') {
            var childlen = makeFormat(sheetOrder[i].children);
            var trace = makeTraceInfo(randamStr(5));
            trace['children'] = childlen;
            order.push(trace);
        }
    }

    // サブシートシートを追加
    for(var j = 0; j<orderSubReport.length; j++){
        if(orderSubReport[j].sheet_name.indexOf("#") == 0){
            appendNode(order, orderSubReport[j]);
        }
    }
    return order;
}


function overlaySearch() {
    //2013.01.22 #5068対処
    //window.open('/apex/FE_OverlaySearch' , '_blank', 'width=980,height=400,resizable=yes,toolbar=no,status=no,scrollbars=yes,menubar=no,directories=no,location=no,dependant=yes', true, true);
    window.open('{!$Page.FE_OverlaySearch}' , '_blank', 'width=980,height=400,resizable=yes,toolbar=no,status=no,scrollbars=yes,menubar=no,directories=no,location=no,dependant=yes', true, true);

}

function searchObject() {
    var searchPageUrl = "/apex/FE_ObjectSearch";
    //2013.01.22 #5068対処
    //window.open(searchPageUrl, 'document','width=600,height=400,scrollbars=yes,toolbar=no,status=no,directories=no,menubar=no,resizable=yes', true);
    window.open('{!$Page.FE_ObjectSearch}?callTYpe=new', 'document','width=600,height=400,scrollbars=yes,toolbar=no,status=no,directories=no,menubar=no,resizable=yes', true);

}

var parentNew = 'true';

//連想配列
var overlayColumnIDMap = {};








/**
 * オーバレイとオブジェクトのマッピングを作成する
 */
function createHtmlMappingTable(dto){

    var ecmImageShowFlg = false;

    var mappingTableRec = '';


    var sortOrderNumOptionHtml = '<option value=\"\"></option>';


    var sheetNameMap = {};

    var notSelectedSheets = new Array(allSheets.length);
    for(var i=0;i<allSheets.length;i++){
        notSelectedSheets[i] = allSheets[i].sheet_name;
    }

    for(var i=0; i < dto.overlayColumnDtoList.length;i++){

        if(dto.overlayColumnDtoList[i].objReportMapping['{!$ObjectType.reportMapping__c.fields.OverlaySheetNameList__c.Name}'] != undefined){
            var sheetNameList = dto.overlayColumnDtoList[i].objReportMapping['{!$ObjectType.reportMapping__c.fields.OverlaySheetNameList__c.Name}'].split(',');
            var isSelected = false;
            for(var j=0;j<sheetNameList.length;j++){
                if(notSelectedSheets.indexOf(sheetNameList[j]) >= 0){
                    continue;
                } else {
                    isSelected = true;
                    break;
                }
            }

            if(!isSelected){
                continue;
            }
        }

        if(dto.overlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.OverlayCulomnType__c.Name}']
                == '3'
            && dto.overlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.OverlayCulomnRef__c.Name}']
                == '3'){
            ecmImageShowFlg = true;
        }

        var indexOverlayColumnID = dto.overlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.OverlayCulomnID__c.Name}'].toLowerCase();

        if(indexOverlayColumnID.lastIndexOf('*')>-1){
            indexOverlayColumnID = indexOverlayColumnID.replace('*','');
        }

        overlayColumnIDMap[indexOverlayColumnID] = dto.overlayColumnDtoList[i];

        mappingTableRec += '<tr id=\"';
        mappingTableRec += i.toString();
        mappingTableRec += '\">';

        //シート名
        if(dto.overlayColumnDtoList[i].objReportMapping['{!$ObjectType.reportMapping__c.fields.OverlaySheetNameList__c.Name}'] != undefined){
            mappingTableRec += '<td >';
            mappingTableRec += dto.overlayColumnDtoList[i].objReportMapping['{!$ObjectType.reportMapping__c.fields.OverlaySheetNameList__c.Name}'];
            mappingTableRec += '</td>';
            mappingTableRec += '<td style=\"display:none;\" id=\"';
            mappingTableRec += 'hiddensheetid';
            mappingTableRec += i.toString();
            mappingTableRec += '\">';
            mappingTableRec += dto.overlayColumnDtoList[i].objReportMapping['{!$ObjectType.reportMapping__c.fields.OverlaySheetIDList__c.Name}'];
            mappingTableRec += '</td>';

            var sheetNameList = [];
            sheetNameList = dto.overlayColumnDtoList[i].objReportMapping['{!$ObjectType.reportMapping__c.fields.OverlaySheetNameList__c.Name}'].split(',');

            var sheetIDList = [];
            sheetIDList = dto.overlayColumnDtoList[i].objReportMapping['{!$ObjectType.reportMapping__c.fields.OverlaySheetIdList__c.Name}'].split(',');


            for(var j=0;j<sheetNameList.length;j++){

                sheetNameMap[sheetIDList[j]] = sheetNameList[j];

            }

        }else{
            mappingTableRec += '<td></td>';
            mappingTableRec += '<td style=\"display:none;\"></td>';
        }

        mappingTableRec += '<td id=\"overlayColumnID\" >';
        mappingTableRec += dto.overlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.OverlayCulomnID__c.Name}'];
        mappingTableRec += '</td><td id=\"relBreadcrumbs\" class=\"breadcrumbs\">';

        //if(dto.overlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.ObjectID__c.Name}'] == 'ＥＣＭ画像'){
        if(dto.overlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.ObjectID__c.Name}'] == 'ＥＣＭ画像'
            || dto.overlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.ObjectID__c.Name}'] == 'ECM_image'){
            mappingTableRec += '{!$Label.label_wf_29046}';

        //}else if(dto.overlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.ObjectID__c.Name}'] == 'ユーザ選択'){
        }else if(dto.overlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.ObjectID__c.Name}'] == 'ユーザ選択'
            || dto.overlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.ObjectID__c.Name}'] == 'Selection_of_users'){
            mappingTableRec += '{!$Label.label_wf_29047}';

        //}else if(dto.overlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.ObjectID__c.Name}'] == '自動画像'){
        }else if(dto.overlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.ObjectID__c.Name}'] == '自動画像'
            || dto.overlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.ObjectID__c.Name}'] == 'Automatic_Image'){
            mappingTableRec += '{!$Label.label_wf_29048}';
        }else{
            mappingTableRec += dto.overlayColumnDtoList[i]['relBreadcrumbsLabel'];
        }

        //if(dto.overlayColumnDtoList[i]['relBreadcrumbsLabel'] != ''){

            //mappingTableRec += ' > ';
            //mappingTableRec += dto.overlayColumnDtoList[i]['name'];
//            mappingTableRec += '(';
//            mappingTableRec += dto.overlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.ObjectCulomn__c.Name}'];
//            mappingTableRec += ')';
        //}

        mappingTableRec += '</td>';

        var droppableFlg = true;

        var autoImageFlg = false;

        var ecmImageFlg = false;

        if(dto.overlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.AutoImageNo__c.Name}'] != undefined){
            droppableFlg = false;
            autoImageFlg = true;
        }

        var overlayColumnType = '';

        if(dto.overlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.OverlayCulomnType__c.Name}'] != undefined){
            overlayColumnType = dto.overlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.OverlayCulomnType__c.Name}'];
        }

        var overlayColumnRef = '';

        if(dto.overlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.OverlayCulomnRef__c.Name}'] != undefined){
            overlayColumnRef = dto.overlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.OverlayCulomnRef__c.Name}'];
        }

        if(overlayColumnType == '3' && overlayColumnRef == '3'){
            droppableFlg = false;
            ecmImageFlg = true;
        }

        if(droppableFlg){

            mappingTableRec += '<td id=\"droptd\"><div class\=\"drops ui-droppable\" style\=\"z-index\:999\">';

            if(dto.overlayColumnDtoList[i]['name'] != ''){
                mappingTableRec += '<span id\=\"myInput\" class\=\"dropInputed\">';
                mappingTableRec += dto.overlayColumnDtoList[i]['name'];
                mappingTableRec += '</span>';
            }else{
                mappingTableRec += '<span id\=\"myInput\" class\=\"dropInput\"> </span>';
            }

            //mappingTableRec += '<img class=\"del\" src="{!URLFOR($Resource.FormFormat,'img/delete.png')}" height="18px"/>';
            mappingTableRec += '</div>';

            mappingTableRec += '<span class=\"tooltip\">';
            mappingTableRec += '{!$Label.label_wf_29018}';
            mappingTableRec += dto.overlayColumnDtoList[i]['name'];
            mappingTableRec += '<br />';
            mappingTableRec += '{!$Label.label_wf_29019}';
            mappingTableRec +=  dto.overlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.ObjectCulomn__c.Name}'];
            mappingTableRec += '</span>';
            mappingTableRec +='</td>';
        }else{

            mappingTableRec += '<td id=\"droptd\"><div class\=\"\" style\=\"z-index\:999\">';

            mappingTableRec += '<span style=\"padding:5px;width:102px;display:inline-block;\"> </span>';

            mappingTableRec += '</div>';

            mappingTableRec +='</td>';
        }

        if(dto.overlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.ObjectID__c.Name}'] == 'Input_Values'
            || dto.overlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.ObjectID__c.Name}'] == 'ユーザ入力'){ //ユーザ入力
            //mappingTableRec += '<td><input id=\"userInputField\" type=\"input\" value=\"';
            mappingTableRec += '<td >';
            if(dto.overlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.userInput__c.Name}'] != undefined){
                mappingTableRec += dto.overlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.userInput__c.Name}'];
            }else{
                mappingTableRec += '';
            }
            //mappingTableRec += '\"/><input id=\"userInputRequiredFlg\" value=\"';
            //mappingTableRec += dto.overlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.userInputrequiredFlg__c.Name}'];
            //mappingTableRec += '\" type=\"checkbox\" ><label>{!$Label.label_wf_00142}</label></td></tr>';
            if(dto.overlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.userInputrequiredFlg__c.Name}']){
                mappingTableRec += '<img src="/img/checkbox_checked.gif"/>';
            }else{
                mappingTableRec += '<img src="/img/checkbox_unchecked.gif"/>';
            }
            mappingTableRec += '<label>{!$Label.label_wf_00142}</label></td>';
        }else if(dto.overlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.ObjectID__c.Name}'] == 'Automatic_Numbering'
            || dto.overlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.ObjectID__c.Name}'] == '自動採番'){ //自動採番

            //mappingTableRec += '<td><select id=\"estimateNumber\" value=\"';
            //mappingTableRec += dto.overlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.ObjectCulomn__c.Name}'];
            //mappingTableRec += '\">';
            //mappingTableRec += EstimateNumberingOptionsAppendHtml;
            //mappingTableRec += '</select></td>';

            mappingTableRec += '<td >';
            if(dto.overlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.ObjectCulomn__c.Name}'] != undefined){
                //mappingTableRec += dto.overlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.ObjectCulomn__c.Name}'];

                for(var j=0;j<EstimateNumberingList.length;j++){
                    if(dto.overlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.ObjectCulomn__c.Name}']
                            == EstimateNumberingList[j]['{!$ObjectType.EstimateNumbering__c.fields.Id.Name}']){
                        mappingTableRec += EstimateNumberingList[j]['{!$ObjectType.EstimateNumbering__c.fields.Name.Name}'];
                        mappingTableRec += ' ';
                        mappingTableRec += EstimateNumberingList[j]['{!$ObjectType.EstimateNumbering__c.fields.NumberingFormat__c.Name}'];
                    }
                }
            }
            mappingTableRec += '</td>';

        }else if(dto.overlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.ObjectID__c.Name}'] == 'ECM_image'
            || dto.overlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.ObjectID__c.Name}'] == 'ＥＣＭ画像'){ //ＥＣＭ画像

            var thumid = 'thum' + i.toString();
            if(contentsPropertyMap[dto.overlayColumnDtoList[i].contentsId] != null
            && contentsPropertyMap[dto.overlayColumnDtoList[i].contentsId] != undefined){
                mappingTableRec += '<td ><span id=\"';
                mappingTableRec += thumid;
                mappingTableRec += '\">';
                mappingTableRec += '<img src=\"';
                mappingTableRec += contentsPropertyMap[dto.overlayColumnDtoList[i].contentsId].thumb_36x36;
                mappingTableRec += '\" style=\"border: none; width: 36px; height: 36px;\"/>';
                mappingTableRec += '</span>';
                mappingTableRec += '<input id=\"docid\" type=\"hidden\" value=\"';
                mappingTableRec += dto.overlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.tempPicID__c.Name}'];
                mappingTableRec += '\"/></td>';
            }else if(dto.overlayColumnDtoList[i].contentsId != ''
                        && dto.overlayColumnDtoList[i].contentsId != null){
                mappingTableRec += '<td >';
                mappingTableRec += '{!$Label.label_wf_29043}';
                mappingTableRec += '</td>';
            }else{

                mappingTableRec += '<td></td>';

            }
        }else if(dto.overlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.ObjectID__c.Name}'] == 'Selection_of_users'
            || dto.overlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.ObjectID__c.Name}'] == 'ユーザ選択'){ //ユーザ選択

            if(dto.overlayColumnDtoList[i].userSelectImageFlg){
                mappingTableRec += '<td >{!$Label.label_wf_29043}</td>';
            }else{
                mappingTableRec += '<td></td>';
            }

        }else if(dto.overlayColumnDtoList[i].isDetailItem){
            mappingTableRec += '<td style=\"text-align:left;\" >';
            if(dto.overlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.SearchOperator__c.Name}'] != undefined){
                var operationStr = dto.overlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.SearchOperator__c.Name}'];
                switch (operationStr){
                    case 'e' : operationStr = '{!$Label.label_wr_search_e_00001}'; break;
                    case 'n' : operationStr = '{!$Label.label_wr_search_n_00002}'; break;
                    case 's' : operationStr = '{!$Label.label_wr_search_s_00003}'; break;
                    case 'c' : operationStr = '{!$Label.label_wr_search_c_00004}'; break;
                    case 'k' : operationStr = '{!$Label.label_wr_search_k_00005}'; break;
                    case 'l' : operationStr = '{!$Label.label_wr_search_l_00006}'; break;
                    case 'g' : operationStr = '{!$Label.label_wr_search_g_00007}'; break;
                    case 'm' : operationStr = '{!$Label.label_wr_search_m_00008}'; break;
                    case 'h' : operationStr = '{!$Label.label_wr_search_h_00009}'; break;
                    case 'u' : operationStr = '{!$Label.label_wr_search_u_00010}'; break;
                    case 'x' : operationStr = '{!$Label.label_wr_search_x_00011}'; break;
                    case 'w' : operationStr = '{!$Label.label_wr_search_w_00012}'; break;
                }
                mappingTableRec += operationStr;
            }else{
                mappingTableRec += '';
            }
            if(dto.overlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.SearchValue__c.Name}'] != undefined){
                mappingTableRec += ':';
                mappingTableRec += dto.overlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.SearchValue__c.Name}'];
            }else{
                mappingTableRec += '';
            }
            mappingTableRec += '</td>';
        }else{
            mappingTableRec += '<td></td>';
        }


        //ソート順
        if(dto.overlayColumnDtoList[i].isDetailItem){

            //mappingTableRec += '<td id=\"sortOrderNum\" > <select value=\"';
            //mappingTableRec += dto.overlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.SortOrderNum__c.Name}'];
            //mappingTableRec += '\">'

            //for(var j=1;j <= dto.cntDetailItem;j++){
            //    if(dto.overlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.SortOrderNum__c.Name}'] != j){
            //        sortOrderNumOptionHtml += '<option value=\"';
            //    }else{
            //        sortOrderNumOptionHtml += '<option selected=\"selected\" value=\"';
            //    }

            //    sortOrderNumOptionHtml += j;
            //    sortOrderNumOptionHtml += '\">';
            //    sortOrderNumOptionHtml += j;
            //    sortOrderNumOptionHtml += '</option>';
            //}

            //mappingTableRec += sortOrderNumOptionHtml;

            //sortOrderNumOptionHtml = '<option value=\"\"></option>';

            //mappingTableRec += '</select></td>';
            mappingTableRec += '<td style=\"text-align:right;\" >';
            if(dto.overlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.SortOrderNum__c.Name}'] != undefined){
                mappingTableRec += dto.overlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.SortOrderNum__c.Name}'];
            }else{
                mappingTableRec += '';
            }
            mappingTableRec += '</td>';

            //mappingTableRec += '<td id=\"sortType\" class=\"sortType\" ><select value=\"';
            //mappingTableRec += dto.overlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.SortType__c.Name}'];

            //mappingTableRec += '\">';

            //var sortTypeOptionHtml = '<option value=\"\"></option>';

            //if(dto.overlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.SortType__c.Name}'] == 'asc'){
            //    sortTypeOptionHtml += '<option selected=\"selected\" value=\"';
            //    sortTypeOptionHtml += dto.overlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.SortType__c.Name}'];
            //    sortTypeOptionHtml += '\">{!$Label.label_wf_30078}</option>';
            //}else{
            //    sortTypeOptionHtml += '<option value=\"';
            //    sortTypeOptionHtml += 'desc';
            //    sortTypeOptionHtml += '\">{!$Label.label_wf_30078}</option>';
            //}

            //if(dto.overlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.SortType__c.Name}'] == 'desc'){
            //    sortTypeOptionHtml += '<option selected=\"selected\" value=\"';
            //    sortTypeOptionHtml += dto.overlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.SortType__c.Name}'];
            //    sortTypeOptionHtml += '\">{!$Label.label_wf_30079}</option>';
            //}else{
            //    sortTypeOptionHtml += '<option value=\"';
            //    sortTypeOptionHtml += 'asc';
            //    sortTypeOptionHtml += '\">{!$Label.label_wf_30079}</option>';
            //}

            //mappingTableRec += sortTypeOptionHtml;
            //mappingTableRec += '</select></td>';

            mappingTableRec += '<td >';
            if(dto.overlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.SortType__c.Name}'] == 'asc'){
                mappingTableRec += '{!$Label.label_wf_30078}';
            }else if(dto.overlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.SortType__c.Name}'] == 'desc'){
                mappingTableRec += '{!$Label.label_wf_30079}';
            }else {
                mappingTableRec += '';
            }
            mappingTableRec += '</td>';

        }else{
            mappingTableRec += '<td id=\"sortOrderNum\" ></td>';
            mappingTableRec += '<td id=\"sortType\"  ></td>';
        }
        mappingTableRec += '</tr>';
    }


    if(ecmImageShowFlg){
        $('div[id$=ecmImage]').show();
    }else{
        $('div[id$=ecmImage]').hide();
    }

    $('#mappingTable').children('tbody').html(mappingTableRec);
    createDroppable();
    createDraggable();


    $('input[id$="userInputRequiredFlg"]').each(function(){

        //$(this).val($(this).val());
        if($(this).val()=='true'){
            $(this).attr('checked',true);
        }
    });

    deleteDrags();
    //明細ソート順番号の選択リストにonchangeイベントを付与する
    onchangeDetailSortOrderNum();

    //明細ソートタイプの選択リストにonchangeイベントを付与する
    onchangeDetailSortType();



    var sheetNameOptionHtml = '<option value=\"\"></option>';



    for(var key in sheetNameMap){

        sheetNameOptionHtml += '<option value=\"';
        sheetNameOptionHtml += key;
        sheetNameOptionHtml += '\">';
        sheetNameOptionHtml += sheetNameMap[key];
        sheetNameOptionHtml += '</option>';


    }

    $('#sheetList').html(sheetNameOptionHtml);



    objectReturn(dto.objReportDefinition['{!$ObjectType.ReportDefinition__c.fields.ObjectLabel__c.Name}'],dto.objReportDefinition['{!$ObjectType.ReportDefinition__c.fields.ObjectID__c.Name}']);

}

//連想配列
var mapOverlayColumnIDMap = {};

/**
 * 地図連携のマッピング情報を生成する
 */
function createHtmlMapsMappingTable(dto){

    var mappingTableRec = '';



    for(var i=0; i < dto.mapOverlayColumnDtoList.length;i++){

        var indexOverlayColumnID = dto.mapOverlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.keyName__c.Name}'];
        indexOverlayColumnID += ':';
        indexOverlayColumnID += dto.mapOverlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.OverlayCulomnID__c.Name}'];

        overlayColumnIDMap[indexOverlayColumnID] = dto.mapOverlayColumnDtoList[i];

        mappingTableRec += '<tr>';

        if(dto.mapOverlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.OverlaySheetNameList__c.Name}'] != undefined){

            mappingTableRec += '<td>';
            mappingTableRec += dto.mapOverlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.OverlaySheetNameList__c.Name}'];
            mappingTableRec += '</td>';

            mappingTableRec += '<td style=\"display:none;\" id=\"';
            mappingTableRec += 'hiddenmapsheetid';
            mappingTableRec += i.toString();
            mappingTableRec += '\">';
            mappingTableRec += dto.mapOverlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.OverlaySheetIDList__c.Name}'];
            mappingTableRec += '</td>';

        }else{
            mappingTableRec += '<td></td>';
            mappingTableRec += '<td style=\"display:none;\">';
        }

//        mappingTableRec += '<td id=\"keyName\">';
//        mappingTableRec += dto.mapOverlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.keyName__c.Name}'];
        mappingTableRec += '<td id=\"mapName\">';
        mappingTableRec += dto.mapOverlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.mapName__c.Name}'];
        mappingTableRec += '</td><td id=\"imageSize\">';
        mappingTableRec += dto.mapOverlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.MapHeight__c.Name}'];
        mappingTableRec += '{!$Label.label_wf_00447}';
        mappingTableRec += dto.mapOverlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.MapWidth__c.Name}'];

        mappingTableRec += '</td><td id=\"overlayColumnID\">';
        mappingTableRec += dto.mapOverlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.OverlayCulomnID__c.Name}'];
        mappingTableRec += '</td><td id=\"relBreadcrumbs\" class=\"breadcrumbs\">';
        mappingTableRec += dto.mapOverlayColumnDtoList[i]['relBreadcrumbsLabel'];


        if(dto.mapOverlayColumnDtoList[i]['relBreadcrumbsLabel'] != ''){

            mappingTableRec += ' > ';
            mappingTableRec += dto.mapOverlayColumnDtoList[i]['name'];
//            mappingTableRec += '(';
//            mappingTableRec += dto.mapOverlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.ObjectCulomn__c.Name}'];
//            mappingTableRec += ')';
        }

        mappingTableRec += '<td id=\"droptd\"><div class\=\"drops ui-droppable\" style\=\"z-index\:999\">';

        if(dto.mapOverlayColumnDtoList[i]['name'] != ''){
            mappingTableRec += '<span id\=\"myInput\" class\=\"dropInputed\">';
            mappingTableRec += dto.mapOverlayColumnDtoList[i]['name'];
            mappingTableRec += '</span>';
        }else{
            mappingTableRec += '<span id\=\"myInput\" class\=\"dropInput\"></span>';
        }

        //mappingTableRec += '<img class=\"del\" src="{!URLFOR($Resource.FormFormat,'img/delete.png')}" height="18px"/>';
        mappingTableRec += '</div>';

        mappingTableRec += '<span class=\"tooltip\">';
        mappingTableRec += '{!$Label.label_wf_29018}';
        mappingTableRec += dto.mapOverlayColumnDtoList[i]['name'];
        mappingTableRec += '<br />';
        mappingTableRec += '{!$Label.label_wf_29019}：';
        mappingTableRec +=  dto.mapOverlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.ObjectCulomn__c.Name}'];
        mappingTableRec += '</span>';
        mappingTableRec +='</td>';

        //if(dto.mapOverlayColumnDtoList[i].name == 'ユーザ入力'){
        //    mappingTableRec += '<td><input id=\"userInputField\" type=\"input\" value=\"';
        //    mappingTableRec += dto.mapOverlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.userInput__c.Name}'];
        //    mappingTableRec += '\"/><input id=\"userInputRequiredFlg\" value=\"';
        //    mappingTableRec += dto.mapOverlayColumnDtoList[i].objReportMapping['{!$ObjectType.ReportMapping__c.fields.userInputrequiredFlg__c.Name}'];
        //    mappingTableRec += '\" type=\"checkbox\" ><label>{!$Label.label_wf_00142}</label></td></tr>';
        //}else{
            mappingTableRec += '<td></td></tr>';
        //}

    }



    $('#mapsMappingTable').children('tbody').html(mappingTableRec);
    createDroppable();
    createDraggable();



    deleteDrags();


}

/**
 * 自動マッピング
 */
function autoMapping(){

    $('#mappingTable tbody tr').each(function(){

        var indexOverlayColumnID = $(this).children('#overlayColumnID').text().toLowerCase();
        var dropE = $(this).children('#droptd').children('div');

        if(indexOverlayColumnID.lastIndexOf('*')>0){
            indexOverlayColumnID = indexOverlayColumnID.replace('*','');
        }

        //var dragId = $(esc('page:form:reportOutText_lkid')).val()+'-'+indexOverlayColumnID;
        var dragId = $('[id$="reportOutText_lkid"]').val()+'-'+indexOverlayColumnID;




        var dragE = $(esc(dragId));






        if(undefined != dragE.attr('id')){
            dropMapping(dragId,dragE,dropE);
        }

    });


}



/**
 * オブジェクト検索画面からのコールバック
 */
function objectReturn(label,name) {

    if(name == '' || name == undefined){
        return;
    }

    //$(esc('page:form:reportOutText')).val(label);
    $('[id$="reportOutText"]').val(label);
    //$(esc('page:form:reportOutText_lkid')).val(name);
    $('[id$="reportOutText_lkid"]').val(name);

    var treeAppendHtml = '';

    //ユーザ入力項目
    treeAppendHtml += '<li ><span data-name=\"userInput\" ';
    //treeAppendHtml += 'data-objName=\"userInput\" ';
    //treeAppendHtml += 'data-objName=\"ユーザ入力\" ';
    treeAppendHtml += 'data-objName=\"Input_Values\" ';
    treeAppendHtml += 'data-type=\"others\" ';
    treeAppendHtml += 'id=\"root-UserInput\" ';
    treeAppendHtml += 'onclick=\"getTreeViewCustom(this);\">';
    treeAppendHtml += '{!$Label.label_wf_30051}';
    treeAppendHtml += '</span></li>';

    //現在日時項目
    treeAppendHtml += '<li ><span data-name=\"datetimeToday\" ';
    //treeAppendHtml += 'data-objName=\"datetimeToday\" ';
    //treeAppendHtml += 'data-objName=\"現在日時\" ';
    treeAppendHtml += 'data-objName=\"Now_Date\" ';
    treeAppendHtml += 'data-type=\"datetime\" ';
    treeAppendHtml += 'id=\"root-datetimeToday\" ';
    treeAppendHtml += 'onclick=\"getTreeViewCustom(this);\">';
    treeAppendHtml += '{!$Label.label_wf_30048}';
    treeAppendHtml += '</span></li>';

    //自動採番項目
    treeAppendHtml += '<li ><span data-name=\"estimateNumber\" ';
    //treeAppendHtml += 'data-objName=\"estimateNumber\" ';
    //treeAppendHtml += 'data-objName=\"自動採番\" ';
    treeAppendHtml += 'data-objName=\"Automatic_Numbering\" ';
    treeAppendHtml += 'data-type=\"others\" ';
    treeAppendHtml += 'id=\"root-EstimateNumber\" ';
    treeAppendHtml += 'onclick=\"getTreeViewCustom(this);\" >';
    treeAppendHtml += '{!$Label.label_wf_30002}';
    treeAppendHtml += '</span></li>';

    //組織項目
    treeAppendHtml += '<li ><span data-name\=\"';
    treeAppendHtml += '{!$ObjectType.Organization.Name}';
    treeAppendHtml += '\" data-objName\=\"';
    treeAppendHtml += '{!$ObjectType.Organization.Name}';
    treeAppendHtml += '\" data-type\=\"sObject\" id\=\"root-';
    treeAppendHtml += '{!$ObjectType.Organization.Name}';
    treeAppendHtml += '\" onclick\=\"getTreeView(this);\">';
    treeAppendHtml += '{!$ObjectType.Organization.Label}';
    treeAppendHtml += '(';
    treeAppendHtml += '{!$ObjectType.Organization.Name}';
    treeAppendHtml += ')';
    treeAppendHtml += '</span></li>';

    //空のtreeViewRecDtoを取得
    var orgTreeViewRecDto = $.extend(true,{},TreeViewRecDtoInstance);


    //var objMappingOrg = {};

    //objMappingOrg['{!$ObjectType.ReportMapping__c.fields.attributetype__c.Name}'] = '';
    //objMappingOrg['{!$ObjectType.ReportMapping__c.fields.ObjectID__c.Name}'] = '{!$ObjectType.Organization.Name}';

    //orgTreeViewRecDto.reportMappingList.push(objMappingOrg);

    orgTreeViewRecDto.relBreadcrumbsLabel += '{!$ObjectType.Organization.Label}';
    orgTreeViewRecDto.relBreadcrumbsLabel += '(';
    orgTreeViewRecDto.relBreadcrumbsLabel += '{!$ObjectType.Organization.Name}';
    orgTreeViewRecDto.relBreadcrumbsLabel += ')';
    //orgTreeViewRecDto.relBreadcrumbsLabel += '>';

    dragTrackMap['root-{!$ObjectType.Organization.Name}'] = orgTreeViewRecDto;

    //ユーザ項目
    treeAppendHtml += '<li ><span data-name\=\"';
    treeAppendHtml += '{!$ObjectType.User.Name}';
    treeAppendHtml += '\" data-objName\=\"';
    treeAppendHtml += '{!$ObjectType.User.Name}';
    treeAppendHtml += '\" data-type\=\"sObject\" id\=\"root-';
    treeAppendHtml += '{!$ObjectType.User.Name}';
    treeAppendHtml += '\" onclick\=\"getTreeView(this);\">';
    treeAppendHtml += '{!$ObjectType.User.Label}';
    treeAppendHtml += '(';
    treeAppendHtml += '{!$ObjectType.User.Name}';
    treeAppendHtml += ')';
    treeAppendHtml += '</span></li>';


    //空のtreeViewRecDtoを取得
    var userTreeViewRecDto = $.extend(true,{},TreeViewRecDtoInstance);


    //var objMappingUser = {};

    //objMappingUser['{!$ObjectType.ReportMapping__c.fields.attributetype__c.Name}'] = '';
    //objMappingUser['{!$ObjectType.ReportMapping__c.fields.ObjectID__c.Name}'] = '{!$ObjectType.User.Name}';
    //userTreeViewRecDto.reportMappingList.push(objMappingUser);

    userTreeViewRecDto.relBreadcrumbsLabel += '{!$ObjectType.User.Label}';
    userTreeViewRecDto.relBreadcrumbsLabel += '(';
    userTreeViewRecDto.relBreadcrumbsLabel += '{!$ObjectType.User.Name}';
    userTreeViewRecDto.relBreadcrumbsLabel += ')';
    //userTreeViewRecDto.relBreadcrumbsLabel += '>';

    dragTrackMap['root-{!$ObjectType.User.Name}'] = userTreeViewRecDto;


    //選択したオブジェクト項目
    treeAppendHtml += '<li ><span data-name\=\"';
    treeAppendHtml += name;
    treeAppendHtml += '\" data-objName\=\"';
    treeAppendHtml += name;
    treeAppendHtml += '\" data-type\=\"sObject\" id\=\"root-';
    treeAppendHtml += name;
    treeAppendHtml += '\" onclick\=\"getTreeView(this);\">';
    treeAppendHtml += label;
    treeAppendHtml += '(';
    treeAppendHtml += name;
    treeAppendHtml += ')';
    treeAppendHtml += '</span></li>';

    var objHtml = '';
    objHtml += '<span data-name\=\"';
    objHtml += name;
    objHtml += '\" data-objName\=\"';
    objHtml += name;
    objHtml += '\" data-type\=\"sObject\" id\=\"root-';
    objHtml += name;
    objHtml += '\" onclick\=\"getTreeView(this);\">';
    objHtml += label;
    objHtml += '(';
    objHtml += name;
    objHtml += ')';
    objHtml += '</span>';

    //空のtreeViewRecDtoを取得
    var returnObjTreeViewRecDto = $.extend(true,{},TreeViewRecDtoInstance);

    //var objMappingReturnObj = {};

    //objMappingReturnObj['{!$ObjectType.ReportMapping__c.fields.attributetype__c.Name}'] = '';
    //objMappingReturnObj['{!$ObjectType.ReportMapping__c.fields.ObjectID__c.Name}'] = name;
    //returnObjTreeViewRecDto.reportMappingList.push(objMappingReturnObj);

    returnObjTreeViewRecDto.relBreadcrumbsLabel += label;
    returnObjTreeViewRecDto.relBreadcrumbsLabel += '(';
    returnObjTreeViewRecDto.relBreadcrumbsLabel += name;
    returnObjTreeViewRecDto.relBreadcrumbsLabel += ')';
    //returnObjTreeViewRecDto.relBreadcrumbsLabel += '>';

    dragTrackMap['root-'+name] = returnObjTreeViewRecDto;



    $('#tv').html(treeAppendHtml);
    $("#tv").treeview();

    $('#ulDrags').html('');

    $('#root-'+name).trigger("click");
}

var userAgent = getBrowserType();

/**
 * エラーメッセージを作成する
 */
function createMessageHtml(messageArray){

    var messageHtml = '';
    messageHtml = '<div id=\"messageDiv\" class=\"messageText\">';
    messageHtml += '<span id=\"messageSpan\" style=\"color:#cc0000\">';
    messageHtml += '<h4>{!$Label.label_10716}</h4>';
    messageHtml += '</span>';
    messageHtml += '<span>';
    messageHtml += '<ul style="padding-left:10px;padding-top:0px;margin:0px">';

    for(var i=0;i<messageArray.length;i++){

        messageHtml += '<li style="padding-top:5px">';
        messageHtml += messageArray[i];
        messageHtml += '</li>';
    }

    messageHtml += '</span>';
    messageHtml += '<br />';
    messageHtml += '</div>';

    return messageHtml;
}




/**
 * クイック検索
 */
function quickSearch(item){

    var searchText = document.getElementById(item.id).value.toLowerCase();
    var cntDragE = 0;
    $(".drags").each(function(){
        var objDragE = $(this);

        if(objDragE.attr('data-search').indexOf(searchText)>-1){
            cntDragE++;

            objDragE.show('fast');
            //objDragE.slideDown('slow');
        }else{
            objDragE.hide('fast');
        }

    });



    /*
    if(cntDragE<20){
        //$('#ulDrags').css('width','500px');
        $('#ulDrags').width($('#tabMapping').width()-200);
        if(500<$('#tabMapping').width()-250){
                        $('#divDrags').width($('#tabMapping').width()-250);
                    }else{
                        $('#divDrags').width(500);
                    }
    }else{
        var w = ((cntDragE/4)+1)*100;
        //var w = ((cntDragE/4)+1)*50;

        $('#ulDrags').css('width',w+'px');
        if(500<$('#tabMapping').width()-250){
                        $('#divDrags').width($('#tabMapping').width()-250);
                    }else{
                        $('#divDrags').width(500);
                    }
    }
    */
    resizeDragsAreaWidth(cntDragE);
}

function delQuickSearchText(){

    $('#quick').val('');
    $('#quick').trigger("keyup");
}

</script>
                                    <div id="tabMapping" style="/*background-color:#f2f2f3;*/overflow: auto; /*width:730px;*/ min-width:950px; min-height: 730px; display:none;" class="notdrops ui-tabs-panel ui-widget-content ui-corner-bottom">

                                        <div id="navTab" class="" style="display:none;border-style: solid;border-color:#ddd;background:white;min-width:720px;height:100px;border-radius: 5px;-webkit-border-radius: 5px;-moz-border-radius: 5px;">
                                            <div style="float:left;overflow:scroll; width:200px;height:100px;" >
                                                <div id="divtreeview" style="width:1000px/*;height:1000px;*/">
                                                    <ul id="tv" class="treeview">

                                                    </ul>
                                                </div>
                                            </div>
                                            <div id="divDrags" class="scrollOn" style="z-index:999;/*overflow-x:scroll;overflow-y:hidden;*/ float:left; min-width:500px;height:100px;">

                                                <div>
                                                    <img id="quickIcon" src="/img/ple/search20.gif" />
                                                    <label>{!$Label.label_wf_29022}</label>
                                                    <input id="quick" value="" onchange="quickSearch(this);" onkeyup="quickSearch(this);"/>
                                                    <span style="display:inline-block;vertical-align:middle;">
                                                        <img id="quickDel" onclick="delQuickSearchText();" src="{!URLFOR($Resource.FormFormat,'img/delete.png')}" height="18px" />
                                                    </span>
                                                </div>
                                                <div id="ulDrags" class="clearfix" style="z-index:0;float:left; min-width:500px;">

                                                </div>

                                            </div>
                                        </div>
                                        <span id="hiddentooltip" class="tooltip" style="display:none;"></span>
                                        <!--
                                        <div id="article" style="/*background-color:#f2f2f3;*/z-index:0">
                                         -->
                                            <!--
                                            <input type="button" value="自動マッピング" onclick="autoMapping();"/>
                                             -->

                                            <apex:pageBlockSection showHeader="false" title="{!$Label.solxyzcso001__label_wf_00060}" columns="1" id="sectionM" collapsible="false">
                                                <table id="mappingTable" style="/*background-color:white;*/">
                                                    <thead>
                                                        <tr>
                                                            <th style="width:10%;">{!$Label.label_wf_29024}</th>
                                                            <th style="display:none;">{!$Label.label_wf_29025}</th>
                                                            <th style="width:20%;">{!$Label.label_wf_00061}</th>
                                                            <th style="width:20%;">{!$Label.solxyzcso001__label_wf_00050}</th>
                                                            <th style="width:20%">{!$Label.label_wf_00062}</th>
                                                            <th style="width:20%;"></th>
                                                            <th colspan="2" style="width:10%;">{!$Label.label_wf_30077}</th>
                                                            <!--
                                                            <th style=""></th>
                                                             -->
                                                        </tr>
                                                    </thead>
                                                    <tbody>

                                                    </tbody>
                                                </table>
                                                <span id="hiddentooltip2" class="tooltip" style="display:none;"></span>
                                            </apex:pageBlockSection>

                                            <!-- 地図情報 -->
                                            <apex:pageBlockSection title="{!$Label.solxyzcso001__label_wf_00444}" columns="1" id="sectionMap" collapsible="false">
                                                <table id="mapsMappingTable">
                                                    <thead>
                                                        <tr>
                                                            <th style="width:10%;">{!$Label.label_wf_29024}</th>
                                                            <th style="display:none;">{!$Label.label_wf_29025}</th>
                                                            <th style="width:20%;">{!$Label.label_wf_00445}</th>
                                                            <th style="width:20%;">{!$Label.label_wf_00446}</th>
                                                            <th style="width:10%;">{!$Label.label_wf_00061}</th>
                                                            <th style="width:20%;">{!$Label.solxyzcso001__label_wf_00050}</th>
                                                            <th style="width:20%;">{!$Label.label_wf_00062}</th>
                                                            <th style="width:20%;"></th>
                                                        </tr>
                                                    </thead>
                                                    <tbody></tbody>
                                                </table>
                                            </apex:pageBlockSection>
                                        <!--
                                        </div>
                                         -->
                                        <!-- /#article -->

                                    </div>
<!-- マッピングタブ END -->
<!-- セキュリティタブ START -->
<script type="text/javascript">

jQuery.event.add(window, "load", function(){

     // Settings Explanation memainds
//    $("textarea[id$=explanation]").keyup(function(){
//        viewCommentLength2("textarea[id$=explanation]", "explanationRemainder", 512);
//    });
//    viewCommentLength2("textarea[id$=explanation]", "explanationRemainder", 512);

    changeEncryption();
    chkCHange('pwChk');
    chkCHange('mpwChk');

    $('input[id$="securityPw"]').val("{!JSENCODE(rd.securityPw__c)}");
    $('input[id$="securityMpw"]').val("{!JSENCODE(rd.securityMpw__c)}");

     //追加リストの空行を削除する。
    $(collabo + '\\:' +  'added').children().each(function(){
        if($(this).val() == ''){
            $(this).remove();
        }
    });
});

function viewCommentLength2(t, v, maxSize){
    var regexp = RegExp(/\r\n|\r|\n/g);
    var str = $(t).val().replace(regexp, "\r\n");
    var size = maxSize - str.length;

    if(size <= 0){
        $("#" + v).css("color","#FF0000");
    }else{
        $("#" + v).css("color","#000000");
    }

    $("#" + v).text(getMsg(new Array(size + ""), '{!$Label.label_wf_10227}'));
}

// セキュリティ設定の制御
function changeEncryption(){
    var level = "";
    //var security = document.getElementById("page0:myform:myBlock:Section:securitySection:security1:securityLevel").value;
    var security = $('select[id$="securityLevel"]').val();



    if(security == '0'){
        // Acrobat3.0およびそれ以降
        level = "40-bit RC4";
        $('input[id$="pwChkBox"]').removeAttr("disabled");
        $('input[id$="mpwChkBox"]').removeAttr("disabled");
        $('select[id$="securityPrint"]').attr("disabled", "disabled");
        $('select[id$="securityEdit"]').removeAttr("disabled");
        $('select[id$="securityAssembly"]').attr("disabled", "disabled");
        $('select[id$="securityCopy"]').removeAttr("disabled");
        $('select[id$="securityAccessibility"]').attr("disabled", "disabled");
        $('select[id$="securityNote"]').removeAttr("disabled");
        $('select[id$="securityFf"]').attr("disabled", "disabled");

    }else if(security == '1'){
        // Acrobat5.0およびそれ以降及びAcrobat6.0およびそれ以降
        level = "128-bit RC4";
        $('input[id$="pwChkBox"]').removeAttr("disabled");
        $('input[id$="mpwChkBox"]').removeAttr("disabled");
        $('select[id$="securityPrint"]').removeAttr("disabled");
        $('select[id$="securityEdit"]').removeAttr("disabled");
        $('select[id$="securityAssembly"]').removeAttr("disabled");
        $('select[id$="securityCopy"]').removeAttr("disabled");
        $('select[id$="securityAccessibility"]').removeAttr("disabled");
        $('select[id$="securityNote"]').removeAttr("disabled");
        $('select[id$="securityFf"]').removeAttr("disabled");

    }else if(security == '2'){
        // Acrobat7.0およびそれ以降
        level = "128-bit AES";
        $('input[id$="pwChkBox"]').removeAttr("disabled");
        $('input[id$="mpwChkBox"]').removeAttr("disabled");
        $('select[id$="securityPrint"]').removeAttr("disabled");
        $('select[id$="securityEdit"]').removeAttr("disabled");
        $('select[id$="securityAssembly"]').removeAttr("disabled");
        $('select[id$="securityCopy"]').removeAttr("disabled");
        $('select[id$="securityAccessibility"]').removeAttr("disabled");
        $('select[id$="securityNote"]').removeAttr("disabled");
        $('select[id$="securityFf"]').removeAttr("disabled");

    }else if(security == 'all'){

        // すべて
        level = "なし";
        $('input[id$="pwChkBox"]').attr("disabled", "disabled");
        $('input[id$="pwChkBox"]').attr("disabled", "true");
        $('input[id$="mpwChkBox"]').attr("disabled", "disabled");
        $('select[id$="securityPrint"]').attr("disabled", "disabled").val('');
        $('select[id$="securityEdit"]').attr("disabled", "disabled");
        $('select[id$="securityAssembly"]').attr("disabled", "disabled");
        $('select[id$="securityCopy"]').attr("disabled", "disabled");
        $('select[id$="securityAccessibility"]').attr("disabled", "disabled");
        $('select[id$="securityNote"]').attr("disabled", "disabled");
        $('select[id$="securityFf"]').attr("disabled", "disabled");

        $('input[id$="securityPw"]').attr("disabled");
        $('input[id$="securityMpw"]').attr("disabled");
        $('input[id$="securityPw"]').css("background-color","#ffffff");
        $('input[id$="securityMpw"]').css("background-color","#ffffff");

        $('input[id$="pwChkBox"]').removeAttr("checked");
        $('input[id$="mpwChkBox"]').removeAttr("checked");

        $('input[id$="securityPw"]').val("");
        $('input[id$="securityMpw"]').val("");

        chkCHange("pwChk");
        chkCHange("mpwChk");

    }

    $("#security2_text").text(level);
}

// パスワードの入力制御
function chkCHange(id){

    var chkPW = $('input[id$="pwChkBox"]').attr("checked");
    var chkMPW = $('input[id$="mpwChkBox"]').attr("checked");

    if(id == "pwChk"){
        if(chkPW){
            $('input[id$="securityPw"]').val("need");
        }else{
            $('input[id$="securityPw"]').val("");
        }
    }else if(id == "mpwChk"){
        if(chkMPW){
            $('input[id$="securityMpw"]').val("need");
        }else{
            $('input[id$="securityMpw"]').val("");
        }
    }
}

// パスワードの入力チェック
function chkPwInput(){

    var selectSecurity = $('input[id$="securityLevel"]').val();
    var chkPWB         = $('input[id$="pwChkBox"]').attr("checked");
    var chkMPWB        = $('input[id$="mpwChkBox"]').attr("checked");
    var pwInput        = $('input[id$="securityPw"]').val();
    var mpwInput       = $('input[id$="securityMpw"]').val();

    if(selectSecurity != 'all'){
        if(chkPWB && pwInput == ""){
            alert("{!$Label.message_wf_30003}");

            return false;
        }

        if(chkMPWB && mpwInput == ""){
            alert("{!$Label.message_wf_30004}");
            return false;
        }
    }

    return true;
}

/**
 *2012.11.29 #4371対応 add start
 *権限ユーザ/グループ/ロール表示切り替え
 */

//==========//
//  onload  //
//==========//
var ReportUser_userIdList = new Array();     //  有効なユーザのユーザID一覧

//==========================//
//  有効なユーザ一覧の生成  //
//==========================//
function createUserIdList(){
    <apex:repeat value="{!userIdList}" var="userId">
        ReportUser_userIdList[ReportUser_userIdList.length] = "{!userId}";
    </apex:repeat>

// ユーザ一覧をクリア
    var limitsList = $("#limitsList");
    //alert("limitsList=" + limitsList);
    limitsList.empty();
    //alert("ユーザ一覧追加手前");
    //alert("ReportUser_userIdList=" + ReportUser_userIdList);
    for(var i = 0; i<ReportUser_userIdList.length ; i++){
        //alert("ReportUser_userIdList" + i + "=" + ReportUser_userIdList[i]);
        var li = $(createOptionTagString(i,ReportUser_userIdList[i]));
        limitsList.append(li);
    }

    //alert("limitsList=" + limitsList);

}

/**
  *20121130 #4371 add start
  * 移動
  */
function getId(id) {
    return '#' + id.replace(/(:|\.)/g,'\\\\$1');
}

//権限選択リストの移動
//var collabo = getId('{!$Component.reportDetail.form.block:sectionK:blocksectionK}');
//var collabo = getId('page:form');
var collabo = getId('{!$Component.page.form.block.sectionK.blocksectionK}');

</script>

                                <div id="tabSecurity" style="overflow: auto; height: 730px;display:none;" class="ui-tabs-panel ui-widget-content ui-corner-bottom">
                                    <!-- 基本設定タブに移動
                                    <apex:pageBlockSection title="{!$Label.solxyzcso001__label_wf_00442}" columns="1" id="sectionK" collapsible="false">
                                        <apex:pageblocksectionItem >
                                            <apex:outputtext value="" />
                                            <apex:outputPanel >
                                                <table>
                                                    <apex:repeat value="{!activeOptions}" var="actList">
                                                        <tr>
                                                            <td>
                                                                <apex:outputText value="{!actList.label}"/>
                                                            </td>
                                                        </tr>
                                                    </apex:repeat>
                                                </table>
                                            </apex:outputPanel>
                                        </apex:pageblocksectionItem>
                                    </apex:pageBlockSection>
                                     -->

                                    <!-- セキュリティ変更 -->
                                    <apex:pageBlockSection showHeader="false" id="securitySection" title="{!$Label.solxyzcso001__label_wf_30011}" columns="1" collapsible="false">
                                        <apex:pageBlockSectionItem id="security1">
                                            <apex:outputLabel value="{!$Label.solxyzcso001__label_wf_30012}" />
                                            <apex:outputText value="{!dispSecurityLevel}" />
                                        </apex:pageBlockSectionItem>
                                        <apex:pageBlockSectionItem id="security2">
                                            <apex:outputLabel value="{!$Label.solxyzcso001__label_wf_30013}" />
                                            <apex:outputText value="{!dispEncryptionLevel}" />
                                        </apex:pageBlockSectionItem>
                                        <apex:pageblockSectionItem >
                                            <apex:outputlabel value="{!$Label.solxyzcso001__label_wf_30014}" />
                                            <apex:outputpanel >
                                                <script type="text/javascript">
                                                </script>
                                                <table>
                                                    <tr>
                                                        <td>{!$Label.solxyzcso001__label_wf_30015}</td>
                                                        <td>{!dispSecurityPassword}</td>
                                                    </tr>
                                                    <tr>
                                                        <td>{!$Label.solxyzcso001__label_wf_30016}</td>
                                                        <td>{!dispSecurityMasterPassword}</td>
                                                    </tr>
                                                </table>
                                            </apex:outputpanel>
                                        </apex:pageblockSectionItem>
                                        <apex:pageBlockSectionItem id="security10">
                                            <apex:outputLabel value="{!$Label.solxyzcso001__label_wf_30017}" />
                                            <apex:outputText value="{!dispSecurityPrint}" />
                                        </apex:pageBlockSectionItem>
                                        <apex:pageBlockSectionItem id="security11">
                                            <apex:outputLabel value="{!$Label.solxyzcso001__label_wf_30018}" />
                                            <apex:outputText value="{!dispSecurityEdit}" />
                                        </apex:pageBlockSectionItem>
                                        <apex:pageBlockSectionItem id="security12">
                                            <apex:outputLabel value="{!$Label.solxyzcso001__label_wf_30019}" />
                                            <apex:outputText value="{!dispSecurityAssembly}" />
                                        </apex:pageBlockSectionItem>
                                        <apex:pageBlockSectionItem id="security13">
                                            <apex:outputLabel value="{!$Label.solxyzcso001__label_wf_30020}" />
                                            <apex:outputText value="{!dispSecurityCopy}" />
                                        </apex:pageBlockSectionItem>
                                        <apex:pageBlockSectionItem id="security14">
                                            <apex:outputLabel value="{!$Label.solxyzcso001__label_wf_30021}" />
                                            <apex:outputText value="{!dispSecurityAccessibility}" />
                                        </apex:pageBlockSectionItem>
                                        <apex:pageBlockSectionItem id="security15">
                                            <apex:outputLabel value="{!$Label.solxyzcso001__label_wf_30022}" />
                                            <apex:outputText value="{!$Label.solxyzcso001__label_wf_30027}" />
                                        </apex:pageBlockSectionItem>
                                        <apex:pageBlockSectionItem id="security16">
                                            <apex:outputLabel value="{!$Label.solxyzcso001__label_wf_30023}" />
                                            <apex:outputText value="{!dispSecurityNote}" />
                                        </apex:pageBlockSectionItem>
                                        <apex:pageBlockSectionItem id="security17">
                                            <apex:outputLabel value="{!$Label.solxyzcso001__label_wf_30024}" />
                                            <apex:outputText value="{!dispSecurityFt}" />
                                        </apex:pageBlockSectionItem>
                                    </apex:pageBlockSection>


                                </div>
<!-- セキュリティタブ END -->
<!-- 履歴タブ START -->
                                <div id="tabHistory" style="overflow: auto; height: 730px;" class="ui-tabs-panel ui-widget-content ui-corner-bottom">
                                    <apex:pageBlockSection showHeader="false" title="{!$Label.solxyzcso001__label_10039}" columns="1" collapsible="false">
                                        <apex:pageBlockTable value="{!rhistory}" var="h">
                                            <apex:column headerValue="{!$Label.solxyzcso001__label_wf_00012}"  value="{!h.createddate}"/>
                                            <apex:column headerValue="{!$Label.solxyzcso001__label_wf_00011}" value="{!h.CreatedBy.Name}"/>
                                            <!--
                                            <apex:column headerValue="{!$Label.label_wf_00126}">
                                                <apex:outputLink value="/{!h.id}" target="_blank">
                                                    {!$Label.label_wf_00124}<apex:outputText value="{!h.Name}"/>
                                                </apex:outputLink>
                                            </apex:column>
                                             -->
                                            <apex:column headerValue="{!$Label.solxyzcso001__label_wf_00053}"  value="{!h.SOLXYZCSO001__Modify__c}" />
                                        </apex:pageBlockTable>
                                    </apex:pageBlockSection>
                                </div>
<!-- 履歴タブ END -->
                            </div>



                        </apex:pageBlock>
<!-- apex:pageBlock END -->
                    </apex:form>
<!-- apex:form END -->
                </div>
            </div>

        </td>
    </tr>
</tbody>
<!-- table #MainDiv -->
</table>

<div class="copyright">{!$Label.field_CSO_copyright}</div>

</body>
</html>
</apex:page>